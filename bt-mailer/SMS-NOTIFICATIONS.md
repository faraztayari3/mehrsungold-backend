# سیستم اعلان‌های پیامکی

این سیستم به‌طور خودکار در زمان وقوع تغییرات در دیتابیس، پیامک‌های اطلاع‌رسانی را برای کاربران ارسال می‌کند.

## شرایط ارسال پیامک

نکته:
- در همه پیامک‌ها ابتدای متن با فرمت `${user_fullname} عزیز` است. اگر نام/نام‌خانوادگی موجود نباشد، مقدار پیش‌فرض `نام کاربر` استفاده می‌شود.
- هرجا تاریخ/ساعت نمایش داده شود، تاریخ **شمسی (جلالی)** است.

### 1. خوش‌آمدگویی بعد از تأیید OTP
- **زمان ارسال:** هنگام تأیید موفق کد OTP (پاک شدن `verificationCode`)
- **شرط:** `operationType === 'update'` و `verificationCode` به null/undefined/'' تغییر کند
- **متن پیامک:**
```
{user_fullname} عزیز

پیش ثبت‌نام شما با موفقیت انجام شد.
جهت تکمیل ثبت نام مراحل احراز هویت را کامل نمایید.
پشتیبانی:07644421176
```

**نکته:** این پیامک همزمان با پیامک OTP ارسال نمی‌شود، بلکه پس از تأیید موفق OTP توسط کاربر ارسال می‌گردد.

### 2. تأیید موفق احراز هویت
- **زمان ارسال:** تغییر `verificationStatus` به `FirstLevelVerified` یا `SecondLevelVerified`
- **شرط:** update در collection `users`
- **متن پیامک:**
```
{user_fullname} عزیز
احراز هویت شما در مهرسان گلد با موفقیت تأیید شد.
اکنون می‌توانید از تمام خدمات سامانه استفاده کنید.
```

### 3. رد شدن احراز هویت
- **زمان ارسال:** تغییر `verificationStatus` به `FirstLevelRejected` یا `SecondLevelRejected`
- **شرط:** update در collection `users`
- **متن پیامک:**
```
{user_fullname} عزیز
احراز هویت شما در مهرسان گلد تأیید نشد.
دلیل: {reject_reason}
لطفاً اطلاعات خود را اصلاح و مجدداً ارسال کنید.
```

### 4. یادآوری تکمیل احراز هویت
- **زمان ارسال:** باید به‌صورت manual فراخوانی شود (در حال حاضر پیاده‌سازی نشده)
- **متن پیامک:**
```
{user_fullname} عزیز
احراز هویت شما در مهرسان گلد هنوز تکمیل نشده است.
برای فعال‌سازی کامل حساب و دریافت هدیه 5میلی طلا ، لطفاً مراحل احراز هویت را انجام دهید.
```

### 5. تغییر رمز عبور
- **زمان ارسال:** تغییر فیلد `password`
- **شرط:** update در collection `users`
- **متن پیامک:**
```
{user_fullname} عزیز
رمز عبور حساب شما در مهرسان گلد با موفقیت تغییر کرد.
```

### 6. ثبت درخواست واریز
- **زمان ارسال:** ایجاد سند جدید با type شامل `deposit`
- **شرط:** `operationType === 'insert'` در collection `balancetransactions`
- **متن پیامک:**
```
درخواست واریز شما در مهرسان گلد ثبت شد.
مبلغ: {amount_toman} تومان
شماره پیگیری: {deposit_id}
پس از بررسی اطلاع‌رسانی خواهد شد.
```

### 7. تأیید واریز
- **زمان ارسال:** تغییر `status` به `Accepted` برای تراکنش واریز
- **شرط:** update در collection `balancetransactions`
- **متن پیامک:**
```
مهرسان گلد
واریز شما در مهرسان گلد با موفقیت تأیید شد.
مبلغ: {amount_toman} تومان
موجودی کیف پول: {wallet_balance_toman} تومان
تاریخ: {jalali_date}
ساعت: {time}
```

### 8. رد شدن واریز
- **زمان ارسال:** تغییر `status` به `Rejected` برای تراکنش واریز
- **شرط:** update در collection `balancetransactions`
- **متن پیامک:**
```
درخواست واریز شما در مهرسان گلد تأیید نشد.
مبلغ: {amount_toman} تومان
دلیل: {reject_reason}
```

### 9. ثبت درخواست برداشت
- **زمان ارسال:** ایجاد سند جدید با type شامل `withdraw`
- **شرط:** `operationType === 'insert'` در collection `balancetransactions`
- **متن پیامک:**
```
درخواست برداشت شما در مهرسان گلد ثبت شد.
مبلغ: {amount_toman} تومان
شماره پیگیری: {withdraw_id}
در حال بررسی می‌باشد.
```

### 10. پرداخت موفق برداشت
- **زمان ارسال:** تغییر `status` به `Accepted` برای تراکنش برداشت
- **شرط:** update در collection `balancetransactions`
- **متن پیامک:**
```
برداشت شما از مهرسان گلد با موفقیت انجام شد.
مبلغ: {amount_toman} تومان
شماره پیگیری: {tracking_code}
```

### 11. خرید موفق
- **زمان ارسال:** تغییر `status` به `Accepted` برای تراکنش با type = `buy`
- **شرط:** update در collection `transactions`
- **متن پیامک:**
```
مهرسان گلد

خرید {amount} گرم {tradeable} به مبلغ {total} با موفقیت انجام شد.
مانده موجودی طلا: {gold_balance}
مانده موجودی نقره: {silver_balance}
مانده موجودی تومان: {toman_balance}
```

### 12. فروش موفق
- **زمان ارسال:** تغییر `status` به `Accepted` برای تراکنش با type = `sell`
- **شرط:** update در collection `transactions`
- **متن پیامک:**
```
مهرسان گلد

فروش {amount} گرم {tradeable} به مبلغ {total} با موفقیت انجام شد.
مانده موجودی طلا: {gold_balance}
مانده موجودی نقره: {silver_balance}
مانده موجودی تومان: {toman_balance}
```

## شماره تست

برای اینکه هنگام تست یک «کپی» از پیامک‌های کاربر به یک شماره ثابت هم ارسال شود، از متغیر محیطی زیر استفاده کنید:

```env
SMS_CC_TEST_NUMBER=0912xxxxxxx
```

نکته مهم: این قابلیت **به‌صورت پیش‌فرض غیرفعال است** و دیگر هیچ شماره‌ی تستی به‌صورت hard-code داخل کد وجود ندارد.

## ایمنی ارسال پیامک (خیلی مهم)

برای جلوگیری از ارسال ناخواسته/انبوه پیامک، سیستم دارای حالت‌های ایمن زیر است:

```env
# off | dry-run | live
SMS_MODE=off

# برای ارسال واقعی، علاوه بر SMS_MODE=live باید این هم true باشد
SMS_ALLOW_LIVE=false

# پیش‌فرض: فقط در NODE_ENV=production اجازه ارسال live داریم
NODE_ENV=production

# اگر می‌خواهید در محیط غیرپروداکشن هم live ارسال شود (پیشنهاد نمی‌شود)
SMS_ALLOW_NON_PROD=false

# اگر SMS_ALLOWLIST تنظیم شود، فقط به این شماره‌ها SMS ارسال می‌شود (برای تست روی دیتای واقعی مفید است)
SMS_ALLOWLIST=

# محدودیت تعداد ارسال در دقیقه (0 یعنی بدون محدودیت)
SMS_MAX_PER_MINUTE=0

# در حالت --test هرگز SMS واقعی ارسال نمی‌شود مگر این مقدار true باشد
SMS_TEST_CAN_SEND=false
```

## اجرای سیستم

```bash
cd bt-mailer
node watch-balance-transactions.js
```

## متغیرهای محیطی

فایل `.env` باید شامل موارد زیر باشد:

```env
MONGODB_URI=mongodb://...
MONGODB_DB=database_name
MONGODB_COLLECTION=balancetransactions

KAVENEGAR_API_KEY=your_api_key
KAVENEGAR_SENDER=20006000646
KAVENEGAR_RECEPTOR=09120315101
```

## نکات مهم

1. تمام پیامک‌ها به‌صورت خودکار از طریق MongoDB Change Streams ارسال می‌شوند
2. سیستم از Resume Tokens برای جلوگیری از از دست رفتن رویدادها استفاده می‌کند
3. برای هر collection یک فایل JSON جداگانه برای ذخیره resume token وجود دارد
4. در صورت خطا، سیستم به‌صورت خودکار مجدداً راه‌اندازی می‌شود

## توابع کلیدی

- `buildSmsTextForUser()`: تولید متن پیامک بر اساس نوع رویداد
- `sendSmsToUser()`: ارسال پیامک به کاربر و شماره تست
- `sendSms()`: ارسال پیامک به مدیران (شماره‌های KAVENEGAR_RECEPTOR)
- `sendEmail()`: ارسال ایمیل به مدیران
