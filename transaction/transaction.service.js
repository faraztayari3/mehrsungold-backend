'use strict';const a220_0x5de1ed=a220_0x51b6;(function(_0x47f443,_0x2bf5c4){const _0x16c76d=a220_0x51b6,_0x56c92e=_0x47f443();while(!![]){try{const _0x349eca=-parseInt(_0x16c76d(0x2b0))/0x1*(-parseInt(_0x16c76d(0x2c6))/0x2)+parseInt(_0x16c76d(0x271))/0x3+-parseInt(_0x16c76d(0x1ac))/0x4*(parseInt(_0x16c76d(0x200))/0x5)+-parseInt(_0x16c76d(0x284))/0x6+parseInt(_0x16c76d(0x263))/0x7*(-parseInt(_0x16c76d(0x2b1))/0x8)+parseInt(_0x16c76d(0x230))/0x9+parseInt(_0x16c76d(0x1cb))/0xa;if(_0x349eca===_0x2bf5c4)break;else _0x56c92e['push'](_0x56c92e['shift']());}catch(_0x30c90e){_0x56c92e['push'](_0x56c92e['shift']());}}}(a220_0x1cee,0xc3116));var __createBinding=this&&this[a220_0x5de1ed(0x1e2)]||(Object[a220_0x5de1ed(0x28c)]?function(_0x61be1,_0x50c9f9,_0x24b2a2,_0x575342){const _0x36646a=a220_0x5de1ed;if(_0x575342===undefined)_0x575342=_0x24b2a2;var _0x507e64=Object[_0x36646a(0x253)](_0x50c9f9,_0x24b2a2);(!_0x507e64||(_0x36646a(0x1a9)in _0x507e64?!_0x50c9f9['__esModule']:_0x507e64[_0x36646a(0x1e7)]||_0x507e64[_0x36646a(0x1ae)]))&&(_0x507e64={'enumerable':!![],'get':function(){return _0x50c9f9[_0x24b2a2];}}),Object[_0x36646a(0x1cc)](_0x61be1,_0x575342,_0x507e64);}:function(_0x9de0ca,_0x288135,_0x7bc7d0,_0x3b0ea2){if(_0x3b0ea2===undefined)_0x3b0ea2=_0x7bc7d0;_0x9de0ca[_0x3b0ea2]=_0x288135[_0x7bc7d0];}),__setModuleDefault=this&&this[a220_0x5de1ed(0x28b)]||(Object[a220_0x5de1ed(0x28c)]?function(_0x5a25c1,_0x3473db){const _0xc03c06=a220_0x5de1ed;Object[_0xc03c06(0x1cc)](_0x5a25c1,_0xc03c06(0x223),{'enumerable':!![],'value':_0x3473db});}:function(_0x4a86cf,_0x414c38){_0x4a86cf['default']=_0x414c38;}),__decorate=this&&this[a220_0x5de1ed(0x201)]||function(_0xa141b6,_0x27565e,_0xb2fd95,_0xb25192){const _0x3ecef0=a220_0x5de1ed;var _0x397dda=arguments[_0x3ecef0(0x1a4)],_0x810faa=_0x397dda<0x3?_0x27565e:_0xb25192===null?_0xb25192=Object[_0x3ecef0(0x253)](_0x27565e,_0xb2fd95):_0xb25192,_0x707b95;if(typeof Reflect==='object'&&typeof Reflect[_0x3ecef0(0x26f)]===_0x3ecef0(0x277))_0x810faa=Reflect[_0x3ecef0(0x26f)](_0xa141b6,_0x27565e,_0xb2fd95,_0xb25192);else{for(var _0x2a7a45=_0xa141b6['length']-0x1;_0x2a7a45>=0x0;_0x2a7a45--)if(_0x707b95=_0xa141b6[_0x2a7a45])_0x810faa=(_0x397dda<0x3?_0x707b95(_0x810faa):_0x397dda>0x3?_0x707b95(_0x27565e,_0xb2fd95,_0x810faa):_0x707b95(_0x27565e,_0xb2fd95))||_0x810faa;}return _0x397dda>0x3&&_0x810faa&&Object[_0x3ecef0(0x1cc)](_0x27565e,_0xb2fd95,_0x810faa),_0x810faa;},__importStar=this&&this[a220_0x5de1ed(0x25a)]||(function(){var _0x3205d3=function(_0x41ac10){return _0x3205d3=Object['getOwnPropertyNames']||function(_0x4b603c){const _0x1fff44=a220_0x51b6;var _0x29d53b=[];for(var _0x59c315 in _0x4b603c)if(Object[_0x1fff44(0x1a5)][_0x1fff44(0x1b9)]['call'](_0x4b603c,_0x59c315))_0x29d53b[_0x29d53b[_0x1fff44(0x1a4)]]=_0x59c315;return _0x29d53b;},_0x3205d3(_0x41ac10);};return function(_0x3c48aa){const _0x1f9cbf=a220_0x51b6;if(_0x3c48aa&&_0x3c48aa['__esModule'])return _0x3c48aa;var _0x33577d={};if(_0x3c48aa!=null){for(var _0x44b9b4=_0x3205d3(_0x3c48aa),_0x118727=0x0;_0x118727<_0x44b9b4[_0x1f9cbf(0x1a4)];_0x118727++)if(_0x44b9b4[_0x118727]!==_0x1f9cbf(0x223))__createBinding(_0x33577d,_0x3c48aa,_0x44b9b4[_0x118727]);}return __setModuleDefault(_0x33577d,_0x3c48aa),_0x33577d;};}()),__metadata=this&&this['__metadata']||function(_0x4b1fd2,_0x33a28c){const _0x30dbb0=a220_0x5de1ed;if(typeof Reflect===_0x30dbb0(0x240)&&typeof Reflect['metadata']===_0x30dbb0(0x277))return Reflect[_0x30dbb0(0x23c)](_0x4b1fd2,_0x33a28c);},__param=this&&this[a220_0x5de1ed(0x1e4)]||function(_0x4f14b1,_0x483232){return function(_0x2cf65d,_0xfbabc7){_0x483232(_0x2cf65d,_0xfbabc7,_0x4f14b1);};},__importDefault=this&&this[a220_0x5de1ed(0x1c1)]||function(_0x4ee101){const _0x13f863=a220_0x5de1ed;return _0x4ee101&&_0x4ee101[_0x13f863(0x2a0)]?_0x4ee101:{'default':_0x4ee101};},TransactionService_1;Object[a220_0x5de1ed(0x1cc)](exports,a220_0x5de1ed(0x2a0),{'value':!![]}),exports[a220_0x5de1ed(0x25c)]=void 0x0;const common_1=require('@nestjs/common'),config_1=require(a220_0x5de1ed(0x2c1)),mongoose_1=require(a220_0x5de1ed(0x2ac)),schedule_1=require(a220_0x5de1ed(0x1f6)),crypto_1=require('crypto'),moment_1=__importDefault(require(a220_0x5de1ed(0x27a))),mongoose_2=require(a220_0x5de1ed(0x214)),nestjs_i18n_1=require(a220_0x5de1ed(0x27f)),amount_type_enum_1=require(a220_0x5de1ed(0x1d0)),status_enum_1=require(a220_0x5de1ed(0x298)),utils_1=require(a220_0x5de1ed(0x2c0)),external_apis_service_1=require(a220_0x5de1ed(0x264)),level_service_1=require(a220_0x5de1ed(0x2a1)),settings_service_1=require('../settings/settings.service'),tradeable_service_1=require('../tradeable/tradeable.service'),balance_log_schema_1=require(a220_0x5de1ed(0x291)),user_schema_1=require(a220_0x5de1ed(0x280)),user_service_1=require('../user/user.service'),XLSX=__importStar(require(a220_0x5de1ed(0x235))),trade_limit_schema_1=require('./schema/trade-limit.schema'),transaction_report_schema_1=require('./schema/transaction-report.schema'),transaction_schema_1=require(a220_0x5de1ed(0x21b)),user_fee_schema_1=require('./schema/user-fee.schema');let TransactionService=TransactionService_1=class TransactionService{constructor(_0xc221a8,_0x4b25ca,_0x1ad341,_0x447234,_0x54c212,_0xdbfae3,_0x1e8aca,_0x1dcecb,_0x5c716a,_0x5bb797,_0x181743,_0x4bb664){const _0x179ae6=a220_0x5de1ed;this['transactionModel']=_0xc221a8,this[_0x179ae6(0x1b4)]=_0x4b25ca,this[_0x179ae6(0x1ec)]=_0x1ad341,this[_0x179ae6(0x1a1)]=_0x447234,this[_0x179ae6(0x286)]=_0x54c212,this[_0x179ae6(0x296)]=_0xdbfae3,this[_0x179ae6(0x1e5)]=_0x1e8aca,this[_0x179ae6(0x23f)]=_0x1dcecb,this['tradeableService']=_0x5c716a,this['configService']=_0x5bb797,this[_0x179ae6(0x22e)]=_0x181743,this[_0x179ae6(0x299)]=_0x4bb664,this[_0x179ae6(0x24d)]=new common_1[(_0x179ae6(0x2a9))](TransactionService_1[_0x179ae6(0x205)]);}async[a220_0x5de1ed(0x295)](){const _0x171a05=a220_0x5de1ed;this[_0x171a05(0x1d8)](),this[_0x171a05(0x1e6)]();}async[a220_0x5de1ed(0x1e6)](){const _0x46e279=a220_0x5de1ed,_0x3e0ca2=new Date(),_0x47c081=await this['transactionModel'][_0x46e279(0x209)]({'type':transaction_schema_1[_0x46e279(0x23e)][_0x46e279(0x1d6)],'status':status_enum_1[_0x46e279(0x26a)]['Pending'],'paymentDeadline':{'$lte':_0x3e0ca2}});let _0x366b1d;try{_0x366b1d=await this[_0x46e279(0x299)][_0x46e279(0x1ee)]();for(const _0x50527a of _0x47c081){_0x366b1d['startTransaction']();const {_id:_0x772415,user:_0x4c62d2,tradeable:_0x50733b,amount:_0x26bdda}=_0x50527a;try{_0x50527a[_0x46e279(0x289)]=transaction_schema_1[_0x46e279(0x2c8)][_0x46e279(0x2c7)],await _0x50527a[_0x46e279(0x1dd)]({'session':_0x366b1d}),await this['tradeableService'][_0x46e279(0x236)](String(_0x4c62d2),String(_0x50733b),_0x26bdda,!![],_0x366b1d),await this[_0x46e279(0x29f)][_0x46e279(0x1c8)](String(_0x50733b),_0x26bdda,_0x366b1d),await _0x366b1d[_0x46e279(0x19d)]();}catch(_0x421a4a){if(_0x366b1d===null||_0x366b1d===void 0x0?void 0x0:_0x366b1d[_0x46e279(0x288)]())await _0x366b1d[_0x46e279(0x1e0)]();this[_0x46e279(0x24d)]['error']('Error\x20with\x20confirming\x20payLater\x20transaction\x20'+_0x772415+':\x20'+_0x421a4a);}}}catch(_0x768585){this[_0x46e279(0x24d)][_0x46e279(0x283)](_0x46e279(0x266)+_0x768585);}finally{if(_0x366b1d)await _0x366b1d[_0x46e279(0x2ab)]();}this['logger']['log'](_0x46e279(0x2b2));}async[a220_0x5de1ed(0x1d8)](){const _0x31d9a7=a220_0x5de1ed,{scalpingPreventionPeriodInHours:_0x359f3e,manualTransactionConfirmation:_0x2f46df}=await this[_0x31d9a7(0x296)][_0x31d9a7(0x21a)]();if(_0x2f46df)return;if(_0x359f3e==undefined){this[_0x31d9a7(0x24d)][_0x31d9a7(0x237)](_0x31d9a7(0x1da));return;}const _0xdb1767=_0x359f3e,_0xa00a2=new Date(),_0x393c9c=await this[_0x31d9a7(0x204)][_0x31d9a7(0x262)]([{'$match':{'status':status_enum_1[_0x31d9a7(0x26a)][_0x31d9a7(0x285)],'type':transaction_schema_1[_0x31d9a7(0x23e)][_0x31d9a7(0x2bd)]}},{'$set':{'shouldbeConfirmedDate':{'$dateAdd':{'startDate':_0x31d9a7(0x202),'unit':_0x31d9a7(0x273),'amount':_0xdb1767}}}},{'$match':{'shouldbeConfirmedDate':{'$lte':_0xa00a2}}},{'$lookup':{'from':_0x31d9a7(0x221),'localField':_0x31d9a7(0x26c),'foreignField':'_id','as':_0x31d9a7(0x26c)}},{'$set':{'user':{'$first':_0x31d9a7(0x1e3)}}}]);if(!_0x393c9c[_0x31d9a7(0x1a4)])return;let _0x3eb193;try{_0x3eb193=await this['connection'][_0x31d9a7(0x1ee)]();for(const {_id:_0x58a201,user:_0x2dae2e,tradeable:_0x6b7f16,amount:_0x5be2ee,wage:_0x4b610e}of _0x393c9c){const {referrerRewardPercent:_0x1faf4b}=await this[_0x31d9a7(0x29f)]['findOrThrow'](String(_0x6b7f16));_0x3eb193[_0x31d9a7(0x232)]();try{await this[_0x31d9a7(0x204)][_0x31d9a7(0x2c5)](_0x58a201,{'status':status_enum_1[_0x31d9a7(0x26a)]['Accepted']},{'session':_0x3eb193}),await this['tradeableService'][_0x31d9a7(0x25f)](String(_0x2dae2e[_0x31d9a7(0x287)]),String(_0x6b7f16),_0x5be2ee,![],_0x3eb193),await this[_0x31d9a7(0x29f)][_0x31d9a7(0x256)](String(_0x6b7f16),_0x5be2ee,_0x3eb193),await this['payAffiliateReward'](_0x2dae2e[_0x31d9a7(0x245)],_0x1faf4b,_0x4b610e,_0x3eb193),await _0x3eb193['commitTransaction']();}catch(_0x11ede8){if(_0x3eb193===null||_0x3eb193===void 0x0?void 0x0:_0x3eb193[_0x31d9a7(0x288)]())await _0x3eb193[_0x31d9a7(0x1e0)]();this[_0x31d9a7(0x24d)][_0x31d9a7(0x283)](_0x31d9a7(0x1f3)+_0x58a201+':\x20'+_0x11ede8);}}}catch(_0x1662e5){this[_0x31d9a7(0x24d)][_0x31d9a7(0x283)]('Error\x20in\x20confirmPendingBuyTransactions:\x20'+_0x1662e5);throw new common_1[(_0x31d9a7(0x279))]();}finally{if(_0x3eb193)await _0x3eb193[_0x31d9a7(0x2ab)]();}this['logger'][_0x31d9a7(0x2b3)]('Pending\x20buy\x20transactions\x20(due\x20to\x20the\x20scalping\x20prevention\x20mechanism)\x20are\x20confirmed.');}async[a220_0x5de1ed(0x1db)](){const _0x102e00=a220_0x5de1ed,_0x33eb0d=await this[_0x102e00(0x29f)]['publicFindAll'](),_0x3c349b={};for(const _0x3a1cf9 of _0x33eb0d['data']){_0x3c349b[_0x3a1cf9[_0x102e00(0x287)]]=_0x3a1cf9;}const _0x25a1b4=await this[_0x102e00(0x204)]['find']({'status':transaction_schema_1[_0x102e00(0x2c8)][_0x102e00(0x1ab)]}),{manualTransactionConfirmation:_0x244749,scalpingPreventionPeriodInHours:_0x1493de}=await this[_0x102e00(0x296)][_0x102e00(0x21a)]();for(const _0x5e17e0 of _0x25a1b4){const {type:_0x234045,tradeable:_0x5c811f,amount:_0x350f0a,tradeablePrice:_0x23e537,total:_0x164742,wage:_0x545d21}=_0x5e17e0,_0x32519f=_0x3c349b[String(_0x5c811f)];if(_0x234045===transaction_schema_1[_0x102e00(0x23e)][_0x102e00(0x2bd)]&&_0x23e537>=_0x32519f[_0x102e00(0x248)]||_0x234045===transaction_schema_1[_0x102e00(0x23e)]['Sell']&&_0x23e537<=_0x32519f[_0x102e00(0x248)]){await _0x5e17e0[_0x102e00(0x1c3)](_0x102e00(0x26c),_0x102e00(0x22c));const _0x27df3d=_0x5e17e0[_0x102e00(0x26c)];_0x5e17e0['status']=transaction_schema_1[_0x102e00(0x2c8)][_0x102e00(0x2af)],await this[_0x102e00(0x1b1)](_0x27df3d[_0x102e00(0x287)],_0x32519f['_id'],_0x350f0a);const _0x5ae601=await this['levelService'][_0x102e00(0x2be)](String(_0x27df3d[_0x102e00(0x297)])),_0x2539d0=new Date(),_0x390444=(0x0,moment_1[_0x102e00(0x223)])(_0x2539d0)[_0x102e00(0x275)](_0x102e00(0x208))[_0x102e00(0x257)]();await this[_0x102e00(0x292)](_0x27df3d['_id'],_0x5ae601,_0x164742,_0x390444,_0x2539d0,_0x234045);let _0x5cf832;try{_0x5cf832=await this[_0x102e00(0x299)]['startSession'](),_0x5cf832[_0x102e00(0x232)]();if(_0x234045===transaction_schema_1[_0x102e00(0x23e)]['Buy']){if(_0x244749||_0x1493de)_0x5e17e0[_0x102e00(0x289)]=transaction_schema_1[_0x102e00(0x2c8)][_0x102e00(0x285)];else{await this[_0x102e00(0x29f)][_0x102e00(0x25f)](_0x27df3d[_0x102e00(0x287)],_0x32519f[_0x102e00(0x287)],_0x350f0a,![],_0x5cf832);try{await this['tradeableService'][_0x102e00(0x256)](_0x32519f[_0x102e00(0x287)],_0x350f0a,_0x5cf832);}catch(_0x2b7d2a){this['logger'][_0x102e00(0x283)]('Error\x20in\x20updateFixedPriceTransactions.decTradeableStock:\x20'+_0x2b7d2a),_0x5e17e0[_0x102e00(0x289)]=transaction_schema_1[_0x102e00(0x2c8)][_0x102e00(0x2c7)],await this[_0x102e00(0x286)][_0x102e00(0x218)](_0x27df3d[_0x102e00(0x287)],_0x164742,balance_log_schema_1['BalanceLogAction'][_0x102e00(0x21e)],_0x5cf832);}if(_0x5e17e0['status']===transaction_schema_1[_0x102e00(0x2c8)]['Accepted'])await this[_0x102e00(0x1dc)](_0x27df3d[_0x102e00(0x245)],_0x32519f[_0x102e00(0x2ba)],_0x545d21,_0x5cf832);}}else _0x244749?_0x5e17e0['status']=transaction_schema_1[_0x102e00(0x2c8)][_0x102e00(0x285)]:(await this['userService'][_0x102e00(0x218)](_0x27df3d['_id'],_0x164742,balance_log_schema_1[_0x102e00(0x2c3)][_0x102e00(0x220)],_0x5cf832),await this['tradeableService'][_0x102e00(0x1c8)](_0x32519f[_0x102e00(0x287)],_0x350f0a,_0x5cf832),await this[_0x102e00(0x1dc)](_0x27df3d['referrer'],_0x32519f[_0x102e00(0x2ba)],_0x545d21,_0x5cf832));await _0x5e17e0[_0x102e00(0x1dd)]({'session':_0x5cf832}),await _0x5cf832[_0x102e00(0x19d)](),void this[_0x102e00(0x23f)]['updateUsersLevelBasedOnTradeAmount'](_0x27df3d[_0x102e00(0x287)])[_0x102e00(0x260)](_0x1284b5=>{const _0x5cb63b=_0x102e00;this[_0x5cb63b(0x24d)][_0x5cb63b(0x283)](_0x5cb63b(0x1b3)+_0x1284b5);});}catch(_0x534e67){if(_0x5cf832===null||_0x5cf832===void 0x0?void 0x0:_0x5cf832[_0x102e00(0x288)]())await _0x5cf832[_0x102e00(0x1e0)]();this[_0x102e00(0x24d)][_0x102e00(0x283)](_0x102e00(0x21c)+_0x534e67);}finally{if(_0x5cf832)await _0x5cf832[_0x102e00(0x2ab)]();}}}}async['findOrThrow'](_0x4b743f){const _0x5c0f0c=a220_0x5de1ed,_0x43e9fb=await this['transactionModel']['findById'](_0x4b743f)['lean']();if(!_0x43e9fb)throw new common_1[(_0x5c0f0c(0x274))](this[_0x5c0f0c(0x1e5)]['t'](_0x5c0f0c(0x217)));return _0x43e9fb;}async['getTotalTradedTradeableAmount'](_0x44501b,_0x2565f5,_0x2015b0,_0x143f58,_0x30732a=undefined){const _0x13969c=a220_0x5de1ed,_0x2fac35={'user':new mongoose_2[(_0x13969c(0x1a6))][(_0x13969c(0x1b8))](_0x44501b),'status':status_enum_1[_0x13969c(0x26a)][_0x13969c(0x2af)],'createdAt':{'$gte':_0x2015b0,'$lte':_0x143f58},'tradeable':new mongoose_2[(_0x13969c(0x1a6))][(_0x13969c(0x1b8))](_0x2565f5)};if(_0x30732a)_0x2fac35['type']=_0x30732a;const _0x4b2da0=await this[_0x13969c(0x204)][_0x13969c(0x262)]([{'$match':_0x2fac35},{'$group':{'_id':'$user','totalAmount':{'$sum':_0x13969c(0x2c4)}}}]);let _0x582f9d=0x0;if(_0x4b2da0[_0x13969c(0x1a4)])_0x582f9d=_0x4b2da0[0x0][_0x13969c(0x1ff)];return _0x582f9d;}async[a220_0x5de1ed(0x1c4)](_0x4d54ba,_0x5eb3e6,_0x5654c6,_0x4089f2=undefined){const _0xe12ff5=a220_0x5de1ed;var _0x3e526c;const _0x3730b6={'user':new mongoose_2['Types'][(_0xe12ff5(0x1b8))](_0x4d54ba),'status':status_enum_1['Status'][_0xe12ff5(0x2af)],'createdAt':{'$gte':_0x5eb3e6,'$lte':_0x5654c6}};if(_0x4089f2)_0x3730b6['type']=_0x4089f2;const _0x2af861=await this[_0xe12ff5(0x204)][_0xe12ff5(0x262)]([{'$match':_0x3730b6},{'$group':{'_id':_0xe12ff5(0x1e3),'total':{'$sum':_0xe12ff5(0x276)}}}]);return((_0x3e526c=_0x2af861[0x0])===null||_0x3e526c===void 0x0?void 0x0:_0x3e526c[_0xe12ff5(0x231)])||0x0;}async[a220_0x5de1ed(0x292)](_0x40797b,_0x17419e,_0x5a602e,_0x245eb7,_0x204903,_0x29d128){const _0x506430=a220_0x5de1ed,{dailyMinBuyAmount:_0x4e9cc7,dailyMaxBuyAmount:_0x1909b5,dailyMaxSellAmount:_0x3a4ef7,dailyMinSellAmount:_0x17a4ff}=_0x17419e,_0x368102=await this['getTotalTradesPrice'](_0x40797b,_0x245eb7,_0x204903,_0x29d128);let _0x5b3985,_0x27761d;_0x29d128===transaction_schema_1['TransactionType']['Buy']?(_0x5b3985=_0x4e9cc7,_0x27761d=_0x1909b5):(_0x5b3985=_0x17a4ff,_0x27761d=_0x3a4ef7);if(_0x368102+_0x5a602e<_0x5b3985)throw new common_1['BadRequestException'](this[_0x506430(0x1e5)]['t'](_0x506430(0x1f9),{'args':{'value':_0x5b3985}}));if(_0x368102+_0x5a602e>_0x27761d)throw new common_1['BadRequestException'](this['i18n']['t'](_0x506430(0x2a5),{'args':{'value':_0x27761d}}));}async[a220_0x5de1ed(0x1b1)](_0x4d73e7,_0x4ed4f5,_0x4d28ed){const _0x19fc11=a220_0x5de1ed,_0x47a2ad=await this['getTradeLimits'](new Date(),_0x4ed4f5,_0x4d73e7);for(const _0x8799ef of _0x47a2ad){const {startTime:_0xff503d,endTime:_0x3b4306,limit:_0x404802}=_0x8799ef,_0x428a44=await this['getTotalTradedTradeableAmount'](_0x4d73e7,_0x4ed4f5,_0xff503d,_0x3b4306);if(_0x428a44+_0x4d28ed>_0x404802)throw new common_1[(_0x19fc11(0x1a8))](this[_0x19fc11(0x1e5)]['t'](_0x19fc11(0x1c5)));}}[a220_0x5de1ed(0x27d)](_0x29b436,_0x300585,_0x5420b7,_0x292534,_0x58e460,_0x5245ae,_0xdd11f6){const _0xf995b8=a220_0x5de1ed,{buyPrice:_0x359daf,sellPrice:_0x391939,buyWage:_0x1cc7fd,sellWage:_0x15ec93}=_0x5420b7;let _0x4ac8df,_0x258bd7,_0x4f6e15,_0x360f3e,_0x48af31;_0x29b436===transaction_schema_1[_0xf995b8(0x23e)][_0xf995b8(0x2bd)]?(_0x4ac8df=_0x292534,_0x258bd7=_0x5245ae,_0x360f3e=_0x300585*_0x1cc7fd,_0x4f6e15=_0x300585*_0x359daf,_0x48af31=_0x359daf):(_0x4ac8df=_0x58e460,_0x258bd7=_0xdd11f6,_0x360f3e=_0x300585*_0x15ec93,_0x4f6e15=_0x300585*_0x391939,_0x48af31=_0x391939);if(_0x300585<_0x4ac8df)throw new common_1[(_0xf995b8(0x1a8))](this[_0xf995b8(0x1e5)]['t'](_0xf995b8(0x24a),{'args':{'value':_0x4ac8df}}));if(!(0x0,utils_1['isFloatingPointCorrect'])(_0x300585,_0x258bd7))throw new common_1[(_0xf995b8(0x1a8))](this['i18n']['t'](_0xf995b8(0x1c9),{'args':{'value':_0x258bd7}}));return!Number[_0xf995b8(0x224)](_0x4f6e15)&&(_0x4f6e15=Math[_0xf995b8(0x1af)](_0x4f6e15)),{'total':_0x4f6e15,'wage':_0x360f3e,'price':_0x48af31};}async[a220_0x5de1ed(0x241)](_0x445552,_0x3ce81a){const _0x14f23d=a220_0x5de1ed,{amount:_0x55fd3a,type:_0x4fd02e,tradeableId:_0x1b9317,price:_0x5322d3}=_0x3ce81a,_0xb23523=await this['userService'][_0x14f23d(0x269)](_0x445552);if(!_0x5322d3)throw new common_1[(_0x14f23d(0x1a8))](this[_0x14f23d(0x1e5)]['t'](_0x14f23d(0x24b)));const {apiError:_0x21c882,ignoreApiError:_0x581ae2,buyMaxDecimals:_0x272ec7,sellMaxDecimals:_0x2410af,minBuyAmount:_0xa577b6,minSellAmount:_0x1a3335,wallgoldIntegrationIsActive:_0x484f3f}=await this['tradeableService']['findOrThrow'](_0x1b9317);if(_0x484f3f)throw new common_1[(_0x14f23d(0x1a8))](this['i18n']['t'](_0x14f23d(0x1f1)));if(_0x21c882&&!_0x581ae2)throw new common_1[(_0x14f23d(0x1bb))]();const {onlineFirstStepUserVerifyEnabled:_0x430676,offlineFirstStepUserVerifyEnabled:_0x179617}=await this['settingsService'][_0x14f23d(0x21a)]();if((_0x430676||_0x179617)&&_0xb23523[_0x14f23d(0x1b5)]===user_schema_1[_0x14f23d(0x22d)]['NotVerified'])throw new common_1[(_0x14f23d(0x1a8))](this[_0x14f23d(0x1e5)]['t'](_0x14f23d(0x2a8)));let _0x4daabd=await this[_0x14f23d(0x1f5)](_0x1b9317,_0x445552,_0x5322d3);if(!_0x4daabd){_0x4daabd=await this[_0x14f23d(0x23f)]['getTradeablePriceForLevel'](_0x1b9317,String(_0xb23523[_0x14f23d(0x297)]),_0x5322d3);if(!_0x4daabd){this[_0x14f23d(0x24d)][_0x14f23d(0x283)](_0x14f23d(0x21d)+_0xb23523[_0x14f23d(0x297)]);throw new common_1[(_0x14f23d(0x279))]();}}const {total:_0x3c1f27,wage:_0xffb222,price:_0x547df6}=this['calcAndValidateTransFields'](_0x4fd02e,_0x55fd3a,_0x4daabd,_0xa577b6,_0x1a3335,_0x272ec7,_0x2410af);let _0x450d9c;try{_0x450d9c=await this[_0x14f23d(0x299)][_0x14f23d(0x1ee)](),_0x450d9c['startTransaction']();_0x4fd02e===transaction_schema_1[_0x14f23d(0x23e)][_0x14f23d(0x2bd)]?await this[_0x14f23d(0x286)][_0x14f23d(0x2a6)](_0x445552,_0x3c1f27,balance_log_schema_1['BalanceLogAction']['BuyTransaction'],_0x450d9c):await this[_0x14f23d(0x29f)][_0x14f23d(0x236)](_0x445552,_0x1b9317,_0x55fd3a,![],_0x450d9c);const _0x634a5b=await this[_0x14f23d(0x204)][_0x14f23d(0x28c)]([{'amount':_0x55fd3a,'type':_0x4fd02e,'status':transaction_schema_1['TransactionStatus'][_0x14f23d(0x1ab)],'user':_0x445552,'wage':_0xffb222,'total':_0x3c1f27,'tradeablePrice':_0x547df6,'tradeable':_0x1b9317,'isFixedPrice':!![]}],{'session':_0x450d9c});return await _0x450d9c[_0x14f23d(0x19d)](),_0x634a5b[0x0];}catch(_0xdacc07){if(_0x450d9c===null||_0x450d9c===void 0x0?void 0x0:_0x450d9c[_0x14f23d(0x288)]())await _0x450d9c['abortTransaction']();if(_0xdacc07[_0x14f23d(0x289)]>=0x190&&_0xdacc07[_0x14f23d(0x289)]<0x1f4)throw _0xdacc07;this['logger'][_0x14f23d(0x283)](_0x14f23d(0x2bc)+_0xdacc07);throw new common_1[(_0x14f23d(0x279))]();}finally{if(_0x450d9c)await _0x450d9c[_0x14f23d(0x2ab)]();}}async[a220_0x5de1ed(0x28c)](_0x56a223,_0x527e05){const _0x373d2c=a220_0x5de1ed,{amount:_0x418610,type:_0x357911,tradeableId:_0x142ac7,price:_0x1e3aba}=_0x527e05,_0x242c30=await this[_0x373d2c(0x286)][_0x373d2c(0x269)](_0x56a223),{apiError:_0xa6de4d,ignoreApiError:_0x53d6ca,referrerRewardPercent:_0x45560f,minBuyAmount:_0x370ef3,minSellAmount:_0x5037cd,buyMaxDecimals:_0x4e05b3,sellMaxDecimals:_0x2a607f,wallgoldIntegrationIsActive:_0x1a6389}=await this[_0x373d2c(0x29f)][_0x373d2c(0x269)](_0x142ac7);if(_0xa6de4d&&!_0x53d6ca)throw new common_1[(_0x373d2c(0x1bb))]();const {onlineFirstStepUserVerifyEnabled:_0x3b85fa,offlineFirstStepUserVerifyEnabled:_0xeb2b5d,manualTransactionConfirmation:_0x304254,scalpingPreventionPeriodInHours:_0x14963d}=await this[_0x373d2c(0x296)]['settings']();if((_0x3b85fa||_0xeb2b5d)&&_0x242c30[_0x373d2c(0x1b5)]===user_schema_1['VerificationStatus']['NotVerified'])throw new common_1['BadRequestException'](this[_0x373d2c(0x1e5)]['t'](_0x373d2c(0x2a8)));await this[_0x373d2c(0x1b1)](_0x242c30[_0x373d2c(0x287)],_0x142ac7,_0x418610);let _0x2180e9=await this[_0x373d2c(0x1f5)](_0x142ac7,_0x56a223);if(!_0x2180e9){_0x2180e9=await this['levelService'][_0x373d2c(0x1c7)](_0x142ac7,String(_0x242c30['level']));if(!_0x2180e9){this['logger'][_0x373d2c(0x283)](_0x373d2c(0x21d)+_0x242c30[_0x373d2c(0x297)]);throw new common_1['InternalServerErrorException']();}}const {total:_0x4bf29e,wage:_0x3a0bc7,price:_0x550c2c}=this[_0x373d2c(0x27d)](_0x357911,_0x418610,_0x2180e9,_0x370ef3,_0x5037cd,_0x4e05b3,_0x2a607f),_0x5173d8=await this[_0x373d2c(0x23f)][_0x373d2c(0x2be)](String(_0x242c30['level'])),_0x5a6f0c=new Date(),_0x4802e0=(0x0,moment_1[_0x373d2c(0x223)])(_0x5a6f0c)[_0x373d2c(0x275)](_0x373d2c(0x208))[_0x373d2c(0x257)]();await this[_0x373d2c(0x292)](_0x242c30[_0x373d2c(0x287)],_0x5173d8,_0x4bf29e,_0x4802e0,_0x5a6f0c,_0x357911);if(_0x1e3aba!==_0x550c2c){this[_0x373d2c(0x24d)][_0x373d2c(0x283)](_0x373d2c(0x1d3)+_0x1e3aba+'\x20!==\x20'+_0x550c2c);throw new common_1[(_0x373d2c(0x1a8))](this[_0x373d2c(0x1e5)]['t'](_0x373d2c(0x259)));}let _0x4cb4a5=transaction_schema_1[_0x373d2c(0x2c8)][_0x373d2c(0x2af)],_0x49142f;try{_0x49142f=await this[_0x373d2c(0x299)][_0x373d2c(0x1ee)](),_0x49142f[_0x373d2c(0x232)]();if(_0x357911===transaction_schema_1[_0x373d2c(0x23e)]['Buy']){await this[_0x373d2c(0x286)][_0x373d2c(0x2a6)](_0x56a223,_0x4bf29e,balance_log_schema_1['BalanceLogAction'][_0x373d2c(0x21f)],_0x49142f);if(!_0x1a6389&&(_0x304254||_0x14963d))_0x4cb4a5=transaction_schema_1[_0x373d2c(0x2c8)][_0x373d2c(0x285)];else{await this[_0x373d2c(0x29f)][_0x373d2c(0x25f)](_0x56a223,_0x142ac7,_0x418610,![],_0x49142f);if(!_0x1a6389)await this[_0x373d2c(0x29f)][_0x373d2c(0x256)](_0x142ac7,_0x418610,_0x49142f);await this[_0x373d2c(0x1dc)](_0x242c30[_0x373d2c(0x245)],_0x45560f,_0x3a0bc7,_0x49142f);}}else{await this[_0x373d2c(0x29f)][_0x373d2c(0x236)](_0x56a223,_0x142ac7,_0x418610,![],_0x49142f);if(!_0x1a6389&&_0x304254)_0x4cb4a5=transaction_schema_1['TransactionStatus'][_0x373d2c(0x285)];else{await this[_0x373d2c(0x286)][_0x373d2c(0x218)](_0x56a223,_0x4bf29e,balance_log_schema_1[_0x373d2c(0x2c3)][_0x373d2c(0x220)],_0x49142f);if(!_0x1a6389)await this[_0x373d2c(0x29f)][_0x373d2c(0x1c8)](_0x142ac7,_0x418610,_0x49142f);await this[_0x373d2c(0x1dc)](_0x242c30[_0x373d2c(0x245)],_0x45560f,_0x3a0bc7,_0x49142f);}}const _0x456a38=await this[_0x373d2c(0x204)][_0x373d2c(0x28c)]([{'amount':_0x418610,'type':_0x357911,'status':_0x4cb4a5,'user':_0x56a223,'wage':_0x3a0bc7,'total':_0x4bf29e,'tradeablePrice':_0x550c2c,'tradeable':_0x142ac7}],{'session':_0x49142f});if(_0x1a6389){const _0x54e4e0=_0x357911===transaction_schema_1[_0x373d2c(0x23e)][_0x373d2c(0x2bd)]?_0x373d2c(0x20c):'sell',_0xf771d1=await this[_0x373d2c(0x22e)][_0x373d2c(0x26d)](_0x54e4e0);if(_0xf771d1!==_0x2180e9['tradeable'][_0x373d2c(0x248)]){this[_0x373d2c(0x24d)][_0x373d2c(0x283)]('Wallgold\x20price\x20mismatch:\x20'+_0xf771d1+_0x373d2c(0x2b9)+_0x550c2c);throw new common_1['BadRequestException'](this[_0x373d2c(0x1e5)]['t'](_0x373d2c(0x259)));}const _0x3e75c1=await this[_0x373d2c(0x22e)][_0x373d2c(0x20f)](String(_0x456a38[0x0][_0x373d2c(0x287)]),_0x418610,_0x54e4e0);await this['transactionModel'][_0x373d2c(0x2c5)](_0x456a38[0x0][_0x373d2c(0x287)],{'wallgoldOrderId':_0x3e75c1[_0x373d2c(0x27c)],'wallgoldPrice':_0x3e75c1['price']},{'new':!![],'session':_0x49142f});}return await _0x49142f[_0x373d2c(0x19d)](),void this['levelService'][_0x373d2c(0x238)](_0x56a223)[_0x373d2c(0x260)](_0x3a5396=>{this['logger']['error']('Error\x20updating\x20user\x20level:\x20'+_0x3a5396);}),_0x456a38[0x0];}catch(_0x484cfd){if(_0x49142f===null||_0x49142f===void 0x0?void 0x0:_0x49142f['inTransaction']())await _0x49142f[_0x373d2c(0x1e0)]();if(_0x484cfd[_0x373d2c(0x289)]>=0x190&&_0x484cfd[_0x373d2c(0x289)]<0x1f4)throw _0x484cfd;this[_0x373d2c(0x24d)][_0x373d2c(0x283)]('Error\x20in\x20createTransaction:\x20'+_0x484cfd);throw new common_1[(_0x373d2c(0x279))]();}finally{if(_0x49142f)await _0x49142f[_0x373d2c(0x2ab)]();}}async['payAffiliateReward'](_0xf727c7,_0x3210b3,_0x57a234,_0x30b987){const _0x1f9fa7=a220_0x5de1ed;if(_0xf727c7&&_0x3210b3){const _0x5bed8e=Math['floor'](_0x57a234*(_0x3210b3/0x64));await this[_0x1f9fa7(0x286)][_0x1f9fa7(0x218)](_0xf727c7,_0x5bed8e,balance_log_schema_1['BalanceLogAction'][_0x1f9fa7(0x270)],_0x30b987);}}async[a220_0x5de1ed(0x24e)](_0x220fa7,_0x170ca0){const _0x4282c6=a220_0x5de1ed,{status:_0x9865db,confirmDescription:_0x193bde}=_0x170ca0,{status:_0x4d879d,user:_0xd76bd0,tradeable:_0xcbee68,type:_0x33c5be,amount:_0x47393e,total:_0x449d5e,paid:_0x30c1a1,wage:_0x536a82}=await this[_0x4282c6(0x269)](_0x220fa7),{referrerRewardPercent:_0xa334b3}=await this[_0x4282c6(0x29f)]['findOrThrow'](String(_0xcbee68)),{referrer:_0x1b020b}=await this[_0x4282c6(0x286)][_0x4282c6(0x269)](String(_0xd76bd0));if(_0x33c5be===transaction_schema_1[_0x4282c6(0x23e)]['PayLaterBuy']&&!_0x30c1a1)throw new common_1[(_0x4282c6(0x1a8))](this[_0x4282c6(0x1e5)]['t'](_0x4282c6(0x1fa)));if(_0x4d879d!==transaction_schema_1['TransactionStatus']['Pending']||_0x4d879d===_0x9865db)throw new common_1['BadRequestException'](this[_0x4282c6(0x1e5)]['t'](_0x4282c6(0x22f)));let _0x1d2148;try{_0x1d2148=await this[_0x4282c6(0x299)]['startSession'](),_0x1d2148[_0x4282c6(0x232)]();if(_0x33c5be===transaction_schema_1['TransactionType'][_0x4282c6(0x2bd)])_0x9865db===transaction_schema_1[_0x4282c6(0x2c8)][_0x4282c6(0x2af)]?(await this[_0x4282c6(0x29f)][_0x4282c6(0x25f)](String(_0xd76bd0),String(_0xcbee68),_0x47393e,![],_0x1d2148),await this[_0x4282c6(0x29f)][_0x4282c6(0x256)](String(_0xcbee68),_0x47393e,_0x1d2148),await this[_0x4282c6(0x1dc)](_0x1b020b,_0xa334b3,_0x536a82,_0x1d2148)):await this[_0x4282c6(0x286)][_0x4282c6(0x218)](String(_0xd76bd0),_0x449d5e,balance_log_schema_1['BalanceLogAction'][_0x4282c6(0x21e)],_0x1d2148);else _0x33c5be===transaction_schema_1[_0x4282c6(0x23e)]['Sell']?_0x9865db===transaction_schema_1[_0x4282c6(0x2c8)][_0x4282c6(0x2af)]?(await this['userService'][_0x4282c6(0x218)](String(_0xd76bd0),_0x449d5e,balance_log_schema_1[_0x4282c6(0x2c3)][_0x4282c6(0x220)],_0x1d2148),await this[_0x4282c6(0x29f)][_0x4282c6(0x1c8)](String(_0xcbee68),_0x47393e,_0x1d2148),await this[_0x4282c6(0x1dc)](_0x1b020b,_0xa334b3,_0x536a82,_0x1d2148)):await this[_0x4282c6(0x29f)]['incUserInv'](String(_0xd76bd0),String(_0xcbee68),_0x47393e,![],_0x1d2148):_0x9865db===transaction_schema_1[_0x4282c6(0x2c8)][_0x4282c6(0x2af)]?(await this[_0x4282c6(0x29f)][_0x4282c6(0x236)](String(_0xd76bd0),String(_0xcbee68),_0x47393e,!![],_0x1d2148),await this['tradeableService'][_0x4282c6(0x25f)](String(_0xd76bd0),String(_0xcbee68),_0x47393e,![],_0x1d2148),await this['payAffiliateReward'](_0x1b020b,_0xa334b3,_0x536a82,_0x1d2148)):(await this[_0x4282c6(0x29f)]['decUserInv'](String(_0xd76bd0),String(_0xcbee68),_0x47393e,!![],_0x1d2148),await this['tradeableService'][_0x4282c6(0x1c8)](String(_0xcbee68),_0x47393e,_0x1d2148),await this[_0x4282c6(0x286)][_0x4282c6(0x218)](String(_0xd76bd0),_0x449d5e,balance_log_schema_1[_0x4282c6(0x2c3)][_0x4282c6(0x21e)],_0x1d2148));const _0x23f18e=await this[_0x4282c6(0x204)][_0x4282c6(0x2c5)](_0x220fa7,{'status':_0x9865db,'confirmDescription':_0x193bde},{'new':!![],'session':_0x1d2148});return await _0x1d2148[_0x4282c6(0x19d)](),_0x23f18e;}catch(_0x4bd6f2){if(_0x1d2148===null||_0x1d2148===void 0x0?void 0x0:_0x1d2148[_0x4282c6(0x288)]())await _0x1d2148[_0x4282c6(0x1e0)]();if(_0x4bd6f2[_0x4282c6(0x289)]>=0x190&&_0x4bd6f2[_0x4282c6(0x289)]<0x1f4)throw _0x4bd6f2;this[_0x4282c6(0x24d)]['error'](_0x4282c6(0x25b)+_0x4bd6f2);throw new common_1['InternalServerErrorException']();}finally{if(_0x1d2148)await _0x1d2148['endSession']();}}async[a220_0x5de1ed(0x199)](_0x4d2e7f,_0x351b8c){const _0x12604a=a220_0x5de1ed,{status:_0x4bc68c,user:_0x50a8d7,total:_0x48bca2,type:_0x4b1b32,tradeable:_0x511db4,amount:_0x158202}=await this[_0x12604a(0x269)](_0x4d2e7f);if(String(_0x50a8d7)!==_0x351b8c)throw new common_1['NotFoundException'](this[_0x12604a(0x1e5)]['t'](_0x12604a(0x217)));if(_0x4bc68c!==transaction_schema_1[_0x12604a(0x2c8)][_0x12604a(0x1ab)])throw new common_1[(_0x12604a(0x1a8))](this['i18n']['t']('errors.transaction.cantChangeStatus'));let _0x1fa6a3;try{_0x1fa6a3=await this[_0x12604a(0x299)]['startSession'](),_0x1fa6a3[_0x12604a(0x232)](),await this[_0x12604a(0x204)][_0x12604a(0x2c5)](_0x4d2e7f,{'status':transaction_schema_1['TransactionStatus'][_0x12604a(0x215)]},{'new':!![],'session':_0x1fa6a3}),_0x4b1b32===transaction_schema_1['TransactionType']['Buy']?await this[_0x12604a(0x286)][_0x12604a(0x218)](String(_0x50a8d7),_0x48bca2,balance_log_schema_1[_0x12604a(0x2c3)][_0x12604a(0x21e)],_0x1fa6a3):await this[_0x12604a(0x29f)][_0x12604a(0x25f)](_0x351b8c,String(_0x511db4),_0x158202,![],_0x1fa6a3),await _0x1fa6a3[_0x12604a(0x19d)]();}catch(_0x46cdb3){if(_0x1fa6a3===null||_0x1fa6a3===void 0x0?void 0x0:_0x1fa6a3[_0x12604a(0x288)]())await _0x1fa6a3[_0x12604a(0x1e0)]();if(_0x46cdb3['status']>=0x190&&_0x46cdb3[_0x12604a(0x289)]<0x1f4)throw _0x46cdb3;this[_0x12604a(0x24d)][_0x12604a(0x283)](_0x12604a(0x1bc)+_0x46cdb3);throw new common_1[(_0x12604a(0x279))]();}finally{if(_0x1fa6a3)await _0x1fa6a3[_0x12604a(0x2ab)]();}}async[a220_0x5de1ed(0x29e)](_0x5f1d3d,_0x19e477){const _0x306dc7=a220_0x5de1ed,{amount:_0x20fef3,tradeableId:_0x16a6ea}=_0x19e477,_0x174cda=await this[_0x306dc7(0x286)][_0x306dc7(0x269)](_0x5f1d3d),{minBuyAmount:_0x54844f,buyMaxDecimals:_0x292dd7}=await this[_0x306dc7(0x29f)][_0x306dc7(0x269)](_0x16a6ea);let _0x235885=await this[_0x306dc7(0x1f5)](_0x16a6ea,_0x5f1d3d);if(!_0x235885){_0x235885=await this['levelService'][_0x306dc7(0x1c7)](_0x16a6ea,String(_0x174cda['level']));if(!_0x235885){this[_0x306dc7(0x24d)][_0x306dc7(0x283)](_0x306dc7(0x21d)+_0x174cda[_0x306dc7(0x297)]);throw new common_1[(_0x306dc7(0x279))]();}}const {buyPrice:_0x2c1692,buyWage:_0x42b494}=_0x235885,_0x47ebd9=_0x20fef3*_0x42b494;let _0x1df18a=_0x20fef3*_0x2c1692;if(_0x20fef3<_0x54844f)throw new common_1[(_0x306dc7(0x1a8))](this['i18n']['t']('errors.transaction.lessThanMinTradeableAmount',{'args':{'value':_0x54844f}}));if(!(0x0,utils_1[_0x306dc7(0x1a0)])(_0x20fef3,_0x292dd7))throw new common_1[(_0x306dc7(0x1a8))](this[_0x306dc7(0x1e5)]['t'](_0x306dc7(0x1c9),{'args':{'value':_0x292dd7}}));return!Number['isInteger'](_0x1df18a)&&(_0x1df18a=Math[_0x306dc7(0x1af)](_0x1df18a)),{'total':_0x1df18a,'wage':_0x47ebd9};}async[a220_0x5de1ed(0x2b4)](_0x2dd0ab){const _0x3bc41a=a220_0x5de1ed;var _0x518656;const _0x20caf2=await this[_0x3bc41a(0x204)]['aggregate']([{'$match':{'user':new mongoose_2[(_0x3bc41a(0x1a6))][(_0x3bc41a(0x1b8))](_0x2dd0ab),'type':transaction_schema_1[_0x3bc41a(0x23e)][_0x3bc41a(0x1d6)],'status':status_enum_1[_0x3bc41a(0x26a)][_0x3bc41a(0x285)]}},{'$group':{'_id':null,'total':{'$sum':_0x3bc41a(0x276)}}}]);return((_0x518656=_0x20caf2[0x0])===null||_0x518656===void 0x0?void 0x0:_0x518656[_0x3bc41a(0x231)])||0x0;}async[a220_0x5de1ed(0x290)](_0x425354,_0x3e3d77){const _0x4e7e37=a220_0x5de1ed,{amount:_0x912daf,tradeableId:_0x40268f}=_0x3e3d77,{wallgoldIntegrationIsActive:_0xee725e}=await this['tradeableService']['findOrThrow'](_0x40268f);if(_0xee725e)throw new common_1['BadRequestException'](this[_0x4e7e37(0x1e5)]['t'](_0x4e7e37(0x19e)));const {apiError:_0x513629,ignoreApiError:_0x131c82}=await this[_0x4e7e37(0x29f)][_0x4e7e37(0x269)](_0x40268f);if(_0x513629&&!_0x131c82)throw new common_1[(_0x4e7e37(0x1bb))]();const {total:_0x480f69,wage:_0x4c4cb1}=await this[_0x4e7e37(0x29e)](_0x425354,_0x3e3d77),{payLaterDeadlineHours:_0x25badf,payLaterLimit:_0x4567d1}=await this[_0x4e7e37(0x296)]['settings'](),_0x1b6134=await this['getPendingPayLaterTransactionsAmount'](_0x425354);if(_0x1b6134+_0x480f69>_0x4567d1)throw new common_1['BadRequestException'](this[_0x4e7e37(0x1e5)]['t']('errors.transaction.payLaterLimit'));const _0x2a1459=(0x0,moment_1['default'])(new Date())[_0x4e7e37(0x244)](_0x25badf,_0x4e7e37(0x265))[_0x4e7e37(0x257)]();let _0xe2b539;try{_0xe2b539=await this[_0x4e7e37(0x299)]['startSession'](),_0xe2b539['startTransaction'](),await this[_0x4e7e37(0x29f)][_0x4e7e37(0x25f)](_0x425354,_0x40268f,_0x912daf,!![],_0xe2b539),await this[_0x4e7e37(0x29f)][_0x4e7e37(0x256)](_0x40268f,_0x912daf,_0xe2b539);const _0x433be0=await this[_0x4e7e37(0x204)][_0x4e7e37(0x28c)]([{'amount':_0x912daf,'type':transaction_schema_1[_0x4e7e37(0x23e)][_0x4e7e37(0x1d6)],'status':status_enum_1[_0x4e7e37(0x26a)][_0x4e7e37(0x285)],'user':_0x425354,'wage':_0x4c4cb1,'total':_0x480f69,'tradeable':_0x40268f,'paymentDeadline':_0x2a1459,'paid':![]}],{'session':_0xe2b539});return await _0xe2b539[_0x4e7e37(0x19d)](),_0x433be0[0x0];}catch(_0x44c2c5){if(_0xe2b539===null||_0xe2b539===void 0x0?void 0x0:_0xe2b539[_0x4e7e37(0x288)]())await _0xe2b539[_0x4e7e37(0x1e0)]();this['logger'][_0x4e7e37(0x283)](_0x4e7e37(0x254)+_0x44c2c5);throw new common_1[(_0x4e7e37(0x279))]();}finally{if(_0xe2b539)await _0xe2b539[_0x4e7e37(0x2ab)]();}}async[a220_0x5de1ed(0x2b6)](_0x53f934,_0x50b46e){const _0x3e51d6=a220_0x5de1ed,{total:_0xe28000,status:_0x3c623a,tradeable:_0x3e0857,amount:_0x5473b3,user:_0x4e1946,type:_0x4885c9,wage:_0x27cca1}=await this['findOrThrow'](_0x50b46e),{referrerRewardPercent:_0x574549}=await this['tradeableService'][_0x3e51d6(0x269)](String(_0x3e0857)),{referrer:_0x518b14}=await this[_0x3e51d6(0x286)]['findOrThrow'](String(_0x4e1946));if(String(_0x4e1946)!=_0x53f934||_0x4885c9!==transaction_schema_1[_0x3e51d6(0x23e)][_0x3e51d6(0x1d6)])throw new common_1['NotFoundException'](this[_0x3e51d6(0x1e5)]['t']('errors.transaction.notFound'));if(_0x3c623a!==transaction_schema_1[_0x3e51d6(0x2c8)][_0x3e51d6(0x285)])throw new common_1[(_0x3e51d6(0x1a8))](this[_0x3e51d6(0x1e5)]['t']('errors.transaction.cantChangeStatus'));let _0x4ce3ee;try{_0x4ce3ee=await this['connection']['startSession'](),_0x4ce3ee['startTransaction'](),await this[_0x3e51d6(0x286)][_0x3e51d6(0x2a6)](_0x53f934,_0xe28000,balance_log_schema_1[_0x3e51d6(0x2c3)][_0x3e51d6(0x21f)],_0x4ce3ee);let _0x5d8518=status_enum_1[_0x3e51d6(0x26a)][_0x3e51d6(0x285)];const {manualTransactionConfirmation:_0x2d7934}=await this[_0x3e51d6(0x296)][_0x3e51d6(0x21a)]();!_0x2d7934&&(await this[_0x3e51d6(0x29f)]['decUserInv'](_0x53f934,String(_0x3e0857),_0x5473b3,!![],_0x4ce3ee),await this[_0x3e51d6(0x29f)][_0x3e51d6(0x25f)](_0x53f934,String(_0x3e0857),_0x5473b3,![],_0x4ce3ee),await this[_0x3e51d6(0x1dc)](_0x518b14,_0x574549,_0x27cca1,_0x4ce3ee),_0x5d8518=status_enum_1['Status'][_0x3e51d6(0x2af)]),await this[_0x3e51d6(0x204)][_0x3e51d6(0x2c5)](_0x50b46e,{'status':_0x5d8518,'paid':!![]},{'session':_0x4ce3ee}),await _0x4ce3ee['commitTransaction'](),void this[_0x3e51d6(0x23f)][_0x3e51d6(0x238)](_0x53f934)[_0x3e51d6(0x260)](_0x113755=>{const _0x326da4=_0x3e51d6;this[_0x326da4(0x24d)][_0x326da4(0x283)](_0x326da4(0x1b3)+_0x113755);});}catch(_0x4f4999){if(_0x4ce3ee===null||_0x4ce3ee===void 0x0?void 0x0:_0x4ce3ee['inTransaction']())await _0x4ce3ee['abortTransaction']();if(_0x4f4999[_0x3e51d6(0x289)]>=0x190&&_0x4f4999[_0x3e51d6(0x289)]<0x1f4)throw _0x4f4999;this[_0x3e51d6(0x24d)][_0x3e51d6(0x283)](_0x3e51d6(0x2bb)+_0x4f4999);throw new common_1['InternalServerErrorException']();}finally{if(_0x4ce3ee)await _0x4ce3ee[_0x3e51d6(0x2ab)]();}}async[a220_0x5de1ed(0x1d2)](_0x9d5f9f,_0x25930d){const _0x465cef=a220_0x5de1ed,{skip:_0x26ad50,limit:_0x5577e0,sortBy:_0x20f1f1,sortOrder:_0x15db07,userId:_0x9851d7,type:_0x440847,search:_0x5c548d}=_0x25930d,_0x1161c7={},_0x5277f6={},_0x26a19d=await this[_0x465cef(0x286)][_0x465cef(0x2be)](_0x9d5f9f);[user_schema_1['Role'][_0x465cef(0x1ed)],user_schema_1[_0x465cef(0x1ca)][_0x465cef(0x22b)]]['includes'](_0x26a19d[_0x465cef(0x25e)])?_0x1161c7[_0x465cef(0x261)]=new mongoose_2[(_0x465cef(0x1a6))]['ObjectId'](_0x9d5f9f):(_0x9851d7&&(await this[_0x465cef(0x286)][_0x465cef(0x2be)](_0x9851d7),_0x1161c7['user._id']=new mongoose_2[(_0x465cef(0x1a6))][(_0x465cef(0x1b8))](_0x9851d7)),_0x5c548d&&(_0x1161c7[_0x465cef(0x26b)]=[{'user.mobileNumber':RegExp(_0x5c548d,'i')},{'user.firstName':RegExp(_0x5c548d,'i')},{'user.lastName':RegExp(_0x5c548d,'i')}]));if(_0x440847)_0x1161c7[_0x465cef(0x1ef)]=_0x440847;if(!_0x20f1f1)_0x5277f6['createdAt']=-0x1;else _0x5277f6[_0x20f1f1]=_0x15db07?0x1:-0x1;const _0x19d534=await this['transactionModel'][_0x465cef(0x262)]([{'$lookup':{'from':_0x465cef(0x221),'localField':_0x465cef(0x26c),'foreignField':'_id','as':_0x465cef(0x25d)}},{'$lookup':{'from':_0x465cef(0x19b),'localField':_0x465cef(0x1df),'foreignField':'_id','as':'tradeableArr'}},{'$set':{'user._id':{'$first':_0x465cef(0x1c2)},'user.mobileNumber':{'$first':_0x465cef(0x294)},'user.firstName':{'$first':_0x465cef(0x219)},'user.lastName':{'$first':_0x465cef(0x1f4)},'user.role':{'$first':_0x465cef(0x2ae)},'user.sex':{'$first':_0x465cef(0x252)},'user.verificationStatus':{'$first':_0x465cef(0x1f8)},'tradeable._id':{'$first':'$tradeableArr._id'},'tradeable.name':{'$first':'$tradeableArr.name'},'tradeable.nameFa':{'$first':_0x465cef(0x251)},'tradeable.image':{'$first':_0x465cef(0x2bf)}}},{'$match':_0x1161c7},{'$unset':['userArr','tradeableArr']},{'$sort':_0x5277f6},{'$facet':{'data':[{'$skip':_0x26ad50},{'$limit':_0x5577e0}],'count':[{'$count':_0x465cef(0x243)}]}},{'$set':{'count':{'$first':_0x465cef(0x1de)}}}]);return{'count':_0x19d534[0x0][_0x465cef(0x243)],'data':_0x19d534[0x0][_0x465cef(0x227)]};}async[a220_0x5de1ed(0x1b2)](){const _0x5dfddc=a220_0x5de1ed,_0x5163c2=await this['transactionModel']['aggregate']([{'$group':{'_id':'$status','count':{'$count':{}}}}]);let _0x22881b=0x0,_0x1fab4c=0x0,_0x2d84f8=0x0;for(const _0x2bef14 of _0x5163c2){if(_0x2bef14[_0x5dfddc(0x287)]===status_enum_1[_0x5dfddc(0x26a)]['Accepted'])_0x22881b=_0x2bef14['count'];else{if(_0x2bef14[_0x5dfddc(0x287)]===status_enum_1[_0x5dfddc(0x26a)]['Pending'])_0x1fab4c=_0x2bef14[_0x5dfddc(0x243)];else _0x2d84f8=_0x2bef14[_0x5dfddc(0x243)];}}return{'accepted':_0x22881b,'pending':_0x1fab4c,'rejected':_0x2d84f8};}async[a220_0x5de1ed(0x258)](_0x3d6de5,_0x2ee8e0){const _0x1a7e7e=a220_0x5de1ed;var _0x191c8b;const _0x2bdde6=await this['transactionModel'][_0x1a7e7e(0x262)]([{'$match':{'createdAt':{'$gte':_0x3d6de5,'$lte':_0x2ee8e0},'status':transaction_schema_1[_0x1a7e7e(0x2c8)][_0x1a7e7e(0x2af)]}},{'$group':{'_id':null,'totalWage':{'$sum':_0x1a7e7e(0x2a3)}}}]);return((_0x191c8b=_0x2bdde6[0x0])===null||_0x191c8b===void 0x0?void 0x0:_0x191c8b[_0x1a7e7e(0x206)])||0x0;}[a220_0x5de1ed(0x1e1)](_0x33c98d,_0x3e235c){const _0x8476ce=a220_0x5de1ed,_0x358941=XLSX[_0x8476ce(0x19c)]['json_to_sheet'](_0x33c98d),_0x5d56f3=XLSX[_0x8476ce(0x19c)][_0x8476ce(0x213)]();XLSX[_0x8476ce(0x19c)][_0x8476ce(0x1d9)](_0x5d56f3,_0x358941,_0x8476ce(0x2c2)),XLSX['writeFile'](_0x5d56f3,this[_0x8476ce(0x20b)][_0x8476ce(0x1a9)](_0x8476ce(0x26e))+_0x8476ce(0x19f)+_0x3e235c);}async[a220_0x5de1ed(0x1d7)](_0x104f9c){const _0x5a78cf=a220_0x5de1ed,{user:_0x4edec7,startDate:_0x3d8bdf,endDate:_0x4c68b3}=await this['transReportModel'][_0x5a78cf(0x2be)](_0x104f9c),_0x23fef2={'createdAt':{'$gte':_0x3d8bdf,'$lte':_0x4c68b3}};if(_0x4edec7)_0x23fef2[_0x5a78cf(0x26c)]=new mongoose_2[(_0x5a78cf(0x1a6))][(_0x5a78cf(0x1b8))](String(_0x4edec7));const _0x3b5a93=await this['transactionModel'][_0x5a78cf(0x262)]([{'$match':_0x23fef2},{'$lookup':{'from':'users','localField':'user','foreignField':_0x5a78cf(0x287),'as':_0x5a78cf(0x26c)}},{'$lookup':{'from':_0x5a78cf(0x19b),'localField':_0x5a78cf(0x1df),'foreignField':'_id','as':_0x5a78cf(0x1df)}},{'$project':{'_id':'$$REMOVE','جنس':{'$first':'$tradeable.nameFa'},'نوع':{'$cond':{'if':{'$eq':[_0x5a78cf(0x1a2),'Buy']},'then':_0x5a78cf(0x20d),'else':_0x5a78cf(0x268)}},'میزان\x20(گرم)':'$amount','کارمزد':_0x5a78cf(0x2a3),'مبلغ':_0x5a78cf(0x276),'مبلغ\x20واحد':_0x5a78cf(0x29d),'وضعیت':_0x5a78cf(0x207),'ناریخ':'$jalaliDate','نام\x20خانوادگی':{'$first':_0x5a78cf(0x1aa)},'نام':{'$first':_0x5a78cf(0x29b)},'شماره\x20موبایل':{'$first':_0x5a78cf(0x228)}}}]),_0x4ba313=(0x0,crypto_1[_0x5a78cf(0x212)])(0xa)[_0x5a78cf(0x1ce)](_0x5a78cf(0x1e9))+_0x5a78cf(0x1eb);this[_0x5a78cf(0x1e1)](_0x3b5a93,_0x4ba313),await this[_0x5a78cf(0x1ec)][_0x5a78cf(0x2c5)](_0x104f9c,{'url':this[_0x5a78cf(0x20b)]['get'](_0x5a78cf(0x267))+'/report/'+_0x4ba313});}async[a220_0x5de1ed(0x250)](_0x44b8e2){const _0x2c8020=a220_0x5de1ed,{userId:_0x21dc1f,endDate:_0x3dcfb5,startDate:_0x597055}=_0x44b8e2;if(_0x21dc1f)await this[_0x2c8020(0x286)][_0x2c8020(0x269)](_0x21dc1f);if(_0x597055>=_0x3dcfb5)throw new common_1[(_0x2c8020(0x1a8))](this['i18n']['t'](_0x2c8020(0x28e)));const _0x9bddad=await this['transReportModel'][_0x2c8020(0x28c)]({'startDate':_0x597055,'endDate':_0x3dcfb5,'user':_0x21dc1f});return this['generateReportFile'](_0x9bddad[_0x2c8020(0x287)]),_0x9bddad;}async[a220_0x5de1ed(0x1d1)](_0x3c5058){const _0x26e684=a220_0x5de1ed,{skip:_0x4e09fc,limit:_0x196b86,sortBy:_0x12bc91,sortOrder:_0x41e405,search:_0x21bd0c}=_0x3c5058,_0x6bfe6b={},_0x3a60e7={};_0x21bd0c&&(_0x6bfe6b[_0x26e684(0x26b)]=[{'user.mobileNumber':RegExp(_0x21bd0c,'i')},{'user.firstName':RegExp(_0x21bd0c,'i')},{'user.lastName':RegExp(_0x21bd0c,'i')}]);if(!_0x12bc91)_0x3a60e7['createdAt']=-0x1;else _0x3a60e7[_0x12bc91]=_0x41e405?0x1:-0x1;const _0x516584=await this['transReportModel']['aggregate']([{'$lookup':{'from':_0x26e684(0x221),'localField':_0x26e684(0x26c),'foreignField':'_id','as':_0x26e684(0x25d)}},{'$set':{'user._id':{'$first':_0x26e684(0x1c2)},'user.mobileNumber':{'$first':_0x26e684(0x294)},'user.firstName':{'$first':'$userArr.firstName'},'user.lastName':{'$first':_0x26e684(0x1f4)},'user.role':{'$first':_0x26e684(0x2ae)},'user.sex':{'$first':_0x26e684(0x252)},'user.verificationStatus':{'$first':'$userArr.verificationStatus'}}},{'$match':_0x6bfe6b},{'$unset':[_0x26e684(0x25d)]},{'$sort':_0x3a60e7},{'$facet':{'data':[{'$skip':_0x4e09fc},{'$limit':_0x196b86}],'count':[{'$count':_0x26e684(0x243)}]}},{'$set':{'count':{'$first':'$count.count'}}}]);return{'count':_0x516584[0x0][_0x26e684(0x243)],'data':_0x516584[0x0][_0x26e684(0x227)]};}async['extGetTransactions'](_0x216fb3){const _0x4e5675=a220_0x5de1ed,{skip:_0xd4a103,limit:_0x8abae9,sortBy:_0x2b1d41,sortOrder:_0x562355,startDate:_0x7033fd}=_0x216fb3,_0x2b0303={};if(_0x7033fd)_0x2b0303[_0x4e5675(0x1b0)]={'$gte':_0x7033fd};const _0x5d20c4={};if(_0x2b1d41)_0x5d20c4[_0x2b1d41]=_0x562355?0x1:-0x1;const _0x540acf=await this[_0x4e5675(0x204)][_0x4e5675(0x209)](_0x2b0303)[_0x4e5675(0x255)]({'locale':'en'})[_0x4e5675(0x24f)](_0x5d20c4)[_0x4e5675(0x226)](_0xd4a103)[_0x4e5675(0x29c)](_0x8abae9)['populate']({'path':_0x4e5675(0x1df),'select':_0x4e5675(0x1a3)})['select'](_0x4e5675(0x1ea))[_0x4e5675(0x225)](),_0x5ae340=await this['transactionModel']['countDocuments'](_0x2b0303);return{'count':_0x5ae340,'data':_0x540acf};}async[a220_0x5de1ed(0x2b8)](_0x523462){const _0x1817ce=a220_0x5de1ed,_0x3e96b2=await this[_0x1817ce(0x1b4)][_0x1817ce(0x2be)](_0x523462)['lean']();if(!_0x3e96b2)throw new common_1[(_0x1817ce(0x274))](this['i18n']['t'](_0x1817ce(0x1cf)));return _0x3e96b2;}async[a220_0x5de1ed(0x29a)](_0x559868,_0x1f0690,_0x1b8a08=undefined){const _0x3096f9=a220_0x5de1ed;let _0xd7ff1={'tradeable':_0x1f0690};if(_0x1b8a08)_0xd7ff1={'$or':[Object[_0x3096f9(0x1ad)](Object['assign']({},_0xd7ff1),{'user':{'$exists':![]}}),Object['assign'](Object[_0x3096f9(0x1ad)]({},_0xd7ff1),{'user':_0x1b8a08})]};const _0x4140c2=await this['tradeLimitModel']['find'](_0xd7ff1)[_0x3096f9(0x225)](),_0x53ab21=new Date(_0x559868);_0x53ab21['setUTCHours'](0x0,0x0,0x0,0x0);const _0x2653da=new Date(_0x53ab21);_0x2653da[_0x3096f9(0x1be)](_0x2653da[_0x3096f9(0x2aa)]()+0x1);const _0x121740=[];for(const _0xa659c4 of _0x4140c2){const {startTime:_0x542e16,endTime:_0x25dbcf}=_0xa659c4,_0x1da4b3=_0x25dbcf['getUTCDate']()!==_0x542e16[_0x3096f9(0x2aa)]();let _0x4ce68c,_0x65c7cc;if(_0x1da4b3){const _0x147b8f=_0x559868['getUTCHours'](),_0x567573=_0x542e16[_0x3096f9(0x1ba)]();if(_0x147b8f>=_0x567573)_0x4ce68c=new Date(_0x53ab21),_0x4ce68c[_0x3096f9(0x1bf)](_0x542e16[_0x3096f9(0x1ba)](),_0x542e16['getUTCMinutes'](),_0x542e16[_0x3096f9(0x1b6)](),_0x542e16[_0x3096f9(0x23a)]()),_0x65c7cc=new Date(_0x2653da),_0x65c7cc['setUTCHours'](_0x25dbcf[_0x3096f9(0x1ba)](),_0x25dbcf[_0x3096f9(0x229)](),_0x25dbcf['getUTCSeconds'](),_0x25dbcf[_0x3096f9(0x23a)]());else{const _0x1b041c=new Date(_0x53ab21);_0x1b041c[_0x3096f9(0x1be)](_0x1b041c['getUTCDate']()-0x1),_0x4ce68c=new Date(_0x1b041c),_0x4ce68c[_0x3096f9(0x1bf)](_0x542e16['getUTCHours'](),_0x542e16[_0x3096f9(0x229)](),_0x542e16[_0x3096f9(0x1b6)](),_0x542e16[_0x3096f9(0x23a)]()),_0x65c7cc=new Date(_0x53ab21),_0x65c7cc[_0x3096f9(0x1bf)](_0x25dbcf[_0x3096f9(0x1ba)](),_0x25dbcf[_0x3096f9(0x229)](),_0x25dbcf['getUTCSeconds'](),_0x25dbcf[_0x3096f9(0x23a)]());}}else _0x4ce68c=new Date(_0x53ab21),_0x4ce68c[_0x3096f9(0x1bf)](_0x542e16[_0x3096f9(0x1ba)](),_0x542e16[_0x3096f9(0x229)](),_0x542e16[_0x3096f9(0x1b6)](),_0x542e16[_0x3096f9(0x23a)]()),_0x65c7cc=new Date(_0x53ab21),_0x65c7cc['setUTCHours'](_0x25dbcf[_0x3096f9(0x1ba)](),_0x25dbcf[_0x3096f9(0x229)](),_0x25dbcf['getUTCSeconds'](),_0x25dbcf[_0x3096f9(0x23a)]());_0x559868>=_0x4ce68c&&_0x559868<=_0x65c7cc&&(_0xa659c4[_0x3096f9(0x281)]=_0x4ce68c,_0xa659c4[_0x3096f9(0x23b)]=_0x65c7cc,_0x121740[_0x3096f9(0x242)](_0xa659c4));}return _0x121740;}async[a220_0x5de1ed(0x1c0)](_0x5c2a88){const _0x456ac7=a220_0x5de1ed,{endTime:_0x56dffc,limit:_0x44a56f,startTime:_0x2ff7df,userId:_0x2fdae2,tradeableId:_0x4f07bd}=_0x5c2a88;await this[_0x456ac7(0x29f)]['findOrThrow'](_0x4f07bd);if(_0x2fdae2)await this['userService'][_0x456ac7(0x269)](_0x2fdae2);if(_0x56dffc['getTime']()-_0x2ff7df[_0x456ac7(0x1f7)]()>0x18*0x3c*0x3c*0x3e8)throw new common_1[(_0x456ac7(0x1a8))](this['i18n']['t'](_0x456ac7(0x239)));let _0x40a3c6;try{_0x40a3c6=await this[_0x456ac7(0x299)][_0x456ac7(0x1ee)](),_0x40a3c6[_0x456ac7(0x232)]();const _0x381305=(await this[_0x456ac7(0x1b4)][_0x456ac7(0x28c)]([{'startTime':_0x2ff7df,'endTime':_0x56dffc,'limit':_0x44a56f,'user':_0x2fdae2,'tradeable':_0x4f07bd}],{'session':_0x40a3c6}))[0x0];if(_0x381305[_0x456ac7(0x281)]>=_0x381305['endTime'])throw new common_1[(_0x456ac7(0x1a8))](this['i18n']['t'](_0x456ac7(0x19a)));return await _0x40a3c6['commitTransaction'](),_0x381305;}catch(_0x411fcf){if(_0x40a3c6===null||_0x40a3c6===void 0x0?void 0x0:_0x40a3c6['inTransaction']())await _0x40a3c6[_0x456ac7(0x1e0)]();if(_0x411fcf[_0x456ac7(0x289)]>=0x190&&_0x411fcf['status']<0x1f4)throw _0x411fcf;this['logger'][_0x456ac7(0x283)](_0x456ac7(0x1fd)+_0x411fcf);throw new common_1[(_0x456ac7(0x279))]();}finally{if(_0x40a3c6)await _0x40a3c6[_0x456ac7(0x2ab)]();}}async[a220_0x5de1ed(0x1f0)](_0x8d48d4,_0x5b9e5b){const _0x1d5071=a220_0x5de1ed,{endTime:_0x165775,limit:_0x51a1a6,startTime:_0x14b54f,userId:_0x3b550e,tradeableId:_0x11a6d5}=_0x5b9e5b;await this[_0x1d5071(0x2b8)](_0x8d48d4),await this[_0x1d5071(0x29f)]['findOrThrow'](_0x11a6d5);if(_0x3b550e)await this[_0x1d5071(0x286)]['findOrThrow'](_0x3b550e);let _0x1a3323;try{_0x1a3323=await this[_0x1d5071(0x299)]['startSession'](),_0x1a3323[_0x1d5071(0x232)]();const _0xd90860=await this[_0x1d5071(0x1b4)][_0x1d5071(0x2c5)](_0x8d48d4,{'startTime':_0x14b54f,'endTime':_0x165775,'limit':_0x51a1a6,'user':_0x3b550e,'tradeable':_0x11a6d5},{'new':!![],'session':_0x1a3323});if(_0xd90860['startTime']>=_0xd90860[_0x1d5071(0x23b)])throw new common_1[(_0x1d5071(0x1a8))](this[_0x1d5071(0x1e5)]['t']('errors.tradeLimit.timeConflict'));return await _0x1a3323['commitTransaction'](),_0xd90860;}catch(_0x10db66){if(_0x1a3323===null||_0x1a3323===void 0x0?void 0x0:_0x1a3323[_0x1d5071(0x288)]())await _0x1a3323[_0x1d5071(0x1e0)]();if(_0x10db66['status']>=0x190&&_0x10db66[_0x1d5071(0x289)]<0x1f4)throw _0x10db66;this['logger'][_0x1d5071(0x283)](_0x1d5071(0x22a)+_0x10db66);throw new common_1[(_0x1d5071(0x279))]();}finally{if(_0x1a3323)await _0x1a3323[_0x1d5071(0x2ab)]();}}async[a220_0x5de1ed(0x293)](_0xdb51c0){const _0x1dd82b=a220_0x5de1ed,{limit:_0x1c5f74,skip:_0x159f8b,sortBy:_0x4d0a8d,sortOrder:_0x5b1129,userId:_0x459672,search:_0x724379}=_0xdb51c0,_0x51b84c={},_0x59c596={};_0x459672&&(await this[_0x1dd82b(0x286)][_0x1dd82b(0x269)](_0x459672),_0x51b84c[_0x1dd82b(0x261)]=new mongoose_2[(_0x1dd82b(0x1a6))]['ObjectId'](_0x459672));_0x724379&&(_0x51b84c[_0x1dd82b(0x26b)]=[{'user.mobileNumber':RegExp(_0x724379,'i')},{'user.firstName':RegExp(_0x724379,'i')},{'user.lastName':RegExp(_0x724379,'i')}]);if(_0x4d0a8d)_0x59c596[_0x4d0a8d]=_0x5b1129?0x1:-0x1;else _0x59c596[_0x1dd82b(0x20a)]=-0x1;const _0x59782e=await this[_0x1dd82b(0x1b4)][_0x1dd82b(0x262)]([{'$lookup':{'from':_0x1dd82b(0x221),'localField':_0x1dd82b(0x26c),'foreignField':'_id','as':_0x1dd82b(0x25d)}},{'$set':{'user._id':{'$first':_0x1dd82b(0x1c2)},'user.mobileNumber':{'$first':'$userArr.mobileNumber'},'user.firstName':{'$first':'$userArr.firstName'},'user.lastName':{'$first':_0x1dd82b(0x1f4)},'user.role':{'$first':_0x1dd82b(0x2ae)},'user.sex':{'$first':_0x1dd82b(0x252)},'user.verificationStatus':{'$first':_0x1dd82b(0x1f8)}}},{'$match':_0x51b84c},{'$lookup':{'from':_0x1dd82b(0x19b),'localField':'tradeable','foreignField':_0x1dd82b(0x287),'as':_0x1dd82b(0x1a7)}},{'$set':{'tradeable._id':{'$first':_0x1dd82b(0x1bd)},'tradeable.name':{'$first':'$tradeableArr.name'},'tradeable.nameFa':{'$first':_0x1dd82b(0x251)},'tradeable.image':{'$first':_0x1dd82b(0x2bf)}}},{'$unset':[_0x1dd82b(0x25d),_0x1dd82b(0x1a7)]},{'$sort':_0x59c596},{'$facet':{'data':[{'$skip':_0x159f8b},{'$limit':_0x1c5f74}],'count':[{'$count':_0x1dd82b(0x243)}]}},{'$set':{'count':{'$first':'$count.count'}}}]);return{'count':_0x59782e[0x0]['count'],'data':_0x59782e[0x0][_0x1dd82b(0x227)]};}async[a220_0x5de1ed(0x247)](_0xbbb23){const _0x1bb260=a220_0x5de1ed;await this[_0x1bb260(0x2b8)](_0xbbb23),await this[_0x1bb260(0x1b4)][_0x1bb260(0x27b)]({'_id':_0xbbb23});}async['findOrThrowUserFee'](_0x1c628a){const _0x54a064=a220_0x5de1ed,_0x4e1199=await this[_0x54a064(0x1a1)][_0x54a064(0x2be)](_0x1c628a)[_0x54a064(0x225)]();if(!_0x4e1199)throw new common_1['NotFoundException'](this['i18n']['t'](_0x54a064(0x2b5)));return _0x4e1199;}async[a220_0x5de1ed(0x1fc)](_0x3e4487){const _0x4467ad=a220_0x5de1ed,{userId:_0x59b643,tradeableId:_0x4e1d24,buyFee:_0x2805dd,sellFee:_0x2393e1,feeType:_0x11d49c}=_0x3e4487;await this['userService'][_0x4467ad(0x269)](_0x59b643),await this[_0x4467ad(0x29f)][_0x4467ad(0x269)](_0x4e1d24);try{const _0x582015=await this[_0x4467ad(0x1a1)][_0x4467ad(0x28c)]({'user':_0x59b643,'tradeable':_0x4e1d24,'buyFee':_0x2805dd,'sellFee':_0x2393e1,'feeType':_0x11d49c});return _0x582015;}catch(_0x1ee109){if(_0x1ee109[_0x4467ad(0x278)]===0x2af8)throw new common_1[(_0x4467ad(0x1a8))](this[_0x4467ad(0x1e5)]['t'](_0x4467ad(0x211)));this[_0x4467ad(0x24d)][_0x4467ad(0x283)]('Error\x20in\x20createUserFee:\x20'+_0x1ee109);throw new common_1[(_0x4467ad(0x279))]();}}async['getUserFees'](_0x311aee){const _0x35313c=a220_0x5de1ed,{userId:_0x4ac27a,skip:_0x518916,limit:_0x36e042,sortBy:_0x13d60c,sortOrder:_0x55931e}=_0x311aee,_0x40f1e5={};_0x4ac27a&&(await this['userService']['findOrThrow'](_0x4ac27a),_0x40f1e5[_0x35313c(0x26c)]=_0x4ac27a);const _0x46623d={};if(_0x13d60c)_0x46623d[_0x13d60c]=_0x55931e?0x1:-0x1;else _0x46623d[_0x35313c(0x20a)]=-0x1;const _0x1bb5c2=await this[_0x35313c(0x1a1)][_0x35313c(0x209)](_0x40f1e5)['sort'](_0x46623d)['skip'](_0x518916)['limit'](_0x36e042)[_0x35313c(0x1c3)]({'path':'user','select':_0x35313c(0x20e)})[_0x35313c(0x1c3)]({'path':_0x35313c(0x1df),'select':_0x35313c(0x28f)})['lean'](),_0x3a4539=await this[_0x35313c(0x1a1)][_0x35313c(0x27e)](_0x40f1e5);return{'count':_0x3a4539,'data':_0x1bb5c2};}async[a220_0x5de1ed(0x1d5)](_0xf57465,_0x5bafa5){const _0x2f2dd6=a220_0x5de1ed,{buyFee:_0x28c9cf,sellFee:_0x287835,feeType:_0xe9fd26}=_0x5bafa5;await this[_0x2f2dd6(0x24c)](_0xf57465);const _0xda9383=await this['userFeeModel']['findByIdAndUpdate'](_0xf57465,{'buyFee':_0x28c9cf,'sellFee':_0x287835,'feeType':_0xe9fd26},{'new':!![]});return _0xda9383;}async[a220_0x5de1ed(0x222)](_0x7e8c3a){const _0x40c4c5=a220_0x5de1ed;await this['findOrThrowUserFee'](_0x7e8c3a),await this['userFeeModel'][_0x40c4c5(0x27b)]({'_id':_0x7e8c3a});}async[a220_0x5de1ed(0x1f5)](_0x183982,_0x12d307,_0x441b46=undefined){const _0x5cb734=a220_0x5de1ed,_0x5b6f11=await this[_0x5cb734(0x1a1)]['findOne']({'user':_0x12d307,'tradeable':_0x183982});if(!_0x5b6f11)return;const {buyFee:_0x4722d1,sellFee:_0x8ac4e8,feeType:_0x46a055}=_0x5b6f11,_0x3a62c4=await this['tradeableService']['findOrThrow'](_0x183982);let _0x28ac5=_0x3a62c4[_0x5cb734(0x248)];if(_0x441b46)_0x28ac5=_0x441b46;let _0xffe6ea,_0x4eb0b0;return _0x46a055==amount_type_enum_1['AmountType'][_0x5cb734(0x272)]?(_0xffe6ea=Math['floor'](_0x28ac5*(_0x4722d1/0x64)),_0x4eb0b0=Math[_0x5cb734(0x1af)](_0x28ac5*(_0x8ac4e8/0x64))):(_0xffe6ea=_0x4722d1,_0x4eb0b0=_0x8ac4e8),{'tradeable':_0x3a62c4,'buyPrice':_0x28ac5+_0xffe6ea,'sellPrice':_0x28ac5-_0x4eb0b0,'buyWage':_0xffe6ea,'sellWage':_0x4eb0b0};}async[a220_0x5de1ed(0x2a2)](_0x41d59d){const _0x18ebec=a220_0x5de1ed;await this['userService'][_0x18ebec(0x269)](_0x41d59d);const _0x602114=await this[_0x18ebec(0x1a1)][_0x18ebec(0x209)]({'user':_0x41d59d})['populate']({'path':_0x18ebec(0x1df),'select':'\x0a\x20\x20\x20\x20\x20\x20\x20\x20_id\x0a\x20\x20\x20\x20\x20\x20\x20\x20name\x0a\x20\x20\x20\x20\x20\x20\x20\x20nameFa\x0a\x20\x20\x20\x20\x20\x20\x20\x20image\x0a\x20\x20\x20\x20\x20\x20\x20\x20minBuyAmount\x0a\x20\x20\x20\x20\x20\x20\x20\x20buyMaxDecimals\x0a\x20\x20\x20\x20\x20\x20\x20\x20minSellAmount\x0a\x20\x20\x20\x20\x20\x20\x20\x20sellMaxDecimals\x0a\x20\x20\x20\x20\x20\x20\x20\x20price\x0a\x20\x20\x20\x20\x20\x20\x20\x20transferMaxDecimals\x0a\x20\x20\x20\x20\x20\x20\x20\x20chartLink'}),_0x7b2ba6=[];for(const _0x4ba6e1 of _0x602114){const {tradeable:_0x1f24e3,buyFee:_0x2a3672,sellFee:_0x2281ba,feeType:_0x50e2c1}=_0x4ba6e1,_0x284bd2=_0x1f24e3['price'];let _0x4bcbd0=_0x2a3672,_0x1f3e54=_0x2281ba;_0x50e2c1==amount_type_enum_1['AmountType'][_0x18ebec(0x272)]&&(_0x4bcbd0=Math['floor'](_0x284bd2*(_0x2a3672/0x64)),_0x1f3e54=Math[_0x18ebec(0x1af)](_0x284bd2*(_0x2281ba/0x64))),_0x7b2ba6[_0x18ebec(0x242)]({'tradeable':_0x1f24e3,'buyPrice':_0x284bd2+_0x4bcbd0,'sellPrice':_0x284bd2-_0x1f3e54,'buyWage':_0x4bcbd0,'sellWage':_0x1f3e54});}return{'data':_0x7b2ba6};}};exports[a220_0x5de1ed(0x25c)]=TransactionService,__decorate([(0x0,schedule_1[a220_0x5de1ed(0x233)])(schedule_1[a220_0x5de1ed(0x1e8)][a220_0x5de1ed(0x2a4)]),__metadata('design:type',Function),__metadata('design:paramtypes',[]),__metadata(a220_0x5de1ed(0x1d4),Promise)],TransactionService[a220_0x5de1ed(0x1a5)],'updatePayLaterTransactions',null),__decorate([(0x0,schedule_1[a220_0x5de1ed(0x233)])(schedule_1[a220_0x5de1ed(0x1e8)][a220_0x5de1ed(0x1cd)]),__metadata(a220_0x5de1ed(0x1fe),Function),__metadata(a220_0x5de1ed(0x1c6),[]),__metadata('design:returntype',Promise)],TransactionService[a220_0x5de1ed(0x1a5)],a220_0x5de1ed(0x1d8),null),__decorate([(0x0,schedule_1[a220_0x5de1ed(0x233)])(a220_0x5de1ed(0x249)),__metadata('design:type',Function),__metadata(a220_0x5de1ed(0x1c6),[]),__metadata('design:returntype',Promise)],TransactionService['prototype'],a220_0x5de1ed(0x1db),null),exports['TransactionService']=TransactionService=TransactionService_1=__decorate([(0x0,common_1[a220_0x5de1ed(0x246)])(),__param(0x0,(0x0,mongoose_1['InjectModel'])(transaction_schema_1[a220_0x5de1ed(0x1f2)][a220_0x5de1ed(0x205)])),__param(0x1,(0x0,mongoose_1[a220_0x5de1ed(0x1fb)])(trade_limit_schema_1[a220_0x5de1ed(0x2ad)][a220_0x5de1ed(0x205)])),__param(0x2,(0x0,mongoose_1[a220_0x5de1ed(0x1fb)])(transaction_report_schema_1['TransactionReport'][a220_0x5de1ed(0x205)])),__param(0x3,(0x0,mongoose_1[a220_0x5de1ed(0x1fb)])(user_fee_schema_1['UserFee']['name'])),__param(0x4,(0x0,common_1[a220_0x5de1ed(0x2b7)])((0x0,common_1[a220_0x5de1ed(0x203)])(()=>user_service_1[a220_0x5de1ed(0x28d)]))),__param(0x7,(0x0,common_1[a220_0x5de1ed(0x2b7)])((0x0,common_1[a220_0x5de1ed(0x203)])(()=>level_service_1['LevelService']))),__param(0x8,(0x0,common_1[a220_0x5de1ed(0x2b7)])((0x0,common_1[a220_0x5de1ed(0x203)])(()=>tradeable_service_1[a220_0x5de1ed(0x1b7)]))),__param(0xb,(0x0,mongoose_1[a220_0x5de1ed(0x234)])()),__metadata(a220_0x5de1ed(0x1c6),[mongoose_2['Model'],mongoose_2['Model'],mongoose_2[a220_0x5de1ed(0x210)],mongoose_2['Model'],user_service_1[a220_0x5de1ed(0x28d)],settings_service_1[a220_0x5de1ed(0x216)],nestjs_i18n_1[a220_0x5de1ed(0x28a)],level_service_1[a220_0x5de1ed(0x23d)],tradeable_service_1[a220_0x5de1ed(0x1b7)],config_1['ConfigService'],external_apis_service_1[a220_0x5de1ed(0x282)],mongoose_2[a220_0x5de1ed(0x2a7)]])],TransactionService);function a220_0x51b6(_0x588bbc,_0x4d7be9){const _0x1cee53=a220_0x1cee();return a220_0x51b6=function(_0x51b613,_0x5e5958){_0x51b613=_0x51b613-0x199;let _0x52d0fb=_0x1cee53[_0x51b613];return _0x52d0fb;},a220_0x51b6(_0x588bbc,_0x4d7be9);}function a220_0x1cee(){const _0x154f16=['updateUsersLevelBasedOnTradeAmount','errors.tradeLimit.timeDifference','getUTCMilliseconds','endTime','metadata','LevelService','TransactionType','levelService','object','createFixedPriceTransaction','push','count','add','referrer','Injectable','deleteTradeLimit','price','2-59/5\x20*\x20*\x20*\x20*','errors.transaction.lessThanMinTradeableAmount','errors.transaction.priceCannotBeEmpty','findOrThrowUserFee','logger','verifyTransaction','sort','createTransReport','$tradeableArr.nameFa','$userArr.sex','getOwnPropertyDescriptor','Error\x20in\x20createPayLaterBuy:\x20','collation','decTradeableStock','toDate','calcOwnerProfit','errors.transaction.priceMismatch','__importStar','Error\x20in\x20verifyTransaction:\x20','TransactionService','userArr','role','incUserInv','catch','user._id','aggregate','1080184lzPLzH','../external-apis/external-apis.service','hours','Error\x20in\x20updatePayLaterTransactions:\x20','FILES_PATH','فروش','findOrThrow','Status','$or','user','getWallgoldPrice','UPLOAD_DIR','decorate','AffiliateMarketing','291474OLlLXl','Percent','hour','NotFoundException','startOf','$total','function','code','InternalServerErrorException','moment','findOneAndDelete','orderId','calcAndValidateTransFields','countDocuments','nestjs-i18n','../user/schema/user.schema','startTime','ExternalApisService','error','634506kdJZMG','Pending','userService','_id','inTransaction','status','I18nService','__setModuleDefault','create','UserService','errors.transaction.reportTimeConflict','\x0a\x20\x20\x20\x20\x20\x20\x20\x20_id\x0a\x20\x20\x20\x20\x20\x20\x20\x20name\x0a\x20\x20\x20\x20\x20\x20\x20\x20nameFa\x0a\x20\x20\x20\x20\x20\x20\x20\x20image','createPayLaterBuy','../user/schema/balance-log.schema','checkTotalDailyTrades','getLimits','$userArr.mobileNumber','onModuleInit','settingsService','level','../common/status.enum','connection','getTradeLimits','$user.firstName','limit','$tradeablePrice','validatePayLaterBuyCreateInput','tradeableService','__esModule','../level/level.service','getPricesForUser','$wage','EVERY_MINUTE','errors.transaction.moreThanTradeLimit','decreaseBalance','Connection','errors.user.notVerified','Logger','getUTCDate','endSession','@nestjs/mongoose','TradeLimit','$userArr.role','Accepted','2120lpWMcQ','16UHCVKc','Pending\x20PayLater\x20transactions\x20that\x20have\x20reached\x20their\x20deadline\x20are\x20rejected.','log','getPendingPayLaterTransactionsAmount','errors.userFee.notFound','finishPayLaterBuy','Inject','findOrThrowTradeLimit','\x20!==\x20','referrerRewardPercent','Error\x20in\x20finishPayLaterBuy:\x20','Error\x20in\x20createTransaction:\x20','Buy','findById','$tradeableArr.image','../common/utils','@nestjs/config','Sheet1','BalanceLogAction','$amount','findByIdAndUpdate','428PcaOgL','Rejected','TransactionStatus','cancelTransaction','errors.tradeLimit.timeConflict','tradeables','utils','commitTransaction','errors.transaction.payLaterBuyNotAllowed','/report/','isFloatingPointCorrect','userFeeModel','$type','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20-_id\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20name\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20nameFa','length','prototype','Types','tradeableArr','BadRequestException','get','$user.lastName','PendingFixedPrice','952604UOtvMl','assign','configurable','floor','updatedAt','checkUserTradeLimits','transactionsCountReport','Error\x20updating\x20user\x20level:\x20','tradeLimitModel','verificationStatus','getUTCSeconds','TradeableService','ObjectId','hasOwnProperty','getUTCHours','ServiceUnavailableException','Error\x20in\x20cancelTransaction:\x20','$tradeableArr._id','setUTCDate','setUTCHours','createTradeLimit','__importDefault','$userArr._id','populate','getTotalTradesPrice','errors.tradeLimit.moreThanLimit','design:paramtypes','getTradeablePriceForLevel','incTradeableStock','errors.transaction.moreThanMaxDecimalPlaces','Role','1092580KmdsIW','defineProperty','EVERY_5_MINUTES','toString','errors.tradeLimit.notFound','../common/amount-type.enum','getTransactionReports','findAll','Database\x20price\x20mismatch:\x20','design:returntype','updateUserFee','PayLaterBuy','generateReportFile','confirmPendingBuyTransactions','book_append_sheet','The\x20scalpingPreventionPeriodInHours\x20field\x20in\x20settings\x20has\x20not\x20been\x20set\x20yet.','updateFixedPriceTransactions','payAffiliateReward','save','$count.count','tradeable','abortTransaction','createExcelFromObjects','__createBinding','$user','__param','i18n','updatePayLaterTransactions','writable','CronExpression','hex','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20_id\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20tradeable\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20type\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20amount\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20wage\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20total\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20tradeablePrice\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20status\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20confirmDescription\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20createdAt\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20updatedAt','.xlsx','transReportModel','User','startSession','type','updateTradeLimit','errors.transaction.fixedPriceTransactionsAreNotAllowed','Transaction','Error\x20with\x20confirming\x20transaction\x20','$userArr.lastName','getTradeablePriceForUser','@nestjs/schedule','getTime','$userArr.verificationStatus','errors.transaction.lessThanTradeLimit','errors.transaction.notPaidYet','InjectModel','createUserFee','Error\x20in\x20createTradeLimit:\x20','design:type','totalAmount','5lCYgzF','__decorate','$createdAt','forwardRef','transactionModel','name','totalWage','$status','days','find','createdAt','configService','buy','خرید','\x0a\x20\x20\x20\x20\x20\x20\x20\x20_id\x0a\x20\x20\x20\x20\x20\x20\x20\x20mobileNumber\x0a\x20\x20\x20\x20\x20\x20\x20\x20firstName\x0a\x20\x20\x20\x20\x20\x20\x20\x20lastName\x0a\x20\x20\x20\x20\x20\x20\x20\x20role\x0a\x20\x20\x20\x20\x20\x20\x20\x20sex\x0a\x20\x20\x20\x20\x20\x20\x20\x20verificationStatus','createWallgoldOrder','Model','errors.userFee.alreadyExists','randomBytes','book_new','mongoose','Cancelled','SettingsService','errors.transaction.notFound','increaseBalance','$userArr.firstName','settings','./schema/transaction.schema','Error\x20in\x20updateFixedPriceTransactions:\x20','Tradeable\x20wages\x20are\x20not\x20defined\x20in\x20level:\x20','BuyTransactionRejection','BuyTransaction','SellTransaction','users','deleteUserFee','default','isInteger','lean','skip','data','$user.mobileNumber','getUTCMinutes','Error\x20in\x20updateTradeLimit:\x20','VIPUser','referrer\x20level','VerificationStatus','externalApisService','errors.transaction.cantChangeStatus','7122852DFHSRP','total','startTransaction','Cron','InjectConnection','xlsx','decUserInv','warn'];a220_0x1cee=function(){return _0x154f16;};return a220_0x1cee();}