'use strict';const a5_0x3f7a64=a5_0x1e84;function a5_0x1e84(_0x36cec5,_0x16c1a8){const _0x167978=a5_0x1679();return a5_0x1e84=function(_0x1e848c,_0xfb2f87){_0x1e848c=_0x1e848c-0x190;let _0xa6e437=_0x167978[_0x1e848c];return _0xa6e437;},a5_0x1e84(_0x36cec5,_0x16c1a8);}(function(_0x320bf3,_0x5ee5fe){const _0x9ad71b=a5_0x1e84,_0x32b9b8=_0x320bf3();while(!![]){try{const _0x4f6442=parseInt(_0x9ad71b(0x1b9))/0x1+parseInt(_0x9ad71b(0x1a0))/0x2+-parseInt(_0x9ad71b(0x1b5))/0x3+parseInt(_0x9ad71b(0x1b6))/0x4+-parseInt(_0x9ad71b(0x1e8))/0x5+-parseInt(_0x9ad71b(0x1f2))/0x6+parseInt(_0x9ad71b(0x1c7))/0x7*(parseInt(_0x9ad71b(0x1e2))/0x8);if(_0x4f6442===_0x5ee5fe)break;else _0x32b9b8['push'](_0x32b9b8['shift']());}catch(_0x134ad0){_0x32b9b8['push'](_0x32b9b8['shift']());}}}(a5_0x1679,0x4c97a));var __createBinding=this&&this['__createBinding']||(Object[a5_0x3f7a64(0x1ec)]?function(_0x390da0,_0x29f948,_0x1cb27b,_0x153e9e){const _0x5a68bf=a5_0x3f7a64;if(_0x153e9e===undefined)_0x153e9e=_0x1cb27b;var _0x142b11=Object[_0x5a68bf(0x1b2)](_0x29f948,_0x1cb27b);(!_0x142b11||(_0x5a68bf(0x1dd)in _0x142b11?!_0x29f948[_0x5a68bf(0x1ba)]:_0x142b11[_0x5a68bf(0x1e7)]||_0x142b11[_0x5a68bf(0x1cb)]))&&(_0x142b11={'enumerable':!![],'get':function(){return _0x29f948[_0x1cb27b];}}),Object['defineProperty'](_0x390da0,_0x153e9e,_0x142b11);}:function(_0x363437,_0xdc7125,_0x58dad2,_0x42a825){if(_0x42a825===undefined)_0x42a825=_0x58dad2;_0x363437[_0x42a825]=_0xdc7125[_0x58dad2];}),__setModuleDefault=this&&this[a5_0x3f7a64(0x1aa)]||(Object[a5_0x3f7a64(0x1ec)]?function(_0xaebb76,_0x104bfb){const _0x44a486=a5_0x3f7a64;Object[_0x44a486(0x1d9)](_0xaebb76,_0x44a486(0x1a4),{'enumerable':!![],'value':_0x104bfb});}:function(_0x4806eb,_0x13f89d){const _0x34f5db=a5_0x3f7a64;_0x4806eb[_0x34f5db(0x1a4)]=_0x13f89d;}),__decorate=this&&this[a5_0x3f7a64(0x1a5)]||function(_0x21035b,_0x1f5952,_0xe71b1d,_0x1df0a5){const _0x4611ee=a5_0x3f7a64;var _0x24f29a=arguments[_0x4611ee(0x1b8)],_0x2ca128=_0x24f29a<0x3?_0x1f5952:_0x1df0a5===null?_0x1df0a5=Object[_0x4611ee(0x1b2)](_0x1f5952,_0xe71b1d):_0x1df0a5,_0x121710;if(typeof Reflect===_0x4611ee(0x1ac)&&typeof Reflect[_0x4611ee(0x1ee)]==='function')_0x2ca128=Reflect[_0x4611ee(0x1ee)](_0x21035b,_0x1f5952,_0xe71b1d,_0x1df0a5);else{for(var _0x1176a6=_0x21035b[_0x4611ee(0x1b8)]-0x1;_0x1176a6>=0x0;_0x1176a6--)if(_0x121710=_0x21035b[_0x1176a6])_0x2ca128=(_0x24f29a<0x3?_0x121710(_0x2ca128):_0x24f29a>0x3?_0x121710(_0x1f5952,_0xe71b1d,_0x2ca128):_0x121710(_0x1f5952,_0xe71b1d))||_0x2ca128;}return _0x24f29a>0x3&&_0x2ca128&&Object[_0x4611ee(0x1d9)](_0x1f5952,_0xe71b1d,_0x2ca128),_0x2ca128;},__importStar=this&&this[a5_0x3f7a64(0x1e4)]||(function(){var _0x3add41=function(_0x420cc6){return _0x3add41=Object['getOwnPropertyNames']||function(_0x187971){const _0x56a138=a5_0x1e84;var _0x36b79b=[];for(var _0x39b861 in _0x187971)if(Object[_0x56a138(0x1ca)][_0x56a138(0x1ab)][_0x56a138(0x1d6)](_0x187971,_0x39b861))_0x36b79b[_0x36b79b[_0x56a138(0x1b8)]]=_0x39b861;return _0x36b79b;},_0x3add41(_0x420cc6);};return function(_0xaf5791){const _0x241d2d=a5_0x1e84;if(_0xaf5791&&_0xaf5791['__esModule'])return _0xaf5791;var _0xe71f00={};if(_0xaf5791!=null){for(var _0x3158ca=_0x3add41(_0xaf5791),_0x55c1a0=0x0;_0x55c1a0<_0x3158ca['length'];_0x55c1a0++)if(_0x3158ca[_0x55c1a0]!==_0x241d2d(0x1a4))__createBinding(_0xe71f00,_0xaf5791,_0x3158ca[_0x55c1a0]);}return __setModuleDefault(_0xe71f00,_0xaf5791),_0xe71f00;};}()),__metadata=this&&this[a5_0x3f7a64(0x1cf)]||function(_0x1d8664,_0x27b7ac){const _0x119666=a5_0x3f7a64;if(typeof Reflect===_0x119666(0x1ac)&&typeof Reflect[_0x119666(0x191)]===_0x119666(0x1e3))return Reflect[_0x119666(0x191)](_0x1d8664,_0x27b7ac);},AuthService_1;Object['defineProperty'](exports,a5_0x3f7a64(0x1ba),{'value':!![]}),exports[a5_0x3f7a64(0x1c9)]=void 0x0;function a5_0x1679(){const _0x5182ec=['errors.auth.newUniquePassword','otpLogin','__setModuleDefault','hasOwnProperty','object','I18nService','UnauthorizedException','ExternalApisService','floor','@nestjs/jwt','getOwnPropertyDescriptor','generateTokens','BadRequestException','1749678qqhpia','188904wTTlra','verificationCodeExpiryDate','length','477426ksYHSH','__esModule','i18n','errors.user.isNotActive','findOrThrow','Admin','UserService','removeVerificationCode','User','verificationCode','../user/schema/user.schema','Injectable','configService','VIPUser','1602881HedsmV','Logger','AuthService','prototype','configurable','Role','isFirstLoginDone','JWT_ACCESS_EXPIRY','__metadata','nestjs-i18n','update','errors.user.notFound','setMinutes','JWT_REFRESH_EXPIRY','errors.auth.wrongCode','call','bcryptjs','findByMobileNumber','defineProperty','logger','compare','JWT_ACCESS_SECRET','get','onModuleInit','@nestjs/common','password','SuperAdmin','32Mcmaym','function','__importStar','getTime','referrer','writable','2691725OSdIof','refreshToken','@nestjs/config','generateRandomNumber','create','generateAccessToken','decorate','findByReferralCode','isActive','logout','858096OKCVUh','signAsync','_id','errors.auth.wrongPassword','metadata','sendLookupSms','otpVerify','externalApisService','refreshTokens','generateRefreshToken','createDefaultAdmin','userService','../common/utils','design:paramtypes','role','register','NotFoundException','jwtService','name','275450ULFZQU','errors.user.referralCodeNotFound','updateRefreshToken','ConfigService','default','__decorate','../user/user.service','getMinutes'];a5_0x1679=function(){return _0x5182ec;};return a5_0x1679();}const common_1=require(a5_0x3f7a64(0x1df)),config_1=require(a5_0x3f7a64(0x1ea)),jwt_1=require(a5_0x3f7a64(0x1b1)),bcrypt=__importStar(require(a5_0x3f7a64(0x1d7))),nestjs_i18n_1=require(a5_0x3f7a64(0x1d0)),utils_1=require(a5_0x3f7a64(0x199)),external_apis_service_1=require('../external-apis/external-apis.service'),user_schema_1=require(a5_0x3f7a64(0x1c3)),user_service_1=require(a5_0x3f7a64(0x1a6));let AuthService=AuthService_1=class AuthService{constructor(_0x3d74b7,_0x3b3b8a,_0x1c7684,_0xd82c7c,_0x140b5c){const _0x50a1c5=a5_0x3f7a64;this[_0x50a1c5(0x198)]=_0x3d74b7,this['jwtService']=_0x3b3b8a,this[_0x50a1c5(0x1c5)]=_0x1c7684,this[_0x50a1c5(0x1bb)]=_0xd82c7c,this['externalApisService']=_0x140b5c,this[_0x50a1c5(0x1da)]=new common_1[(_0x50a1c5(0x1c8))](AuthService_1[_0x50a1c5(0x19f)]);}async[a5_0x3f7a64(0x1de)](){const _0x5c22c2=a5_0x3f7a64;await this[_0x5c22c2(0x198)][_0x5c22c2(0x197)]();}[a5_0x3f7a64(0x1ed)](_0x59bb6d){const _0x1eecb5=a5_0x3f7a64,_0x454d33={'sub':_0x59bb6d['_id'],'role':_0x59bb6d['role']};return this[_0x1eecb5(0x19e)][_0x1eecb5(0x1f3)](_0x454d33,{'secret':this[_0x1eecb5(0x1c5)][_0x1eecb5(0x1dd)](_0x1eecb5(0x1dc)),'expiresIn':this[_0x1eecb5(0x1c5)][_0x1eecb5(0x1dd)](_0x1eecb5(0x1ce))});}[a5_0x3f7a64(0x196)](_0x4969f6){const _0x15bb47=a5_0x3f7a64,_0x1f9e99={'sub':_0x4969f6[_0x15bb47(0x1f4)],'role':_0x4969f6[_0x15bb47(0x19b)]};return this[_0x15bb47(0x19e)]['signAsync'](_0x1f9e99,{'secret':this[_0x15bb47(0x1c5)][_0x15bb47(0x1dd)]('JWT_REFRESH_SECRET'),'expiresIn':this[_0x15bb47(0x1c5)]['get'](_0x15bb47(0x1d4))});}async[a5_0x3f7a64(0x1a2)](_0x462fba,_0x22f100){await this['userService']['update'](_0x462fba,{'refreshToken':_0x22f100});}async['generateTokens'](_0x5c34e9){const _0x4f8c11=a5_0x3f7a64,[_0x5d81b2,_0x3f9eaf]=await Promise['all']([this[_0x4f8c11(0x1ed)](_0x5c34e9),this['generateRefreshToken'](_0x5c34e9)]);return await this['updateRefreshToken'](_0x5c34e9[_0x4f8c11(0x1f4)],_0x3f9eaf),{'access_token':_0x5d81b2,'refresh_token':_0x3f9eaf};}async[a5_0x3f7a64(0x19c)](_0x4c4817){const _0x26bde8=a5_0x3f7a64,_0xf4a923=await this[_0x26bde8(0x198)][_0x26bde8(0x1d8)](_0x4c4817,[user_schema_1[_0x26bde8(0x1cc)][_0x26bde8(0x1c1)],user_schema_1[_0x26bde8(0x1cc)][_0x26bde8(0x1c6)]]),_0x4147e7=(0x0,utils_1[_0x26bde8(0x1eb)])(0x6),_0xcf329d=new Date();_0xcf329d[_0x26bde8(0x1d3)](_0xcf329d[_0x26bde8(0x1a7)]()+0x2);let _0x3e8dfe=![],_0x4ed554=![];if(!_0xf4a923)await this[_0x26bde8(0x198)]['createUser']({'mobileNumber':_0x4c4817,'verificationCode':_0x4147e7,'verificationCodeExpiryDate':_0xcf329d}),await this[_0x26bde8(0x194)][_0x26bde8(0x192)](_0x4c4817,String(_0x4147e7));else{const _0x337fac=new Date(),_0x1d98cb=_0xf4a923[_0x26bde8(0x1b7)];if(_0x1d98cb&&_0x1d98cb>_0x337fac){const _0x4b482e=Math[_0x26bde8(0x1b0)]((_0x1d98cb['getTime']()-_0x337fac[_0x26bde8(0x1e5)]())/0x3e8);throw new common_1['BadRequestException'](this[_0x26bde8(0x1bb)]['t']('errors.auth.otpTimeout',{'args':{'remainingTime':_0x4b482e}}));}_0xf4a923[_0x26bde8(0x1e0)]?_0x3e8dfe=!![]:(await this[_0x26bde8(0x198)][_0x26bde8(0x1d1)](_0xf4a923[_0x26bde8(0x1f4)],{'verificationCode':_0x4147e7,'verificationCodeExpiryDate':_0xcf329d}),await this[_0x26bde8(0x194)][_0x26bde8(0x192)](_0x4c4817,String(_0x4147e7))),_0x4ed554=_0xf4a923['isFirstLoginDone'];}return{'canLoginWithPassword':_0x3e8dfe,'isFirstLoginDone':_0x4ed554};}async[a5_0x3f7a64(0x1a9)](_0x4ee949,_0x118247=![]){const _0x1864d9=a5_0x3f7a64;let _0x352365;if(_0x118247)_0x352365=await this[_0x1864d9(0x198)]['findByMobileNumber'](_0x4ee949,[user_schema_1[_0x1864d9(0x1cc)][_0x1864d9(0x1e1)],user_schema_1[_0x1864d9(0x1cc)][_0x1864d9(0x1be)]]);else _0x352365=await this[_0x1864d9(0x198)][_0x1864d9(0x1d8)](_0x4ee949,[user_schema_1[_0x1864d9(0x1cc)][_0x1864d9(0x1c1)],user_schema_1[_0x1864d9(0x1cc)][_0x1864d9(0x1c6)]]);if(_0x352365){const _0x3a789c=(0x0,utils_1[_0x1864d9(0x1eb)])(0x6),_0x21e3f7=new Date();_0x21e3f7[_0x1864d9(0x1d3)](_0x21e3f7[_0x1864d9(0x1a7)]()+0x2),await this[_0x1864d9(0x198)][_0x1864d9(0x1d1)](_0x352365['_id'],{'verificationCode':_0x3a789c,'verificationCodeExpiryDate':_0x21e3f7}),await this[_0x1864d9(0x194)][_0x1864d9(0x192)](_0x4ee949,String(_0x3a789c));}else throw new common_1[(_0x1864d9(0x19d))](this[_0x1864d9(0x1bb)]['t'](_0x1864d9(0x1d2)));}async[a5_0x3f7a64(0x193)](_0x51e803,_0x2d22e7=![]){const _0x57e26b=a5_0x3f7a64,{code:_0x4feb0b,mobileNumber:_0x591af8,referralCode:_0x3bb4a0}=_0x51e803;let _0x56f005;if(_0x2d22e7)_0x56f005=await this[_0x57e26b(0x198)][_0x57e26b(0x1d8)](_0x591af8,[user_schema_1[_0x57e26b(0x1cc)][_0x57e26b(0x1e1)],user_schema_1[_0x57e26b(0x1cc)][_0x57e26b(0x1be)]]);else _0x56f005=await this[_0x57e26b(0x198)][_0x57e26b(0x1d8)](_0x591af8,[user_schema_1['Role']['User'],user_schema_1['Role'][_0x57e26b(0x1c6)]]);if(!_0x56f005)throw new common_1[(_0x57e26b(0x19d))](this['i18n']['t'](_0x57e26b(0x1d2)));let _0x45b973;if(!_0x2d22e7&&!_0x56f005[_0x57e26b(0x1f0)])_0x45b973=new common_1[(_0x57e26b(0x1b4))](this['i18n']['t'](_0x57e26b(0x1bc)));new Date()>_0x56f005[_0x57e26b(0x1b7)]&&(_0x45b973=new common_1[(_0x57e26b(0x1b4))](this[_0x57e26b(0x1bb)]['t']('errors.auth.expiredCode')));if(_0x45b973){await this[_0x57e26b(0x198)][_0x57e26b(0x1c0)](_0x56f005['_id']);throw _0x45b973;}if(_0x56f005[_0x57e26b(0x1c2)]!==_0x4feb0b)throw new common_1[(_0x57e26b(0x1b4))](this[_0x57e26b(0x1bb)]['t'](_0x57e26b(0x1d5)));if(!_0x2d22e7){const _0x451d2f={'verificationCode':null,'verificationCodeExpiryDate':null,'isFirstLoginDone':!![]};if(!_0x56f005[_0x57e26b(0x1cd)]){if(_0x3bb4a0){const _0x5af930=await this['userService'][_0x57e26b(0x1ef)](_0x3bb4a0);if(!_0x5af930)throw new common_1[(_0x57e26b(0x1b4))](this[_0x57e26b(0x1bb)]['t'](_0x57e26b(0x1a1)));_0x451d2f[_0x57e26b(0x1e6)]=_0x5af930['_id'];}}await this[_0x57e26b(0x198)][_0x57e26b(0x1d1)](_0x56f005[_0x57e26b(0x1f4)],_0x451d2f);}else await this[_0x57e26b(0x198)][_0x57e26b(0x1c0)](_0x56f005[_0x57e26b(0x1f4)]);return this[_0x57e26b(0x1b3)](_0x56f005);}async['passwordLogin'](_0x49ea02,_0x2f2e45=![]){const _0x3f571f=a5_0x3f7a64,{password:_0x4e992f,mobileNumber:_0x2e767a}=_0x49ea02;let _0x251517;if(_0x2f2e45)_0x251517=await this[_0x3f571f(0x198)][_0x3f571f(0x1d8)](_0x2e767a,[user_schema_1['Role'][_0x3f571f(0x1e1)],user_schema_1[_0x3f571f(0x1cc)][_0x3f571f(0x1be)],user_schema_1[_0x3f571f(0x1cc)]['ExtConsumer']]);else _0x251517=await this[_0x3f571f(0x198)][_0x3f571f(0x1d8)](_0x2e767a,[user_schema_1[_0x3f571f(0x1cc)][_0x3f571f(0x1c1)],user_schema_1['Role']['VIPUser']]);if(!_0x251517)throw new common_1['NotFoundException'](this[_0x3f571f(0x1bb)]['t'](_0x3f571f(0x1d2)));if(_0x251517['role']!==user_schema_1[_0x3f571f(0x1cc)][_0x3f571f(0x1e1)]&&!_0x251517['isActive'])throw new common_1[(_0x3f571f(0x1b4))](this[_0x3f571f(0x1bb)]['t']('errors.user.isNotActive'));if(!_0x251517[_0x3f571f(0x1e0)]||!await bcrypt['compare'](_0x4e992f,_0x251517['password']))throw new common_1[(_0x3f571f(0x1b4))](this[_0x3f571f(0x1bb)]['t'](_0x3f571f(0x190)));return this['generateTokens'](_0x251517);}async[a5_0x3f7a64(0x1f1)](_0x4652a8){await this['updateRefreshToken'](_0x4652a8,null);}async[a5_0x3f7a64(0x195)](_0x94319b,_0x140224){const _0x457396=a5_0x3f7a64,_0x305a4b=await this[_0x457396(0x198)][_0x457396(0x1bd)](_0x94319b);if(!_0x305a4b['refreshToken'])throw new common_1['NotFoundException'](this[_0x457396(0x1bb)]['t']('errors.user.notFound'));if(_0x140224!==_0x305a4b[_0x457396(0x1e9)])throw new common_1[(_0x457396(0x1ae))]();return this['generateTokens'](_0x305a4b);}async['changePassword'](_0x329a0a,_0x1b4458){const _0x6ac96d=a5_0x3f7a64,_0x30d3c5=await this[_0x6ac96d(0x198)][_0x6ac96d(0x1bd)](_0x329a0a);if(_0x30d3c5[_0x6ac96d(0x1e0)]&&await bcrypt[_0x6ac96d(0x1db)](_0x1b4458,_0x30d3c5[_0x6ac96d(0x1e0)]))throw new common_1[(_0x6ac96d(0x1b4))](this['i18n']['t'](_0x6ac96d(0x1a8)));await this['userService'][_0x6ac96d(0x1d1)](_0x30d3c5['_id'],{'password':_0x1b4458});}};exports[a5_0x3f7a64(0x1c9)]=AuthService,exports[a5_0x3f7a64(0x1c9)]=AuthService=AuthService_1=__decorate([(0x0,common_1[a5_0x3f7a64(0x1c4)])(),__metadata(a5_0x3f7a64(0x19a),[user_service_1[a5_0x3f7a64(0x1bf)],jwt_1['JwtService'],config_1[a5_0x3f7a64(0x1a3)],nestjs_i18n_1[a5_0x3f7a64(0x1ad)],external_apis_service_1[a5_0x3f7a64(0x1af)]])],AuthService);