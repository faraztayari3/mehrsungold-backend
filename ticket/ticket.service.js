'use strict';const a176_0x4c9b5d=a176_0x2f96;(function(_0xacc27d,_0x3b204d){const _0x43a43b=a176_0x2f96,_0x57a759=_0xacc27d();while(!![]){try{const _0x2b15e8=-parseInt(_0x43a43b(0x1da))/0x1+-parseInt(_0x43a43b(0x1c4))/0x2+-parseInt(_0x43a43b(0x1ab))/0x3*(parseInt(_0x43a43b(0x1be))/0x4)+parseInt(_0x43a43b(0x1a0))/0x5+-parseInt(_0x43a43b(0x1d6))/0x6+-parseInt(_0x43a43b(0x1e1))/0x7*(-parseInt(_0x43a43b(0x1a7))/0x8)+parseInt(_0x43a43b(0x1e0))/0x9;if(_0x2b15e8===_0x3b204d)break;else _0x57a759['push'](_0x57a759['shift']());}catch(_0x592c8a){_0x57a759['push'](_0x57a759['shift']());}}}(a176_0x2eae,0x4b966));function a176_0x2f96(_0x2ac0eb,_0x53e5ce){const _0x2eae0b=a176_0x2eae();return a176_0x2f96=function(_0x2f96ea,_0xf82d50){_0x2f96ea=_0x2f96ea-0x1a0;let _0x23a045=_0x2eae0b[_0x2f96ea];return _0x23a045;},a176_0x2f96(_0x2ac0eb,_0x53e5ce);}function a176_0x2eae(){const _0x281ba1=['lean','design:paramtypes','findById','Role','getChatMessages','../user/user.service','Injectable','hasNewMessageForAdmin','628oWLJDN','InjectModel','userArr','errors.ticket.notActive','UserTypes','sender','1212208nAnPLq','messages','getTickets','count','ObjectId','@nestjs/common','createMessage','_id','Model','create','__metadata','isActive','function','findOrThrow','abortTransaction','InjectConnection','errors.ticket.notFound','decorate','2600112loPdyr','getOwnPropertyDescriptor','user','findByIdAndUpdate','257185HeQFLF','Error\x20in\x20creating\x20ticket:\x20','inTransaction','startTransaction','chatModel','role','14681601YGRUra','21pFyspN','connection','skip','user._id','Logger','limit','User','countDocuments','length','ChatMessage','hasNewMessageForUser','Types','userService','Admin','Error\x20in\x20createMessage:\x20','object','users','Connection','SuperAdmin','deactivateTicket','i18n','metadata','data','VIPUser','$userArr.sex','name','nestjs-i18n','NotFoundException','$userArr.role','__param','populate','logger','mongoose','includes','$userArr.mobileNumber','$userArr._id','249095GjBDJw','error','find','$messages','sort','@nestjs/mongoose','./schema/chat-message.schema','1151408dqLfbJ','./schema/ticket.schema','InternalServerErrorException','ticket','9681pKbTRd','__decorate','TicketService','chatmessages','startSession','ticketModel','defineProperty','endSession','$userArr.firstName','../user/schema/user.schema','$userArr.lastName'];a176_0x2eae=function(){return _0x281ba1;};return a176_0x2eae();}var __decorate=this&&this[a176_0x4c9b5d(0x1ac)]||function(_0x73e3df,_0x3e143b,_0x4e05c8,_0x56f2d9){const _0x4e01aa=a176_0x4c9b5d;var _0x365971=arguments[_0x4e01aa(0x1e9)],_0x56c419=_0x365971<0x3?_0x3e143b:_0x56f2d9===null?_0x56f2d9=Object[_0x4e01aa(0x1d7)](_0x3e143b,_0x4e05c8):_0x56f2d9,_0x306b93;if(typeof Reflect===_0x4e01aa(0x1f0)&&typeof Reflect['decorate']==='function')_0x56c419=Reflect[_0x4e01aa(0x1d5)](_0x73e3df,_0x3e143b,_0x4e05c8,_0x56f2d9);else{for(var _0x1ce4ff=_0x73e3df[_0x4e01aa(0x1e9)]-0x1;_0x1ce4ff>=0x0;_0x1ce4ff--)if(_0x306b93=_0x73e3df[_0x1ce4ff])_0x56c419=(_0x365971<0x3?_0x306b93(_0x56c419):_0x365971>0x3?_0x306b93(_0x3e143b,_0x4e05c8,_0x56c419):_0x306b93(_0x3e143b,_0x4e05c8))||_0x56c419;}return _0x365971>0x3&&_0x56c419&&Object['defineProperty'](_0x3e143b,_0x4e05c8,_0x56c419),_0x56c419;},__metadata=this&&this[a176_0x4c9b5d(0x1ce)]||function(_0x4aab53,_0xfbf318){const _0x188401=a176_0x4c9b5d;if(typeof Reflect===_0x188401(0x1f0)&&typeof Reflect[_0x188401(0x1f6)]===_0x188401(0x1d0))return Reflect[_0x188401(0x1f6)](_0x4aab53,_0xfbf318);},__param=this&&this[a176_0x4c9b5d(0x1fe)]||function(_0x2204d9,_0x4de712){return function(_0x2b6a81,_0x1d97be){_0x4de712(_0x2b6a81,_0x1d97be,_0x2204d9);};},TicketService_1;Object[a176_0x4c9b5d(0x1b1)](exports,'__esModule',{'value':!![]}),exports[a176_0x4c9b5d(0x1ad)]=void 0x0;const common_1=require(a176_0x4c9b5d(0x1c9)),mongoose_1=require(a176_0x4c9b5d(0x1a5)),mongoose_2=require(a176_0x4c9b5d(0x201)),nestjs_i18n_1=require(a176_0x4c9b5d(0x1fb)),user_schema_1=require(a176_0x4c9b5d(0x1b4)),user_service_1=require(a176_0x4c9b5d(0x1bb)),chat_message_schema_1=require(a176_0x4c9b5d(0x1a6)),ticket_schema_1=require(a176_0x4c9b5d(0x1a8));let TicketService=TicketService_1=class TicketService{constructor(_0x4c9104,_0x1b68bf,_0x3ad9d2,_0x55f65d,_0x5ab18b){const _0x34aff0=a176_0x4c9b5d;this[_0x34aff0(0x1b0)]=_0x4c9104,this['chatModel']=_0x1b68bf,this['i18n']=_0x3ad9d2,this['userService']=_0x55f65d,this[_0x34aff0(0x1e2)]=_0x5ab18b,this[_0x34aff0(0x200)]=new common_1[(_0x34aff0(0x1e5))](TicketService_1[_0x34aff0(0x1fa)]);}async[a176_0x4c9b5d(0x1d1)](_0x18f5d0){const _0xc319a0=a176_0x4c9b5d,_0x1d31fb=await this[_0xc319a0(0x1b0)][_0xc319a0(0x1b8)](_0x18f5d0)[_0xc319a0(0x1b6)]();if(!_0x1d31fb)throw new common_1[(_0xc319a0(0x1fc))](this[_0xc319a0(0x1f5)]['t']('errors.ticket.notFound'));return _0x1d31fb;}async[a176_0x4c9b5d(0x1cd)](_0x11a4bf,_0x27be97){const _0x3c27e7=a176_0x4c9b5d,{subject:_0x3b3bb5,userId:_0x575ef2}=_0x11a4bf,_0x17ea6a=await this[_0x3c27e7(0x1ed)][_0x3c27e7(0x1d1)](_0x27be97);let _0x44b9c8=_0x27be97;[user_schema_1['Role']['SuperAdmin'],user_schema_1[_0x3c27e7(0x1b9)]['Admin']]['includes'](_0x17ea6a[_0x3c27e7(0x1df)])&&(await this[_0x3c27e7(0x1ed)][_0x3c27e7(0x1d1)](_0x575ef2),_0x44b9c8=_0x575ef2);try{const _0x4366bd=await this[_0x3c27e7(0x1b0)][_0x3c27e7(0x1cd)]({'user':_0x44b9c8,'subject':_0x3b3bb5,'isActive':!![],'hasNewMessageForAdmin':![],'hasNewMessageForUser':![]});return _0x4366bd;}catch(_0x315a3f){this[_0x3c27e7(0x200)][_0x3c27e7(0x1a1)](_0x3c27e7(0x1db)+_0x315a3f);throw new common_1[(_0x3c27e7(0x1a9))]();}}async[a176_0x4c9b5d(0x1ca)](_0x1d8fd3,_0x5bd26e){const _0x1dd9d9=a176_0x4c9b5d,{text:_0x31ae16,ticketId:_0x3ee701,fileUrl:_0x494471}=_0x1d8fd3,_0x11af42=await this[_0x1dd9d9(0x1d1)](_0x3ee701),_0x4cf609=await this[_0x1dd9d9(0x1ed)]['findOrThrow'](_0x5bd26e),_0x1ee0c5={};if([user_schema_1[_0x1dd9d9(0x1b9)]['User'],user_schema_1['Role'][_0x1dd9d9(0x1f8)]][_0x1dd9d9(0x202)](_0x4cf609[_0x1dd9d9(0x1df)])){if(String(_0x11af42[_0x1dd9d9(0x1d8)])!=_0x5bd26e)throw new common_1[(_0x1dd9d9(0x1fc))](this[_0x1dd9d9(0x1f5)]['t'](_0x1dd9d9(0x1d4)));_0x1ee0c5[_0x1dd9d9(0x1bd)]=!![];}else _0x1ee0c5['hasNewMessageForUser']=!![];if(!_0x11af42[_0x1dd9d9(0x1cf)])throw new common_1[(_0x1dd9d9(0x1fc))](this['i18n']['t'](_0x1dd9d9(0x1c1)));let _0x18b05a;try{_0x18b05a=await this[_0x1dd9d9(0x1e2)][_0x1dd9d9(0x1af)](),_0x18b05a[_0x1dd9d9(0x1dd)]();const _0x515941=(await this[_0x1dd9d9(0x1de)]['create']([{'ticket':_0x3ee701,'sender':_0x5bd26e,'text':_0x31ae16,'file':_0x494471}],{'session':_0x18b05a}))[0x0];return await this['ticketModel'][_0x1dd9d9(0x1d9)](_0x3ee701,_0x1ee0c5,{'session':_0x18b05a}),await _0x18b05a['commitTransaction'](),_0x515941;}catch(_0x3dde07){if(_0x18b05a===null||_0x18b05a===void 0x0?void 0x0:_0x18b05a[_0x1dd9d9(0x1dc)]())await _0x18b05a[_0x1dd9d9(0x1d2)]();this[_0x1dd9d9(0x200)]['error'](_0x1dd9d9(0x1ef)+_0x3dde07);throw new common_1[(_0x1dd9d9(0x1a9))]();}finally{if(_0x18b05a)await _0x18b05a[_0x1dd9d9(0x1b2)]();}}async[a176_0x4c9b5d(0x1c6)](_0x26ec5c,_0x3ce10b){const _0x3ca22b=a176_0x4c9b5d,{limit:_0x13211f,skip:_0x2b3176,sortBy:_0x2f65e4,sortOrder:_0x26f565,userId:_0x3ff99d,search:_0x41baef,readed:_0x33c4b4}=_0x26ec5c,_0x419def={},_0x7c88d=await this[_0x3ca22b(0x1ed)][_0x3ca22b(0x1d1)](_0x3ce10b),_0x5b948e={};if([user_schema_1['Role'][_0x3ca22b(0x1f3)],user_schema_1['Role']['Admin']][_0x3ca22b(0x202)](_0x7c88d[_0x3ca22b(0x1df)])){_0x3ff99d&&(await this[_0x3ca22b(0x1ed)][_0x3ca22b(0x1d1)](_0x3ff99d),_0x419def['user._id']=new mongoose_2[(_0x3ca22b(0x1ec))][(_0x3ca22b(0x1c8))](_0x3ff99d),_0x5b948e[_0x3ca22b(0x1d8)]=_0x3ff99d);_0x5b948e[_0x3ca22b(0x1bd)]=!![];if(_0x33c4b4!==undefined&&_0x33c4b4!==null)_0x419def[_0x3ca22b(0x1bd)]=!_0x33c4b4;_0x41baef&&(_0x419def['$or']=[{'user.mobileNumber':RegExp(_0x41baef,'i')},{'user.firstName':RegExp(_0x41baef,'i')},{'user.lastName':RegExp(_0x41baef,'i')},{'subject':RegExp(_0x41baef,'i')}]);}else{_0x419def[_0x3ca22b(0x1e4)]=new mongoose_2['Types'][(_0x3ca22b(0x1c8))](_0x3ce10b),_0x5b948e[_0x3ca22b(0x1d8)]=_0x3ce10b,_0x5b948e[_0x3ca22b(0x1eb)]=!![];if(_0x33c4b4!==undefined&&_0x33c4b4!==null)_0x419def['hasNewMessageForUser']=!_0x33c4b4;}let _0xb69e9e;_0x2f65e4?_0xb69e9e={[_0x2f65e4]:_0x26f565?0x1:-0x1}:_0xb69e9e={'createdAt':0x1};const _0x185e22=await this[_0x3ca22b(0x1b0)]['aggregate']([{'$lookup':{'from':_0x3ca22b(0x1f1),'localField':_0x3ca22b(0x1d8),'foreignField':_0x3ca22b(0x1cb),'as':_0x3ca22b(0x1c0)}},{'$set':{'user._id':{'$first':_0x3ca22b(0x204)},'user.mobileNumber':{'$first':_0x3ca22b(0x203)},'user.firstName':{'$first':_0x3ca22b(0x1b3)},'user.lastName':{'$first':_0x3ca22b(0x1b5)},'user.role':{'$first':_0x3ca22b(0x1fd)},'user.sex':{'$first':_0x3ca22b(0x1f9)},'user.verificationStatus':{'$first':'$userArr.verificationStatus'}}},{'$match':_0x419def},{'$unset':['userArr']},{'$sort':_0xb69e9e},{'$facet':{'data':[{'$skip':_0x2b3176},{'$limit':_0x13211f},{'$lookup':{'from':_0x3ca22b(0x1ae),'localField':_0x3ca22b(0x1cb),'foreignField':_0x3ca22b(0x1aa),'as':_0x3ca22b(0x1c5)}},{'$set':{'lastMessage':{'$last':_0x3ca22b(0x1a3)}}},{'$unset':['messages']}],'count':[{'$count':_0x3ca22b(0x1c7)}]}},{'$set':{'count':{'$first':'$count.count'}}}]),_0x2e714f=await this[_0x3ca22b(0x1b0)]['countDocuments'](_0x5b948e);return{'count':_0x185e22[0x0][_0x3ca22b(0x1c7)],'newMessageCount':_0x2e714f,'data':_0x185e22[0x0][_0x3ca22b(0x1f7)]};}async[a176_0x4c9b5d(0x1ba)](_0x5aac31,_0x2abcb4){const _0x3adc31=a176_0x4c9b5d,{limit:_0x1ebb3f,skip:_0x29461c,ticketId:_0xb3aac}=_0x5aac31,_0x21dae3=await this[_0x3adc31(0x1d1)](_0xb3aac),_0x356a1b=await this[_0x3adc31(0x1ed)]['findOrThrow'](_0x2abcb4);if(String(_0x21dae3[_0x3adc31(0x1d8)])!=_0x2abcb4&&[user_schema_1['Role'][_0x3adc31(0x1e7)],user_schema_1['Role'][_0x3adc31(0x1f8)]][_0x3adc31(0x202)](_0x356a1b[_0x3adc31(0x1df)]))throw new common_1[(_0x3adc31(0x1fc))](this[_0x3adc31(0x1f5)]['t'](_0x3adc31(0x1d4)));const _0x58d889={'ticket':_0xb3aac},_0x1a8662=await this[_0x3adc31(0x1de)][_0x3adc31(0x1a2)](_0x58d889)[_0x3adc31(0x1a4)]({'createdAt':0x1})[_0x3adc31(0x1e3)](_0x29461c)[_0x3adc31(0x1e6)](_0x1ebb3f)[_0x3adc31(0x1ff)]({'path':_0x3adc31(0x1c3),'select':{'_id':0x1,'mobileNumber':0x1,'firstName':0x1,'lastName':0x1,'role':0x1,'sex':0x1}})['lean'](),_0x9f75c5=await this['chatModel'][_0x3adc31(0x1e8)](_0x58d889);return{'ticket':_0x21dae3,'count':_0x9f75c5,'data':_0x1a8662};}async[a176_0x4c9b5d(0x1f4)](_0xc45b2f,_0x51777d){const _0xd67a41=a176_0x4c9b5d,_0x3e8d03=await this['findOrThrow'](_0xc45b2f),_0x50febd=await this[_0xd67a41(0x1ed)][_0xd67a41(0x1d1)](_0x51777d);if([user_schema_1[_0xd67a41(0x1b9)][_0xd67a41(0x1e7)],user_schema_1[_0xd67a41(0x1b9)][_0xd67a41(0x1f8)]][_0xd67a41(0x202)](_0x50febd[_0xd67a41(0x1df)])&&String(_0x3e8d03[_0xd67a41(0x1d8)])!=_0x51777d)throw new common_1[(_0xd67a41(0x1fc))](this[_0xd67a41(0x1f5)]['t'](_0xd67a41(0x1d4)));let _0x273620=ticket_schema_1[_0xd67a41(0x1c2)][_0xd67a41(0x1e7)];if([user_schema_1[_0xd67a41(0x1b9)]['SuperAdmin'],user_schema_1[_0xd67a41(0x1b9)][_0xd67a41(0x1ee)]]['includes'](_0x50febd[_0xd67a41(0x1df)]))_0x273620=ticket_schema_1[_0xd67a41(0x1c2)][_0xd67a41(0x1ee)];await this[_0xd67a41(0x1b0)]['findByIdAndUpdate'](_0xc45b2f,{'isActive':![],'deactivatedBy':_0x273620});}async['readTicket'](_0x34b013,_0x4844d8){const _0x43b4c9=a176_0x4c9b5d,_0x4edd47=await this[_0x43b4c9(0x1d1)](_0x34b013),_0x479e87=await this[_0x43b4c9(0x1ed)][_0x43b4c9(0x1d1)](_0x4844d8),_0x149667={};if([user_schema_1[_0x43b4c9(0x1b9)][_0x43b4c9(0x1e7)],user_schema_1['Role'][_0x43b4c9(0x1f8)]][_0x43b4c9(0x202)](_0x479e87[_0x43b4c9(0x1df)])){_0x149667[_0x43b4c9(0x1eb)]=![];if(String(_0x4edd47[_0x43b4c9(0x1d8)])!=_0x4844d8)throw new common_1[(_0x43b4c9(0x1fc))](this[_0x43b4c9(0x1f5)]['t']('errors.ticket.notFound'));}else _0x149667[_0x43b4c9(0x1bd)]=![];await this[_0x43b4c9(0x1b0)]['findByIdAndUpdate'](_0x34b013,_0x149667);}};exports['TicketService']=TicketService,exports['TicketService']=TicketService=TicketService_1=__decorate([(0x0,common_1[a176_0x4c9b5d(0x1bc)])(),__param(0x0,(0x0,mongoose_1[a176_0x4c9b5d(0x1bf)])(ticket_schema_1['Ticket'][a176_0x4c9b5d(0x1fa)])),__param(0x1,(0x0,mongoose_1[a176_0x4c9b5d(0x1bf)])(chat_message_schema_1[a176_0x4c9b5d(0x1ea)][a176_0x4c9b5d(0x1fa)])),__param(0x4,(0x0,mongoose_1[a176_0x4c9b5d(0x1d3)])()),__metadata(a176_0x4c9b5d(0x1b7),[mongoose_2[a176_0x4c9b5d(0x1cc)],mongoose_2[a176_0x4c9b5d(0x1cc)],nestjs_i18n_1['I18nService'],user_service_1['UserService'],mongoose_2[a176_0x4c9b5d(0x1f2)]])],TicketService);