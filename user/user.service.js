'use strict';function a244_0x1f6f(){const _0x41dcd4=['ForbiddenException','./schema/card.schema','lean','keyValue','$userArr.mobileNumber','generateRandomNumber','findOne','ConflictException','findMe','$userArr._id','$referrals.count','123688FFzDFn','changeMobileNumber','__importDefault','_id','toDate','Error\x20in\x20creating\x20admin:\x20','balanceLogModel','PendingSecondLevel','account_number','limit','errors.user.uniqueField','Card','externalApisService','ADMIN_PHONE','aggregate','endSession','VIPUser','registerUserIbanInVandar','ExternalApisService','changeRole','design:returntype','save','payReferrerReward','deleteCard','errors.user.userExists','i18n','commitTransaction','hashData','sendLookupSms','deleteUser','./schema/user.schema','4410tkdmKw','486iRYEXY','errors.user.alreadyVerified','tempMobileNumber','decreaseBalance','Model','728ikzozp','chnageMobileNumberCode','$level','$levelArr._id','Injectable','increaseBalance','Error\x20in\x20online\x20creating\x20card:\x20','errors.card.notFound','offlineFirstStepVerify','NotVerified','getUserCards','newUsersReport','startSession','findOrThrow','verificationStatus','authenticate','I18nService','Inject','logger','$transactionsAmount.total','getMinutes','function','UserService','updateOne','getUsersByLevel','errors.auth.wrongCode','$userArr.lastName','extGetUser','1566DGxeTm','getUsersByRole','errors.user.cannotDeleteUser','CronExpression','$tomanBalance','configService','inTransaction','connection','$total','errors.user.sameMobileNumber','default','$userArr.role','InternalServerErrorException','verifyCard','prototype','codes','../level/level.service','22757WqNLTm','error','5667KZjdTa','defineProperty','years','createAdmin','transactions','findByMobileNumber','ConfigService','levelService','findUserLastBalanceLog','errors.auth.expiredCode','getUserBalancelogs','levelArr','Cron','userModel','bank_persian_name','__esModule','VerificationStatus','$levelArr.name','metadata','chnageMobileNumberCodeExpiry','decorate','Month','nestjs-i18n','users','birthDate','firstName','$userArr.sex','registeredInVandar','offlineCreateCard','getTotalUserBalances','New\x20ibans\x20registered\x20in\x20vandar.','countDocuments','design:type','InjectConnection','LevelService','getUserCardNumbers','session','errors.user.notVerified','stringify','Types','balance','errors.user.birthDateIsRequired','userArr','onModuleInit','startTransaction','$referrerArr.mobileNumber','generateRandomCode','InjectModel','__metadata','../settings/settings.service','referrals','days','throwPaymentError','transactionsAmount','findByReferralCode','select','changeBalance','56903aIeiLY','skip','@nestjs/common','sort','errors.user.notFound','../transaction/schema/transaction.schema','Error\x20in\x20creating\x20user:\x20','collation','updateOrderBookIsActive','../external-apis/external-apis.service','code','errors.card.uniqueField','removeVerificationCode','moment','Admin','secondStepVerifyReq','@nestjs/config','updateUserLevelBasedOnReferral','ChangeByAdmin','>:\x20','deleteMany','Error\x20in\x20offline\x20creating\x20card:\x20','BadRequestException','DateMode','push','SecondLevelVerified','user','findAllCards','find','count','abortTransaction','registerUsersInVandar','NotFoundException','ObjectId','@nestjs/mongoose','Connection','user._id','notRewardedReferrals','getUserReferralCount','\x0a\x20\x20\x20\x20\x20\x20\x20\x20_id\x0a\x20\x20\x20\x20\x20\x20\x20\x20firstName\x0a\x20\x20\x20\x20\x20\x20\x20\x20lastName\x0a\x20\x20\x20\x20\x20\x20\x20\x20mobileNumber\x0a\x20\x20\x20\x20\x20\x20\x20\x20createdAt\x0a\x20\x20\x20\x20\x20\x20\x20\x20updatedAt','findByIdAndUpdate','Active','onlineCreateCard','354324JwbKjy','log','registerUsersIbanInVandar','../common/utils','getUniqueReferralCode','User','sheba','$or','SuperAdmin','includes','$userArr.verificationStatus','onlineFirstStepVerify','mobileNumber','settingsService','Error\x20in\x20getUserVandarDepositCodeAndUpdate:\x20','iban','get','Accepted','errors.user.firstLevelVerifyRequired','$count.count','secondStepVerifyConfirm','$userArr.firstName','subtract','referrerArr','Role','create','SettingsService','update','getOwnPropertyDescriptor','findById','lastName','ADMIN_PASS','@nestjs/schedule','CardStatus','Logger','tomanBalance','data','object','mongoose','Default\x20admin\x20created:\x20','abs','status','2211640dYCttG','confirmOfflineCard','./schema/balance-log.schema','months','FirstLevelVerified','design:paramtypes','Pending','findOneByNumber','levels','role','$referrerArr.lastName','cardModel','referrer','level','errors.user.cardAlreadyRegistered','EVERY_HOUR','populate','total','findAll','Deleted','BalanceLogAction','733948iMwDxT','__param','$referrerArr._id','settings','name','updatedAt','firstStepVerifyConfirm'];a244_0x1f6f=function(){return _0x41dcd4;};return a244_0x1f6f();}const a244_0x442796=a244_0xeeee;(function(_0x177c4e,_0x516af5){const _0x2ae5ea=a244_0xeeee,_0x45d69d=_0x177c4e();while(!![]){try{const _0x75352c=parseInt(_0x2ae5ea(0x197))/0x1+parseInt(_0x2ae5ea(0x1d6))/0x2+parseInt(_0x2ae5ea(0x23c))/0x3*(-parseInt(_0x2ae5ea(0x20d))/0x4)+-parseInt(_0x2ae5ea(0x1c1))/0x5+-parseInt(_0x2ae5ea(0x229))/0x6*(parseInt(_0x2ae5ea(0x23a))/0x7)+parseInt(_0x2ae5ea(0x1e8))/0x8*(-parseInt(_0x2ae5ea(0x208))/0x9)+-parseInt(_0x2ae5ea(0x207))/0xa*(-parseInt(_0x2ae5ea(0x16c))/0xb);if(_0x75352c===_0x516af5)break;else _0x45d69d['push'](_0x45d69d['shift']());}catch(_0x1729d2){_0x45d69d['push'](_0x45d69d['shift']());}}}(a244_0x1f6f,0x82244));var __decorate=this&&this['__decorate']||function(_0x25a56a,_0x47ed5d,_0x2d01c0,_0x4b5b6f){const _0x627d19=a244_0xeeee;var _0x15ac33=arguments['length'],_0x4970c6=_0x15ac33<0x3?_0x47ed5d:_0x4b5b6f===null?_0x4b5b6f=Object[_0x627d19(0x1b3)](_0x47ed5d,_0x2d01c0):_0x4b5b6f,_0x401344;if(typeof Reflect===_0x627d19(0x1bc)&&typeof Reflect[_0x627d19(0x147)]===_0x627d19(0x222))_0x4970c6=Reflect[_0x627d19(0x147)](_0x25a56a,_0x47ed5d,_0x2d01c0,_0x4b5b6f);else{for(var _0x5de85e=_0x25a56a['length']-0x1;_0x5de85e>=0x0;_0x5de85e--)if(_0x401344=_0x25a56a[_0x5de85e])_0x4970c6=(_0x15ac33<0x3?_0x401344(_0x4970c6):_0x15ac33>0x3?_0x401344(_0x47ed5d,_0x2d01c0,_0x4970c6):_0x401344(_0x47ed5d,_0x2d01c0))||_0x4970c6;}return _0x15ac33>0x3&&_0x4970c6&&Object[_0x627d19(0x23d)](_0x47ed5d,_0x2d01c0,_0x4970c6),_0x4970c6;},__metadata=this&&this[a244_0x442796(0x163)]||function(_0x40260b,_0x33b9a5){const _0x1f4d36=a244_0x442796;if(typeof Reflect===_0x1f4d36(0x1bc)&&typeof Reflect[_0x1f4d36(0x145)]==='function')return Reflect[_0x1f4d36(0x145)](_0x40260b,_0x33b9a5);},__param=this&&this[a244_0x442796(0x1d7)]||function(_0x1b988c,_0x1ce7ba){return function(_0x3e9a3e,_0x2733b3){_0x1ce7ba(_0x3e9a3e,_0x2733b3,_0x1b988c);};},__importDefault=this&&this[a244_0x442796(0x1ea)]||function(_0x40df46){const _0x5465eb=a244_0x442796;return _0x40df46&&_0x40df46[_0x5465eb(0x142)]?_0x40df46:{'default':_0x40df46};},UserService_1;Object[a244_0x442796(0x23d)](exports,a244_0x442796(0x142),{'value':!![]}),exports[a244_0x442796(0x223)]=void 0x0;const common_1=require(a244_0x442796(0x16e)),config_1=require(a244_0x442796(0x17c)),mongoose_1=require(a244_0x442796(0x18e)),schedule_1=require(a244_0x442796(0x1b7)),moment_1=__importDefault(require(a244_0x442796(0x179))),mongoose_2=require(a244_0x442796(0x1bd)),nestjs_i18n_1=require(a244_0x442796(0x149)),utils_1=require(a244_0x442796(0x19a)),external_apis_service_1=require(a244_0x442796(0x175)),level_service_1=require(a244_0x442796(0x239)),settings_service_1=require(a244_0x442796(0x164)),transaction_schema_1=require(a244_0x442796(0x171)),get_new_users_report_dto_1=require('./dto/get-new-users-report.dto'),balance_log_schema_1=require(a244_0x442796(0x1c3)),card_schema_1=require(a244_0x442796(0x1de)),user_schema_1=require(a244_0x442796(0x206));let UserService=UserService_1=class UserService{constructor(_0x2157bd,_0x201011,_0xb8ff45,_0x31d4e5,_0x1d2cb7,_0x1f4298,_0x4b158e,_0x34b5e8,_0x488fce){const _0x15ba3e=a244_0x442796;this[_0x15ba3e(0x140)]=_0x2157bd,this[_0x15ba3e(0x1cc)]=_0x201011,this[_0x15ba3e(0x1ee)]=_0xb8ff45,this[_0x15ba3e(0x201)]=_0x31d4e5,this[_0x15ba3e(0x1f4)]=_0x1d2cb7,this[_0x15ba3e(0x243)]=_0x1f4298,this['settingsService']=_0x4b158e,this[_0x15ba3e(0x22e)]=_0x34b5e8,this[_0x15ba3e(0x230)]=_0x488fce,this['logger']=new common_1[(_0x15ba3e(0x1b9))](UserService_1[_0x15ba3e(0x1da)]);}async[a244_0x442796(0x15e)](){const _0x5a4140=a244_0x442796;this[_0x5a4140(0x18b)](),this[_0x5a4140(0x199)]();}async[a244_0x442796(0x199)](){const _0x59a10f=a244_0x442796,{idDepositIsActive:_0x5cb9fb}=await this[_0x59a10f(0x1a4)][_0x59a10f(0x1d9)]();if(!_0x5cb9fb)return;const _0x5763e6=await this['cardModel'][_0x59a10f(0x188)]({'iban':{'$exists':!![]},'$or':[{'registeredInVandar':![]},{'registeredInVandar':undefined}]})[_0x59a10f(0x1d1)](_0x59a10f(0x186));for(const _0x625f77 of _0x5763e6){try{await this[_0x59a10f(0x1f4)][_0x59a10f(0x1f9)](_0x625f77[_0x59a10f(0x186)][_0x59a10f(0x1a3)],_0x625f77[_0x59a10f(0x1a6)]);}catch(_0x49dda2){this[_0x59a10f(0x21f)][_0x59a10f(0x23b)]('Error\x20in\x20registerUsersIbanInVandar\x20card<'+_0x625f77[_0x59a10f(0x1eb)]+_0x59a10f(0x17f)+JSON[_0x59a10f(0x159)](_0x49dda2,null,0x2));continue;}_0x625f77[_0x59a10f(0x14e)]=!![],await _0x625f77[_0x59a10f(0x1fd)]();}this[_0x59a10f(0x21f)]['log'](_0x59a10f(0x151));}async['registerUsersInVandar'](){const _0x470263=a244_0x442796,{idDepositIsActive:_0x37d991}=await this['settingsService'][_0x470263(0x1d9)]();if(!_0x37d991)return;const _0x4f6927=await this[_0x470263(0x140)][_0x470263(0x188)]({'verificationStatus':{'$in':[user_schema_1['VerificationStatus'][_0x470263(0x1c5)],user_schema_1[_0x470263(0x143)][_0x470263(0x185)]]},'$or':[{'registeredInVandar':![]},{'registeredInVandar':undefined}]});for(const _0x2af34d of _0x4f6927){try{await this[_0x470263(0x1f4)]['registerUserInVandar'](_0x2af34d[_0x470263(0x14c)],_0x2af34d[_0x470263(0x1b5)],_0x2af34d[_0x470263(0x1a3)],_0x2af34d['nationalCode']);}catch(_0x5d1a53){this[_0x470263(0x21f)][_0x470263(0x23b)]('Error\x20in\x20registerUserInVandar\x20user<'+_0x2af34d[_0x470263(0x1a3)]+_0x470263(0x17f)+JSON['stringify'](_0x5d1a53,null,0x2));continue;}_0x2af34d[_0x470263(0x14e)]=!![],await _0x2af34d[_0x470263(0x1fd)]();}this['logger'][_0x470263(0x198)]('New\x20users\x20registered\x20in\x20vandar.');}async['createDefaultAdmin'](){const _0x554b66=a244_0x442796,_0x472132=this[_0x554b66(0x22e)][_0x554b66(0x1a7)](_0x554b66(0x1f5)),_0x5abd6a=this[_0x554b66(0x22e)][_0x554b66(0x1a7)](_0x554b66(0x1b6)),_0x3e3d47=await this[_0x554b66(0x140)][_0x554b66(0x1e3)]({'role':user_schema_1[_0x554b66(0x1af)][_0x554b66(0x19f)]});if(!_0x3e3d47)try{await this[_0x554b66(0x140)]['create']({'mobileNumber':_0x472132,'password':await(0x0,utils_1[_0x554b66(0x203)])(_0x5abd6a),'role':user_schema_1[_0x554b66(0x1af)][_0x554b66(0x19f)]}),this[_0x554b66(0x21f)][_0x554b66(0x198)](_0x554b66(0x1be)+_0x472132);}catch(_0x4fad31){this['logger'][_0x554b66(0x23b)]('Failed\x20to\x20create\x20default\x20admin:\x20'+_0x4fad31);}}async[a244_0x442796(0x21a)](_0x2223bf){const _0xc81af2=a244_0x442796,_0x492919=await this[_0xc81af2(0x140)][_0xc81af2(0x1b4)](_0x2223bf)[_0xc81af2(0x1df)]();if(!_0x492919||_0x492919[_0xc81af2(0x1ca)]!==user_schema_1[_0xc81af2(0x1af)][_0xc81af2(0x19f)]&&!_0x492919['isActive'])throw new common_1['NotFoundException'](this[_0xc81af2(0x201)]['t'](_0xc81af2(0x170)));return _0x492919;}async[a244_0x442796(0x19b)](){const _0x562081=a244_0x442796;let _0x372d23,_0x5893be;do{_0x5893be=(0x0,utils_1[_0x562081(0x161)])(),_0x372d23=await this[_0x562081(0x140)][_0x562081(0x1e3)]({'inviteCode':_0x5893be});}while(_0x372d23);return _0x5893be;}async['payReferrerReward'](_0x3b3639,_0x5f1588=undefined){const _0x534b6d=a244_0x442796,{referralCountForGettingReward:_0x162945,referralReward:_0x252e43}=await this[_0x534b6d(0x1a4)][_0x534b6d(0x1d9)]();if(_0x162945){let _0x4af3e9=_0x3b3639[_0x534b6d(0x191)]+0x1;_0x4af3e9>=_0x162945&&(_0x4af3e9=_0x3b3639[_0x534b6d(0x191)]-(_0x162945-0x1),await this[_0x534b6d(0x212)](_0x3b3639['_id'],_0x252e43,balance_log_schema_1[_0x534b6d(0x1d5)]['ReferralReward'],_0x5f1588,''+_0x162945)),await this[_0x534b6d(0x1b2)](_0x3b3639[_0x534b6d(0x1eb)],{'notRewardedReferrals':_0x4af3e9},_0x5f1588);}}async['createUser'](_0x5c19bb){const _0x48a8f5=a244_0x442796,{mobileNumber:_0x4e0b8d,verificationCode:_0xbe61be,verificationCodeExpiryDate:_0x596fc7,password:_0x22605a,email:_0x30b607,nationalCode:_0x64d13b,firstName:_0xf721b4,lastName:_0x38cac7,sex:_0x2f93b1}=_0x5c19bb,_0x11b4e0=await this[_0x48a8f5(0x243)][_0x48a8f5(0x1c8)](0x1),_0x18470b=await this['findByMobileNumber'](_0x4e0b8d,[user_schema_1[_0x48a8f5(0x1af)][_0x48a8f5(0x19c)],user_schema_1[_0x48a8f5(0x1af)][_0x48a8f5(0x1f8)]]);if(_0x18470b)throw new common_1[(_0x48a8f5(0x1e4))](this[_0x48a8f5(0x201)]['t'](_0x48a8f5(0x1f2),{'args':{'field':_0x48a8f5(0x1a3)}}));try{const _0x2e579d=await this['userModel'][_0x48a8f5(0x1b0)]({'mobileNumber':_0x4e0b8d,'role':user_schema_1[_0x48a8f5(0x1af)]['User'],'verificationCode':_0xbe61be,'verificationCodeExpiryDate':_0x596fc7,'password':_0x22605a&&await(0x0,utils_1[_0x48a8f5(0x203)])(_0x22605a),'tomanBalance':0x0,'email':_0x30b607,'firstName':_0xf721b4,'lastName':_0x38cac7,'referralCode':await this[_0x48a8f5(0x19b)](),'sex':_0x2f93b1,'level':_0x11b4e0[_0x48a8f5(0x1eb)],'isFirstLoginDone':![],'verificationStatus':user_schema_1['VerificationStatus'][_0x48a8f5(0x216)],'nationalCode':_0x64d13b,'isActive':!![],'notRewardedReferrals':0x0});return _0x2e579d;}catch(_0x1ef919){if(_0x1ef919[_0x48a8f5(0x176)]==0x2af8)throw new common_1[(_0x48a8f5(0x1e4))](this[_0x48a8f5(0x201)]['t']('errors.user.uniqueField',{'args':{'field':JSON[_0x48a8f5(0x159)](_0x1ef919[_0x48a8f5(0x1e0)])}}));this[_0x48a8f5(0x21f)]['error'](_0x48a8f5(0x172)+_0x1ef919);throw new common_1[(_0x48a8f5(0x235))]();}}async[a244_0x442796(0x23f)](_0x3f59f3){const _0x182268=a244_0x442796,{mobileNumber:_0x3cc89a,password:_0x295c3e,email:_0x54743b,firstName:_0x4b8994,lastName:_0x15ec87,sex:_0x42ff96}=_0x3f59f3,_0x13feed=await this[_0x182268(0x241)](_0x3cc89a,[user_schema_1[_0x182268(0x1af)]['SuperAdmin'],user_schema_1['Role'][_0x182268(0x17a)]]);if(_0x13feed)throw new common_1['ConflictException'](this[_0x182268(0x201)]['t'](_0x182268(0x1f2),{'args':{'field':_0x182268(0x1a3)}}));try{const _0x22f153=await this[_0x182268(0x140)][_0x182268(0x1b0)]({'mobileNumber':_0x3cc89a,'role':user_schema_1[_0x182268(0x1af)][_0x182268(0x17a)],'password':_0x295c3e&&await(0x0,utils_1[_0x182268(0x203)])(_0x295c3e),'firstName':_0x4b8994,'lastName':_0x15ec87,'email':_0x54743b,'sex':_0x42ff96,'isActive':!![]});return _0x22f153;}catch(_0x3844dc){if(_0x3844dc['code']==0x2af8)throw new common_1['ConflictException'](this[_0x182268(0x201)]['t'](_0x182268(0x1f2),{'args':{'field':JSON[_0x182268(0x159)](_0x3844dc['keyValue'])}}));this['logger'][_0x182268(0x23b)](_0x182268(0x1ed)+_0x3844dc);throw new common_1['InternalServerErrorException']();}}async[a244_0x442796(0x1d3)](_0x219e89,_0x58b4b8){const _0x568cec=a244_0x442796,{skip:_0x5abd91,limit:_0xe841dc,sortBy:_0xcebd72,sortOrder:_0x599cd8,id:_0x3a7947,roles:_0xaa78e1,search:_0x18342c,verificationStatus:_0x209ce3,referrerId:_0x786809}=_0x58b4b8,_0xb9e19a={};const _0xifl=_0x58b4b8['isFirstLoginDone'];if(_0xifl!==undefined){const _0xifb=_0xifl===true||_0xifl==='true'?true:_0xifl===false||_0xifl==='false'?false:undefined;if(_0xifb!==undefined)_0xb9e19a['isFirstLoginDone']=_0xifb;}if(_0x3a7947)_0xb9e19a['_id']=new mongoose_2[(_0x568cec(0x15a))]['ObjectId'](_0x3a7947);const _0x541db8=await this[_0x568cec(0x1b4)](_0x219e89);if(_0x541db8[_0x568cec(0x1ca)]===user_schema_1[_0x568cec(0x1af)][_0x568cec(0x17a)])_0xb9e19a[_0x568cec(0x1ca)]=user_schema_1[_0x568cec(0x1af)][_0x568cec(0x19c)];else _0xaa78e1&&(_0xb9e19a[_0x568cec(0x1ca)]={'$in':_0xaa78e1});if(_0x18342c)_0xb9e19a['$or']=[{'firstName':RegExp(_0x18342c,'i')},{'lastName':RegExp(_0x18342c,'i')},{'mobileNumber':RegExp(_0x18342c,'i')}];if(_0x209ce3)_0xb9e19a[_0x568cec(0x21b)]={'$in':_0x209ce3};if(_0x786809)_0xb9e19a[_0x568cec(0x1cd)]=new mongoose_2[(_0x568cec(0x15a))][(_0x568cec(0x18d))](_0x786809);let _0x9586f0;_0xcebd72?_0x9586f0={[_0xcebd72]:_0x599cd8?0x1:-0x1}:_0x9586f0={'createdAt':0x1};const _0x940705=await this[_0x568cec(0x140)][_0x568cec(0x1f6)]([{'$match':_0xb9e19a},{'$sort':_0x9586f0},{'$facet':{'data':[{'$skip':_0x5abd91},{'$limit':_0xe841dc},{'$lookup':{'from':_0x568cec(0x240),'localField':_0x568cec(0x1eb),'foreignField':'user','pipeline':[{'$group':{'_id':null,'total':{'$sum':_0x568cec(0x231)}}}],'as':_0x568cec(0x168)}},{'$lookup':{'from':_0x568cec(0x14a),'localField':'_id','foreignField':'referrer','pipeline':[{'$group':{'_id':null,'count':{'$count':{}}}}],'as':'referrals'}},{'$lookup':{'from':_0x568cec(0x1c9),'localField':_0x568cec(0x1ce),'foreignField':_0x568cec(0x1eb),'as':_0x568cec(0x13e)}},{'$lookup':{'from':_0x568cec(0x14a),'localField':_0x568cec(0x1cd),'foreignField':_0x568cec(0x1eb),'as':_0x568cec(0x1ae)}},{'$project':{'totalTransactions':{'$ifNull':[{'$first':'$transactionsAmount.total'},0x0]},'referralCount':{'$first':_0x568cec(0x1e7)},'mobileNumber':0x1,'firstName':0x1,'lastName':0x1,'role':0x1,'referralCode':0x1,'sex':0x1,'isFirstLoginDone':0x1,'tomanBalance':0x1,'nationalCode':0x1,'verificationStatus':0x1,'birthDate':0x1,'email':0x1,'documentImages':0x1,'isActive':0x1,'orderBookIsActive':0x1,'sidebarPermissions':0x1,'createdAt':0x1,'updatedAt':0x1,'level._id':{'$first':_0x568cec(0x210)},'level.name':{'$first':_0x568cec(0x144)},'referrer._id':{'$first':_0x568cec(0x1d8)},'referrer.mobileNumber':{'$first':_0x568cec(0x160)},'referrer.firstName':{'$first':'$referrerArr.firstName'},'referrer.lastName':{'$first':_0x568cec(0x1cb)}}}],'count':[{'$count':_0x568cec(0x189)}]}},{'$set':{'count':{'$first':_0x568cec(0x1aa)}}}]);return{'count':_0x940705[0x0][_0x568cec(0x189)],'data':_0x940705[0x0]['data']};}[a244_0x442796(0x1b4)](_0x1a8a47){const _0xd1d7e4=a244_0x442796;return this[_0xd1d7e4(0x140)][_0xd1d7e4(0x1b4)](_0x1a8a47)[_0xd1d7e4(0x1df)]();}[a244_0x442796(0x241)](_0x7b42bd,_0x11c28b){const _0x52e576=a244_0x442796;return this[_0x52e576(0x140)][_0x52e576(0x1e3)]({'mobileNumber':_0x7b42bd,'role':{'$in':_0x11c28b}})['lean']();}[a244_0x442796(0x169)](_0x4c9c2f){const _0x802447=a244_0x442796;return this[_0x802447(0x140)][_0x802447(0x1e3)]({'referralCode':_0x4c9c2f})['lean']();}['findByIDDepositCode'](_0x24e475){const _0xc21d96=a244_0x442796;return this[_0xc21d96(0x140)][_0xc21d96(0x1e3)]({'vandarIDDeposit.code':_0x24e475})['lean']();}async[a244_0x442796(0x1b2)](_0x15f2f8,_0x279def,_0x239559=undefined){const _0x5d27e0=a244_0x442796,{password:_0x258a25,verificationCode:_0x5f04dd,verificationCodeExpiryDate:_0x225710,refreshToken:_0x219eb6,nationalCode:_0x1a99b4,verificationStatus:_0x345199,isActive:_0x2a8a68,firstName:_0x5a0a41,lastName:_0x9cd6a6,referrer:_0x283dd1,birthDate:_0x83baa4,email:_0xf537b5,mobileNumber:_0x1400e6,referralCode:_0x3d8504,sex:_0x4528f1,level:_0x111f1e,isFirstLoginDone:_0x4e181d,notRewardedReferrals:_0x41de96,verifyDescription:_0x2ab384,orderBookIsActive:_0x198639}=_0x279def,_0x5ba171={};if(_0x239559)_0x5ba171[_0x5d27e0(0x157)]=_0x239559;return this[_0x5d27e0(0x140)][_0x5d27e0(0x224)]({'_id':_0x15f2f8},{'password':_0x258a25&&await(0x0,utils_1['hashData'])(_0x258a25),'verificationCode':_0x5f04dd,'verificationCodeExpiryDate':_0x225710,'refreshToken':_0x219eb6,'nationalCode':_0x1a99b4,'verificationStatus':_0x345199,'verifyDescription':_0x2ab384,'firstName':_0x5a0a41,'lastName':_0x9cd6a6,'referrer':_0x283dd1,'birthDate':_0x83baa4,'email':_0xf537b5,'mobileNumber':_0x1400e6,'referralCode':_0x3d8504,'sex':_0x4528f1,'level':_0x111f1e,'isFirstLoginDone':_0x4e181d,'isActive':_0x2a8a68,'notRewardedReferrals':_0x41de96,'orderBookIsActive':_0x198639},_0x5ba171);}async[a244_0x442796(0x174)](_0x5dc39e){await this['userModel']['updateMany']({},{'orderBookIsActive':_0x5dc39e});}async[a244_0x442796(0x1fb)](_0x30a4a0,_0x23e190){const _0x544768=a244_0x442796,_0x5c319d=await this[_0x544768(0x21a)](_0x30a4a0);if([user_schema_1[_0x544768(0x1af)][_0x544768(0x19f)],user_schema_1[_0x544768(0x1af)][_0x544768(0x17a)]][_0x544768(0x1a0)](_0x5c319d[_0x544768(0x1ca)]))throw new common_1[(_0x544768(0x182))](this[_0x544768(0x201)]['t']('errors.user.cantChangeRole'));await this[_0x544768(0x140)]['findByIdAndUpdate'](_0x30a4a0,{'role':_0x23e190});}async[a244_0x442796(0x178)](_0x44ae88){const _0x4fd360=a244_0x442796;await this[_0x4fd360(0x140)][_0x4fd360(0x224)]({'_id':_0x44ae88},{'verificationCode':null,'verificationCodeExpiryDate':null});}async[a244_0x442796(0x1e5)](_0x529340){const _0xc5601=a244_0x442796,_0x44cff4=await this[_0xc5601(0x140)]['aggregate']([{'$match':{'_id':new mongoose_2[(_0xc5601(0x15a))][(_0xc5601(0x18d))](_0x529340)}},{'$lookup':{'from':_0xc5601(0x240),'localField':_0xc5601(0x1eb),'foreignField':_0xc5601(0x186),'pipeline':[{'$match':{'status':transaction_schema_1['TransactionStatus'][_0xc5601(0x1a8)]}},{'$group':{'_id':null,'total':{'$sum':_0xc5601(0x231)}}}],'as':_0xc5601(0x168)}},{'$lookup':{'from':_0xc5601(0x14a),'localField':_0xc5601(0x1eb),'foreignField':_0xc5601(0x1cd),'pipeline':[{'$group':{'_id':null,'count':{'$count':{}}}}],'as':_0xc5601(0x165)}},{'$lookup':{'from':_0xc5601(0x1c9),'localField':_0xc5601(0x1ce),'foreignField':'_id','as':'level'}},{'$project':{'totalTransactions':{'$ifNull':[{'$first':_0xc5601(0x220)},0x0]},'referralCount':{'$first':'$referrals.count'},'mobileNumber':0x1,'firstName':0x1,'lastName':0x1,'role':0x1,'referralCode':0x1,'referrer':0x1,'sex':0x1,'isFirstLoginDone':0x1,'tomanBalance':0x1,'nationalCode':0x1,'verificationStatus':0x1,'birthDate':0x1,'email':0x1,'documentImages':0x1,'level':{'$first':_0xc5601(0x20f)},'isActive':0x1,'orderBookIsActive':0x1,'sidebarPermissions':0x1,'createdAt':0x1,'updatedAt':0x1}}]);return _0x44cff4[0x0];}async[a244_0x442796(0x218)](_0x5a8087){const _0x38f8a7=a244_0x442796;var _0x1cf417;const {dateMode:_0xf56aa0}=_0x5a8087;let _0x848f3=new Date();const _0x51ba3a=new Date();if(_0xf56aa0===get_new_users_report_dto_1['DateMode']['Week'])_0x848f3=(0x0,moment_1[_0x38f8a7(0x233)])(_0x848f3)[_0x38f8a7(0x1ad)](0x7,_0x38f8a7(0x166))[_0x38f8a7(0x1ec)]();else _0xf56aa0===get_new_users_report_dto_1[_0x38f8a7(0x183)][_0x38f8a7(0x148)]?_0x848f3=(0x0,moment_1[_0x38f8a7(0x233)])(_0x848f3)[_0x38f8a7(0x1ad)](0x1,_0x38f8a7(0x1c4))[_0x38f8a7(0x1ec)]():_0x848f3=(0x0,moment_1['default'])(_0x848f3)['subtract'](0x1,_0x38f8a7(0x23e))[_0x38f8a7(0x1ec)]();const _0x7d2cb8=await this[_0x38f8a7(0x140)][_0x38f8a7(0x1f6)]([{'$match':{'$or':[{'role':user_schema_1['Role']['User']},{'role':user_schema_1[_0x38f8a7(0x1af)][_0x38f8a7(0x1f8)]}],'createdAt':{'$gte':_0x848f3,'$lte':_0x51ba3a}}},{'$group':{'_id':_0xf56aa0,'count':{'$count':{}}}}]);return{'mode':_0xf56aa0,'count':((_0x1cf417=_0x7d2cb8[0x0])===null||_0x1cf417===void 0x0?void 0x0:_0x1cf417['count'])||0x0};}async[a244_0x442796(0x1a2)](_0x316414,_0x19ca85){const _0x530f58=a244_0x442796,{nationalCode:_0x178f17,firstName:_0x1c029e,lastName:_0x517f5d,sex:_0x1598cc,birthDate:_0x586c7c}=_0x19ca85,{verificationStatus:_0x35743c,mobileNumber:_0x16fe53,_id:_0x1641a4,referrer:_0x369a88}=await this[_0x530f58(0x21a)](_0x316414);if(_0x35743c!==user_schema_1[_0x530f58(0x143)][_0x530f58(0x216)])throw new common_1[(_0x530f58(0x18c))](this[_0x530f58(0x201)]['t'](_0x530f58(0x209)));await this[_0x530f58(0x1f4)]['authenticate'](_0x16fe53,_0x178f17);let _0x38feb4;try{_0x38feb4=await this[_0x530f58(0x230)]['startSession'](),_0x38feb4[_0x530f58(0x15f)](),await this[_0x530f58(0x1b2)](_0x1641a4,{'nationalCode':_0x178f17,'verificationStatus':user_schema_1[_0x530f58(0x143)][_0x530f58(0x1c5)],'firstName':_0x1c029e,'lastName':_0x517f5d,'sex':_0x1598cc,'birthDate':_0x586c7c},_0x38feb4);if(_0x369a88){const _0x424d7f=await this['userModel'][_0x530f58(0x1e3)]({'referrer':String(_0x369a88),'nationalCode':_0x178f17,'_id':{'$ne':_0x1641a4}});if(!_0x424d7f){const _0x27390=await this[_0x530f58(0x21a)](String(_0x369a88));await this[_0x530f58(0x243)]['updateUserLevelBasedOnReferral'](String(_0x369a88),_0x38feb4),await this[_0x530f58(0x1fe)](_0x27390,_0x38feb4);}}await _0x38feb4[_0x530f58(0x202)]();}catch(_0x24e858){if(_0x38feb4===null||_0x38feb4===void 0x0?void 0x0:_0x38feb4[_0x530f58(0x22f)]())await _0x38feb4['abortTransaction']();if(_0x24e858[_0x530f58(0x1c0)]>=0x190&&_0x24e858[_0x530f58(0x1c0)]<0x1f4)throw _0x24e858;this[_0x530f58(0x21f)][_0x530f58(0x23b)]('Error\x20in\x20onlineFirstStepVerify:\x20'+_0x24e858);throw new common_1['InternalServerErrorException']();}finally{if(_0x38feb4)await _0x38feb4[_0x530f58(0x1f7)]();}}async[a244_0x442796(0x215)](_0x445a18,_0x547f04){const _0x614464=a244_0x442796,{nationalCode:_0x29c789,firstName:_0x2eeaf8,lastName:_0x5e3f84,sex:_0x22304d,birthDate:_0x49452d}=_0x547f04,_0x5ae9b3=await this['findOrThrow'](_0x445a18);if(_0x5ae9b3[_0x614464(0x21b)]!==user_schema_1[_0x614464(0x143)][_0x614464(0x216)])throw new common_1[(_0x614464(0x18c))](this[_0x614464(0x201)]['t']('errors.user.alreadyVerified'));await this[_0x614464(0x1b2)](_0x5ae9b3[_0x614464(0x1eb)],{'nationalCode':_0x29c789,'verificationStatus':user_schema_1['VerificationStatus']['PendingFirstLevel'],'firstName':_0x2eeaf8,'lastName':_0x5e3f84,'sex':_0x22304d,'birthDate':_0x49452d});}async[a244_0x442796(0x1dc)](_0xd5f54b){const _0x1edc08=a244_0x442796,{status:_0x952c00,userId:_0x444068,verifyDescription:_0x453616}=_0xd5f54b,{referrer:_0x121c70,_id:_0x1c6e44,nationalCode:_0x69189c}=await this[_0x1edc08(0x21a)](_0x444068);let _0x299a1c;try{_0x299a1c=await this['connection'][_0x1edc08(0x219)](),_0x299a1c[_0x1edc08(0x15f)](),await this[_0x1edc08(0x1b2)](_0x444068,{'verificationStatus':_0x952c00,'verifyDescription':_0x453616},_0x299a1c);if(_0x952c00===user_schema_1[_0x1edc08(0x143)][_0x1edc08(0x1c5)]&&_0x121c70){const _0x3e956a=await this[_0x1edc08(0x140)][_0x1edc08(0x1e3)]({'referrer':String(_0x121c70),'nationalCode':_0x69189c,'_id':{'$ne':_0x1c6e44}});if(!_0x3e956a){const _0x1cee1b=await this[_0x1edc08(0x21a)](String(_0x121c70));await this['levelService'][_0x1edc08(0x17d)](String(_0x121c70),_0x299a1c),await this[_0x1edc08(0x1fe)](_0x1cee1b,_0x299a1c);}}await _0x299a1c['commitTransaction']();}catch(_0x550f81){if(_0x299a1c===null||_0x299a1c===void 0x0?void 0x0:_0x299a1c[_0x1edc08(0x22f)]())await _0x299a1c['abortTransaction']();this[_0x1edc08(0x21f)][_0x1edc08(0x23b)]('Error\x20in\x20firstStepVerifyConfirm:\x20'+_0x550f81);throw new common_1[(_0x1edc08(0x235))]();}finally{if(_0x299a1c)await _0x299a1c[_0x1edc08(0x1f7)]();}}async[a244_0x442796(0x17b)](_0x52d395,_0x53cafa){const _0x9d6333=a244_0x442796,{documentImages:_0x360d1f}=_0x53cafa,_0x21380f=await this[_0x9d6333(0x21a)](_0x52d395),{secondStepUserVerifyDocs:_0x278c1c}=await this['settingsService']['settings']();for(const _0x39fd8b of _0x360d1f){let _0x177492=![];for(const _0x4f7d54 of _0x278c1c){if(_0x39fd8b['name']===_0x4f7d54['name'])_0x177492=!![];}if(!_0x177492)throw new common_1['BadRequestException'](this['i18n']['t']('errors.user.docImageIsNotValid'));}if(_0x21380f[_0x9d6333(0x21b)]===user_schema_1[_0x9d6333(0x143)]['SecondLevelVerified'])throw new common_1[(_0x9d6333(0x182))](this[_0x9d6333(0x201)]['t'](_0x9d6333(0x209)));if(_0x21380f[_0x9d6333(0x21b)]===user_schema_1[_0x9d6333(0x143)][_0x9d6333(0x216)])throw new common_1[(_0x9d6333(0x182))](this['i18n']['t'](_0x9d6333(0x1a9)));await this[_0x9d6333(0x140)]['findByIdAndUpdate']({'_id':_0x52d395},{'verificationStatus':user_schema_1[_0x9d6333(0x143)][_0x9d6333(0x1ef)],'documentImages':_0x360d1f},{'new':!![]})[_0x9d6333(0x1df)]();}async[a244_0x442796(0x1ab)](_0xcbd58){const _0xf3baa5=a244_0x442796,{status:_0x1554f3,userId:_0x505893,verifyDescription:_0xd6c407}=_0xcbd58;await this[_0xf3baa5(0x21a)](_0x505893),await this[_0xf3baa5(0x140)][_0xf3baa5(0x194)]({'_id':_0x505893},{'verificationStatus':_0x1554f3,'verifyDescription':_0xd6c407},{'new':!![]})[_0xf3baa5(0x1df)]();}async[a244_0x442796(0x150)](){const _0x4450a5=a244_0x442796;var _0x14f9f4;const _0x150aed=await this[_0x4450a5(0x140)][_0x4450a5(0x1f6)]([{'$group':{'_id':null,'total':{'$sum':_0x4450a5(0x22d)}}}]);return((_0x14f9f4=_0x150aed[0x0])===null||_0x14f9f4===void 0x0?void 0x0:_0x14f9f4[_0x4450a5(0x1d2)])||0x0;}async[a244_0x442796(0x1e9)]({newMobileNumber:_0xa7aefc},_0x1275e2){const _0x4dc738=a244_0x442796,_0x450eb5=await this[_0x4dc738(0x21a)](_0x1275e2),_0xbb7def=await this[_0x4dc738(0x241)](_0xa7aefc,[user_schema_1['Role'][_0x4dc738(0x19f)],user_schema_1[_0x4dc738(0x1af)][_0x4dc738(0x17a)],user_schema_1[_0x4dc738(0x1af)][_0x4dc738(0x19c)],user_schema_1['Role']['VIPUser']]);if(_0xbb7def&&_0xbb7def[_0x4dc738(0x1eb)]!=_0x450eb5[_0x4dc738(0x1eb)])throw new common_1[(_0x4dc738(0x182))](this[_0x4dc738(0x201)]['t'](_0x4dc738(0x200)));if(_0xa7aefc===_0x450eb5[_0x4dc738(0x1a3)])throw new common_1[(_0x4dc738(0x182))](this['i18n']['t'](_0x4dc738(0x232)));await this[_0x4dc738(0x1f4)][_0x4dc738(0x21c)](_0x450eb5[_0x4dc738(0x1a3)],_0x450eb5['nationalCode']);const _0x2007a3=(0x0,utils_1[_0x4dc738(0x1e2)])(0x6),_0x13e5de=new Date();_0x13e5de['setMinutes'](_0x13e5de[_0x4dc738(0x221)]()+0x2),await this['userModel'][_0x4dc738(0x194)](_0x1275e2,{'chnageMobileNumberCode':_0x2007a3,'chnageMobileNumberCodeExpiry':_0x13e5de,'tempMobileNumber':_0xa7aefc}),await this[_0x4dc738(0x1f4)][_0x4dc738(0x204)](_0xa7aefc,String(_0x2007a3));}async['verifyMobileNumberOtp']({code:_0x173f6b},_0x57e300){const _0x3ac384=a244_0x442796,_0x4827c8=await this[_0x3ac384(0x21a)](_0x57e300);if(new Date()>_0x4827c8[_0x3ac384(0x146)]){await this[_0x3ac384(0x140)][_0x3ac384(0x194)](_0x57e300,{'chnageMobileNumberCode':null,'chnageMobileNumberCodeExpiry':null,'tempMobileNumber':null});throw new common_1[(_0x3ac384(0x182))](this['i18n']['t'](_0x3ac384(0x13c)));}if(_0x4827c8[_0x3ac384(0x20e)]!==_0x173f6b){await this[_0x3ac384(0x140)][_0x3ac384(0x194)](_0x57e300,{'chnageMobileNumberCode':null,'chnageMobileNumberCodeExpiry':null,'tempMobileNumber':null});throw new common_1[(_0x3ac384(0x182))](this['i18n']['t'](_0x3ac384(0x226)));}await this['userModel']['findByIdAndUpdate'](_0x4827c8[_0x3ac384(0x1eb)],{'chnageMobileNumberCode':null,'chnageMobileNumberCodeExpiry':null,'tempMobileNumber':null,'mobileNumber':_0x4827c8[_0x3ac384(0x20a)]});}async[a244_0x442796(0x192)](_0x3b1e84,_0x5717b5=undefined){const _0x5d797c=a244_0x442796,_0x57a4e2={};if(_0x5717b5)_0x57a4e2[_0x5d797c(0x157)]=_0x5717b5;const _0x36d80f=await this['userModel'][_0x5d797c(0x152)]({'referrer':_0x3b1e84},_0x57a4e2);return _0x36d80f;}async['mobileNumInquiry'](_0xf7fae6){const _0x160735=a244_0x442796,{mobileNumber:_0x51d414,userId:_0x248e33}=_0xf7fae6,_0x16b462=await this[_0x160735(0x21a)](_0x248e33);await this[_0x160735(0x1f4)][_0x160735(0x21c)](_0x51d414,_0x16b462['nationalCode']);}async[a244_0x442796(0x225)](_0x445914){const _0x3bf1a9=a244_0x442796,_0x20616e=await this[_0x3bf1a9(0x140)][_0x3bf1a9(0x188)]({'level':_0x445914})['lean']();return _0x20616e;}async[a244_0x442796(0x22a)](_0x5d4694){const _0x45ce40=a244_0x442796,_0x15d60d=await this[_0x45ce40(0x140)][_0x45ce40(0x188)]({'role':{'$in':_0x5d4694}})[_0x45ce40(0x1df)]();return _0x15d60d;}async['getUserVandarDepositCodeAndUpdate'](_0x1cec54){const _0x52d3a3=a244_0x442796,{vandarIDDeposit:_0x1099dd,mobileNumber:_0x3d1820}=await this[_0x52d3a3(0x21a)](_0x1cec54);if(_0x1099dd)return _0x1099dd;let _0x1d8ebc;try{_0x1d8ebc=await this['externalApisService']['getVandarIdentifiedDepositNumber'](_0x3d1820);}catch(_0x2ee677){this[_0x52d3a3(0x21f)]['error'](_0x52d3a3(0x1a5)+_0x2ee677);throw new common_1[(_0x52d3a3(0x235))]();}const _0x206273=_0x1d8ebc[_0x52d3a3(0x238)][0x0],_0x54a5ff={'code':_0x206273[_0x52d3a3(0x176)],'bank':_0x206273[_0x52d3a3(0x141)],'accountNumber':_0x206273[_0x52d3a3(0x1f0)],'iban':_0x206273[_0x52d3a3(0x19d)]};return await this['userModel'][_0x52d3a3(0x194)](_0x1cec54,{'vandarIDDeposit':_0x54a5ff}),_0x54a5ff;}async[a244_0x442796(0x228)](_0x191439){const _0x33920b=a244_0x442796,{skip:_0x3234a4,limit:_0x2b3f1b,sortBy:_0x480f11,sortOrder:_0x3653e3,startDate:_0x3c3d81}=_0x191439,_0x15af21={'role':{'$in':[user_schema_1[_0x33920b(0x1af)][_0x33920b(0x19c)],user_schema_1[_0x33920b(0x1af)][_0x33920b(0x1f8)]]}};if(_0x3c3d81)_0x15af21[_0x33920b(0x1db)]={'$gte':_0x3c3d81};const _0x347cad={};if(_0x480f11)_0x347cad[_0x480f11]=_0x3653e3?0x1:-0x1;const _0x39cc57=await this[_0x33920b(0x140)]['find'](_0x15af21)[_0x33920b(0x173)]({'locale':'en'})[_0x33920b(0x16f)](_0x347cad)[_0x33920b(0x16d)](_0x3234a4)['limit'](_0x2b3f1b)[_0x33920b(0x16a)](_0x33920b(0x193))[_0x33920b(0x1df)](),_0x5e2bf9=await this[_0x33920b(0x140)]['countDocuments'](_0x15af21);return{'count':_0x5e2bf9,'data':_0x39cc57};}async[a244_0x442796(0x205)](_0x1f5d38){const _0x44a798=a244_0x442796,_0x4321e8=await this[_0x44a798(0x140)]['findById'](_0x1f5d38);if(!_0x4321e8)throw new common_1[(_0x44a798(0x18c))](this['i18n']['t'](_0x44a798(0x170)));if([user_schema_1[_0x44a798(0x1af)][_0x44a798(0x19f)],user_schema_1['Role'][_0x44a798(0x17a)]][_0x44a798(0x1a0)](_0x4321e8[_0x44a798(0x1ca)]))throw new common_1['BadRequestException'](this[_0x44a798(0x201)]['t']('errors.user.cannotDeleteUser'));const _0x427c47=await this[_0x44a798(0x13b)](_0x1f5d38);if(_0x427c47)throw new common_1[(_0x44a798(0x182))](this[_0x44a798(0x201)]['t'](_0x44a798(0x22b)));await this[_0x44a798(0x140)]['findByIdAndDelete'](_0x1f5d38),await this[_0x44a798(0x1cc)][_0x44a798(0x180)]({'user':_0x1f5d38});}async['findOrThrowCard'](_0x2f8385){const _0x4be5e3=a244_0x442796,_0x5ef0c6=await this[_0x4be5e3(0x1cc)][_0x4be5e3(0x1b4)](_0x2f8385)[_0x4be5e3(0x1df)]();if(!_0x5ef0c6)throw new common_1[(_0x4be5e3(0x18c))](this[_0x4be5e3(0x201)]['t'](_0x4be5e3(0x214)));return _0x5ef0c6;}async[a244_0x442796(0x196)](_0x2b10f9,_0x149ad0){const _0x508fa0=a244_0x442796,{cardNumber:_0x28225f,birthDate:_0x485643}=_0x149ad0,_0x2d396e=await this[_0x508fa0(0x140)][_0x508fa0(0x1b4)](_0x2b10f9);if(!_0x2d396e)throw new common_1[(_0x508fa0(0x18c))](this['i18n']['t'](_0x508fa0(0x170)));const {onlineFirstStepUserVerifyEnabled:_0x48373a}=await this[_0x508fa0(0x1a4)][_0x508fa0(0x1d9)]();if(_0x48373a&&_0x2d396e[_0x508fa0(0x21b)]===user_schema_1[_0x508fa0(0x143)][_0x508fa0(0x216)])throw new common_1['BadRequestException'](this['i18n']['t'](_0x508fa0(0x158)));const _0x93cf6f=_0x485643||_0x2d396e[_0x508fa0(0x14b)];if(!_0x93cf6f)throw new common_1[(_0x508fa0(0x182))](this[_0x508fa0(0x201)]['t'](_0x508fa0(0x15c)));const _0x32e24d=await this[_0x508fa0(0x1cc)]['findOne']({'number':_0x28225f});if(_0x32e24d)throw new common_1[(_0x508fa0(0x182))](this['i18n']['t'](_0x508fa0(0x1cf)));await this[_0x508fa0(0x1f4)][_0x508fa0(0x236)](_0x28225f,_0x2d396e['nationalCode'],_0x93cf6f);const {bank:_0x13edf4,cardStatus:_0x5313c5,cardType:_0x5062ef,depositNumber:_0x42cec1,iban:_0x3052d2,owners:_0x30fe4f}=await this[_0x508fa0(0x1f4)]['getIbanInfo'](_0x28225f);let _0xed765c;try{_0xed765c=await this[_0x508fa0(0x230)]['startSession'](),_0xed765c[_0x508fa0(0x15f)]();const _0x3d5791=await this[_0x508fa0(0x1cc)][_0x508fa0(0x1b0)]([{'user':_0x2b10f9,'number':_0x28225f,'iban':_0x3052d2,'bank':_0x13edf4,'cardType':_0x5062ef,'depositNumber':_0x42cec1,'cardStatus':_0x5313c5,'owners':_0x30fe4f,'status':card_schema_1['CardStatus'][_0x508fa0(0x195)]}],{'session':_0xed765c});return!_0x2d396e[_0x508fa0(0x14b)]&&(_0x2d396e[_0x508fa0(0x14b)]=_0x93cf6f,await _0x2d396e[_0x508fa0(0x1fd)]({'session':_0xed765c})),await _0xed765c['commitTransaction'](),_0x3d5791[0x0];}catch(_0x488f36){if(_0xed765c===null||_0xed765c===void 0x0?void 0x0:_0xed765c[_0x508fa0(0x22f)]())await _0xed765c[_0x508fa0(0x18a)]();if(_0x488f36[_0x508fa0(0x176)]==0x2af8)throw new common_1[(_0x508fa0(0x1e4))](this[_0x508fa0(0x201)]['t'](_0x508fa0(0x177),{'args':{'field':JSON[_0x508fa0(0x159)](_0x488f36['keyValue'])}}));this['logger'][_0x508fa0(0x23b)](_0x508fa0(0x213)+_0x488f36);throw new common_1['InternalServerErrorException']();}finally{if(_0xed765c)await _0xed765c[_0x508fa0(0x1f7)]();}}async[a244_0x442796(0x14f)](_0x249824,_0x2da61a){const _0x3a3032=a244_0x442796,{cardNumber:_0x291ede,iban:_0x4b0b5c}=_0x2da61a;await this[_0x3a3032(0x21a)](_0x249824);const _0x584a47=await this[_0x3a3032(0x1cc)][_0x3a3032(0x1e3)]({'number':_0x291ede});if(_0x584a47)throw new common_1[(_0x3a3032(0x182))](this[_0x3a3032(0x201)]['t']('errors.user.cardAlreadyRegistered'));let _0x159244;try{return _0x159244=await this['cardModel'][_0x3a3032(0x1b0)]({'user':_0x249824,'number':_0x291ede,'iban':_0x4b0b5c,'status':card_schema_1['CardStatus'][_0x3a3032(0x1c7)]}),_0x159244;}catch(_0x3aee01){if(_0x159244){if(_0x3aee01[_0x3a3032(0x176)]==0x2af8)throw new common_1['ConflictException'](this['i18n']['t'](_0x3a3032(0x177),{'args':{'field':JSON[_0x3a3032(0x159)](_0x3aee01[_0x3a3032(0x1e0)])}}));}this['logger'][_0x3a3032(0x23b)](_0x3a3032(0x181)+_0x3aee01);throw new common_1[(_0x3a3032(0x235))]();}}async[a244_0x442796(0x1c2)](_0xf30c16,_0x146b1c){const _0x2472b2=a244_0x442796,{status:_0xaccd6a,confirmDescription:_0x4f93f7}=_0x146b1c,_0x159ec4=await this[_0x2472b2(0x1cc)][_0x2472b2(0x194)]({'_id':_0xf30c16},{'status':_0xaccd6a,'confirmDescription':_0x4f93f7},{'new':!![]});if(!_0x159ec4)throw new common_1[(_0x2472b2(0x18c))](this[_0x2472b2(0x201)]['t'](_0x2472b2(0x214)));return _0x159ec4;}async[a244_0x442796(0x187)](_0x4d9f1b,_0x1ae07c){const _0x257d58=a244_0x442796,{skip:_0x57d82e,limit:_0x39c694,sortBy:_0x439512,sortOrder:_0x54b4c1,id:_0x482a05,userId:_0x41e3ec,status:_0x176d50,search:_0x590728}=_0x1ae07c,_0x4fe507={},_0x3fb095={};if(_0x482a05)_0x3fb095[_0x257d58(0x1eb)]=new mongoose_2[(_0x257d58(0x15a))]['ObjectId'](_0x482a05);const _0x2dff1e=await this[_0x257d58(0x1b4)](_0x4d9f1b);[user_schema_1[_0x257d58(0x1af)][_0x257d58(0x19c)],user_schema_1[_0x257d58(0x1af)]['VIPUser']][_0x257d58(0x1a0)](_0x2dff1e[_0x257d58(0x1ca)])?_0x3fb095[_0x257d58(0x190)]=new mongoose_2[(_0x257d58(0x15a))][(_0x257d58(0x18d))](_0x2dff1e[_0x257d58(0x1eb)]):(_0x41e3ec&&(await this[_0x257d58(0x21a)](_0x41e3ec),_0x3fb095['user._id']=new mongoose_2[(_0x257d58(0x15a))][(_0x257d58(0x18d))](_0x41e3ec)),_0x590728&&(_0x3fb095[_0x257d58(0x19e)]=[{'user.mobileNumber':RegExp(_0x590728,'i')},{'user.firstName':RegExp(_0x590728,'i')},{'user.lastName':RegExp(_0x590728,'i')}]));if(_0x176d50)_0x3fb095[_0x257d58(0x1c0)]=_0x176d50;_0x439512?_0x4fe507[_0x439512]=_0x54b4c1?0x1:-0x1:_0x4fe507['createdAt']=0x1;const _0x38c31f=await this[_0x257d58(0x1cc)][_0x257d58(0x1f6)]([{'$lookup':{'from':_0x257d58(0x14a),'localField':_0x257d58(0x186),'foreignField':_0x257d58(0x1eb),'as':_0x257d58(0x15d)}},{'$set':{'user._id':{'$first':_0x257d58(0x1e6)},'user.mobileNumber':{'$first':_0x257d58(0x1e1)},'user.firstName':{'$first':_0x257d58(0x1ac)},'user.lastName':{'$first':_0x257d58(0x227)},'user.role':{'$first':_0x257d58(0x234)},'user.sex':{'$first':_0x257d58(0x14d)},'user.verificationStatus':{'$first':_0x257d58(0x1a1)}}},{'$match':_0x3fb095},{'$unset':['userArr']},{'$sort':_0x4fe507},{'$facet':{'data':[{'$skip':_0x57d82e},{'$limit':_0x39c694}],'count':[{'$count':_0x257d58(0x189)}]}},{'$set':{'count':{'$first':'$count.count'}}}]);return{'count':_0x38c31f[0x0]['count'],'data':_0x38c31f[0x0][_0x257d58(0x1bb)]};}async[a244_0x442796(0x1ff)](_0x4c3184,_0x40921e){const _0x1c415a=a244_0x442796,_0xbe57c9=await this[_0x1c415a(0x1b4)](_0x4c3184),_0x5d4b27=await this[_0x1c415a(0x1cc)]['findById'](_0x40921e);if(!_0x5d4b27)throw new common_1[(_0x1c415a(0x18c))](this[_0x1c415a(0x201)]['t']('errors.card.notFound'));if(_0xbe57c9[_0x1c415a(0x1eb)]!=String(_0x5d4b27[_0x1c415a(0x186)]))throw new common_1[(_0x1c415a(0x1dd))]();return _0x5d4b27[_0x1c415a(0x1c0)]=card_schema_1[_0x1c415a(0x1b8)][_0x1c415a(0x1d4)],await _0x5d4b27[_0x1c415a(0x1fd)](),_0x5d4b27;}async[a244_0x442796(0x217)](_0x30de75){const _0x1f8c40=a244_0x442796,_0x4362d6=await this['cardModel'][_0x1f8c40(0x188)]({'user':_0x30de75,'status':card_schema_1[_0x1f8c40(0x1b8)][_0x1f8c40(0x195)]})[_0x1f8c40(0x1df)]();return _0x4362d6;}async[a244_0x442796(0x156)](_0xc8ec70){const _0x138613=a244_0x442796,_0x585800=await this[_0x138613(0x1cc)][_0x138613(0x188)]({'user':_0xc8ec70,'status':card_schema_1[_0x138613(0x1b8)][_0x138613(0x195)]})[_0x138613(0x1df)](),_0x2e4744=[];for(const _0x49f9d6 of _0x585800){_0x2e4744[_0x138613(0x184)](_0x49f9d6['number']);}return _0x2e4744;}async[a244_0x442796(0x13b)](_0x4a5278){const _0x402b69=a244_0x442796,_0x4f02bf=await this[_0x402b69(0x1ee)]['find']({'user':_0x4a5278})['sort']({'createdAt':-0x1})[_0x402b69(0x1f1)](0x1)['lean']();return _0x4f02bf[0x0];}async[a244_0x442796(0x212)](_0x48e65f,_0x18353e,_0x136e04,_0xd1ed35,_0x102b60=undefined){const _0x574e67=a244_0x442796;await this[_0x574e67(0x140)]['updateOne']({'_id':_0x48e65f},{'$inc':{'tomanBalance':_0x18353e}},{'session':_0xd1ed35});let _0x3bc94a;const _0x1d705c=await this['findUserLastBalanceLog'](_0x48e65f);if(_0x1d705c)_0x3bc94a=_0x1d705c[_0x574e67(0x15b)]+_0x18353e;else _0x3bc94a=(await this[_0x574e67(0x21a)](_0x48e65f))['tomanBalance']+_0x18353e;await this[_0x574e67(0x1ee)][_0x574e67(0x1b0)]([{'user':_0x48e65f,'action':_0x136e04,'change':_0x18353e,'balance':_0x3bc94a,'description':_0x102b60}],{'session':_0xd1ed35});}async[a244_0x442796(0x20b)](_0x3a2409,_0x59a676,_0x5abe13,_0xaf50a1,_0x3391fc=undefined){const _0x44c05d=a244_0x442796,_0x5b1e26=await this[_0x44c05d(0x140)]['findById'](_0x3a2409);if(_0x59a676>_0x5b1e26[_0x44c05d(0x1ba)]){const _0xd12832=_0x59a676-_0x5b1e26[_0x44c05d(0x1ba)];(0x0,utils_1[_0x44c05d(0x167)])(_0xd12832,this[_0x44c05d(0x201)]);}return this[_0x44c05d(0x212)](_0x3a2409,-_0x59a676,_0x5abe13,_0xaf50a1,_0x3391fc);}async[a244_0x442796(0x16b)](_0x63c8c4,_0x561a9c){const _0x2282f4=a244_0x442796,{changeAmount:_0x51de50,description:_0x2ecbf1}=_0x561a9c;if(_0x51de50===0x0)return;let _0x515c6e;try{_0x515c6e=await this[_0x2282f4(0x230)][_0x2282f4(0x219)](),_0x515c6e[_0x2282f4(0x15f)]();if(_0x51de50>0x0)await this[_0x2282f4(0x212)](_0x63c8c4,_0x51de50,balance_log_schema_1[_0x2282f4(0x1d5)]['ChangeByAdmin'],_0x515c6e,_0x2ecbf1);else await this['decreaseBalance'](_0x63c8c4,Math[_0x2282f4(0x1bf)](_0x51de50),balance_log_schema_1[_0x2282f4(0x1d5)][_0x2282f4(0x17e)],_0x515c6e,_0x2ecbf1);await _0x515c6e[_0x2282f4(0x202)]();}catch(_0x4daeb3){if(_0x515c6e===null||_0x515c6e===void 0x0?void 0x0:_0x515c6e['inTransaction']())await _0x515c6e[_0x2282f4(0x18a)]();if(_0x4daeb3[_0x2282f4(0x1c0)]>=0x190&&_0x4daeb3[_0x2282f4(0x1c0)]<0x1f4)throw _0x4daeb3;this['logger']['error']('Error\x20in\x20changeBalance:\x20'+_0x4daeb3);throw new common_1['InternalServerErrorException']();}finally{if(_0x515c6e)await _0x515c6e['endSession']();}}async[a244_0x442796(0x13d)](_0x162ee7,_0x29cae6){const _0x59d961=a244_0x442796,{skip:_0x5e95c2,limit:_0x391352}=_0x162ee7,_0xeac1cb={'user':_0x29cae6},_0x1e3714=await this[_0x59d961(0x1ee)][_0x59d961(0x188)](_0xeac1cb)[_0x59d961(0x173)]({'locale':'en'})[_0x59d961(0x16f)]({'createdAt':-0x1})[_0x59d961(0x16d)](_0x5e95c2)[_0x59d961(0x1f1)](_0x391352)[_0x59d961(0x1df)](),_0x3392bf=await this[_0x59d961(0x1ee)]['countDocuments'](_0xeac1cb);return{'count':_0x3392bf,'data':_0x1e3714};}};function a244_0xeeee(_0x548530,_0x11385b){const _0x1f6f41=a244_0x1f6f();return a244_0xeeee=function(_0xeeee10,_0x4c8768){_0xeeee10=_0xeeee10-0x13b;let _0x8a4132=_0x1f6f41[_0xeeee10];return _0x8a4132;},a244_0xeeee(_0x548530,_0x11385b);}exports['UserService']=UserService,__decorate([(0x0,schedule_1['Cron'])(schedule_1[a244_0x442796(0x22c)][a244_0x442796(0x1d0)]),__metadata(a244_0x442796(0x153),Function),__metadata(a244_0x442796(0x1c6),[]),__metadata(a244_0x442796(0x1fc),Promise)],UserService['prototype'],'registerUsersIbanInVandar',null),__decorate([(0x0,schedule_1[a244_0x442796(0x13f)])(schedule_1[a244_0x442796(0x22c)][a244_0x442796(0x1d0)]),__metadata(a244_0x442796(0x153),Function),__metadata(a244_0x442796(0x1c6),[]),__metadata(a244_0x442796(0x1fc),Promise)],UserService[a244_0x442796(0x237)],'registerUsersInVandar',null),exports[a244_0x442796(0x223)]=UserService=UserService_1=__decorate([(0x0,common_1[a244_0x442796(0x211)])(),__param(0x0,(0x0,mongoose_1[a244_0x442796(0x162)])(user_schema_1[a244_0x442796(0x19c)][a244_0x442796(0x1da)])),__param(0x1,(0x0,mongoose_1['InjectModel'])(card_schema_1[a244_0x442796(0x1f3)]['name'])),__param(0x2,(0x0,mongoose_1[a244_0x442796(0x162)])(balance_log_schema_1['BalanceLog'][a244_0x442796(0x1da)])),__param(0x5,(0x0,common_1[a244_0x442796(0x21e)])((0x0,common_1['forwardRef'])(()=>level_service_1[a244_0x442796(0x155)]))),__param(0x8,(0x0,mongoose_1[a244_0x442796(0x154)])()),__metadata('design:paramtypes',[mongoose_2['Model'],mongoose_2[a244_0x442796(0x20c)],mongoose_2[a244_0x442796(0x20c)],nestjs_i18n_1[a244_0x442796(0x21d)],external_apis_service_1[a244_0x442796(0x1fa)],level_service_1['LevelService'],settings_service_1[a244_0x442796(0x1b1)],config_1[a244_0x442796(0x242)],mongoose_2[a244_0x442796(0x18f)]])],UserService);