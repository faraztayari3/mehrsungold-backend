'use strict';const a194_0x47e18b=a194_0x3419;(function(_0x93e119,_0xea492b){const _0x2e9b97=a194_0x3419,_0x4c2502=_0x93e119();while(!![]){try{const _0x470059=parseInt(_0x2e9b97(0x17e))/0x1*(parseInt(_0x2e9b97(0x180))/0x2)+-parseInt(_0x2e9b97(0xbf))/0x3*(parseInt(_0x2e9b97(0x146))/0x4)+-parseInt(_0x2e9b97(0x150))/0x5+-parseInt(_0x2e9b97(0xe4))/0x6*(-parseInt(_0x2e9b97(0x100))/0x7)+-parseInt(_0x2e9b97(0x16b))/0x8*(parseInt(_0x2e9b97(0xfd))/0x9)+parseInt(_0x2e9b97(0x184))/0xa+parseInt(_0x2e9b97(0x104))/0xb;if(_0x470059===_0xea492b)break;else _0x4c2502['push'](_0x4c2502['shift']());}catch(_0x2d1467){_0x4c2502['push'](_0x4c2502['shift']());}}}(a194_0x5eea,0xd5754));var __decorate=this&&this[a194_0x47e18b(0x137)]||function(_0x251439,_0x3ccc71,_0x370033,_0x5696cf){const _0xaf70d1=a194_0x47e18b;var _0x12f2bf=arguments[_0xaf70d1(0xed)],_0x21d2a7=_0x12f2bf<0x3?_0x3ccc71:_0x5696cf===null?_0x5696cf=Object[_0xaf70d1(0xd7)](_0x3ccc71,_0x370033):_0x5696cf,_0x33e961;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0xaf70d1(0xde))_0x21d2a7=Reflect[_0xaf70d1(0xf9)](_0x251439,_0x3ccc71,_0x370033,_0x5696cf);else{for(var _0x1584b2=_0x251439[_0xaf70d1(0xed)]-0x1;_0x1584b2>=0x0;_0x1584b2--)if(_0x33e961=_0x251439[_0x1584b2])_0x21d2a7=(_0x12f2bf<0x3?_0x33e961(_0x21d2a7):_0x12f2bf>0x3?_0x33e961(_0x3ccc71,_0x370033,_0x21d2a7):_0x33e961(_0x3ccc71,_0x370033))||_0x21d2a7;}return _0x12f2bf>0x3&&_0x21d2a7&&Object[_0xaf70d1(0x122)](_0x3ccc71,_0x370033,_0x21d2a7),_0x21d2a7;},__metadata=this&&this[a194_0x47e18b(0x11e)]||function(_0x2efc76,_0x423b3c){const _0x61b9f5=a194_0x47e18b;if(typeof Reflect==='object'&&typeof Reflect[_0x61b9f5(0x107)]==='function')return Reflect['metadata'](_0x2efc76,_0x423b3c);},__param=this&&this[a194_0x47e18b(0xf6)]||function(_0x4930e4,_0x72f698){return function(_0xd5a72d,_0x10c04f){_0x72f698(_0xd5a72d,_0x10c04f,_0x4930e4);};},TradeableService_1;Object['defineProperty'](exports,a194_0x47e18b(0x11b),{'value':!![]}),exports[a194_0x47e18b(0xdc)]=void 0x0;const common_1=require(a194_0x47e18b(0x11f)),config_1=require(a194_0x47e18b(0xfc)),mongoose_1=require(a194_0x47e18b(0x13b)),schedule_1=require(a194_0x47e18b(0x171)),cron_1=require('cron'),mongoose_2=require('mongoose'),nestjs_i18n_1=require(a194_0x47e18b(0xc3)),status_enum_1=require(a194_0x47e18b(0xf4)),utils_1=require(a194_0x47e18b(0x144)),external_apis_service_1=require(a194_0x47e18b(0x16c)),settings_service_1=require('../settings/settings.service'),user_schema_1=require(a194_0x47e18b(0xe5)),user_service_1=require(a194_0x47e18b(0x10f)),tradeable_schema_1=require(a194_0x47e18b(0xd5)),transfer_schema_1=require('./schema/transfer.schema'),user_inventory_schema_1=require(a194_0x47e18b(0xc0)),zarbaha_price_getter_1=require(a194_0x47e18b(0x14e));function a194_0x3419(_0x1d4562,_0x3c80ff){const _0x5eea6f=a194_0x5eea();return a194_0x3419=function(_0x3419e5,_0x200540){_0x3419e5=_0x3419e5-0xba;let _0x4f7f0c=_0x5eea6f[_0x3419e5];return _0x4f7f0c;},a194_0x3419(_0x1d4562,_0x3c80ff);}function a194_0x5eea(){const _0x14b061=['incUserInv','errors.user.notFound','__esModule','externalApisService','mobileNumber','__metadata','@nestjs/common','firstName\x20lastName\x20mobileNumber','relatedTransactions','defineProperty','$receiverUserArr.lastName','updatePrices','user','countDocuments','ExternalApisService','$or','setMinutes','design:returntype','publicFindAll','verificationCodeExpiry','price','findByIdAndUpdate','UserService','createUpdatePricesCronJob','$userArr.lastName','name','status','TRADEABLE_PRICE_UPDATE_INTERVAL_SECONDS','save','message','__decorate','userService','errors.tradeable.badPriceApi','forwardRef','@nestjs/mongoose','SchedulerRegistry','Types','tradeableModel','errors.transfer.wrongCode','errors.tradeable.notFound','$tradeableArr._id','number','sendLookupSms','../common/utils','findOneAndUpdate','8Lleczf','error','$senderUserArr.firstName','SuperAdmin','در\x20گرفتن\x20قیمت\x20ها\x20از\x20سرور\x20خارجی\x20مشکلی\x20به\x20وجود\x20آمده\x20است.','BadRequestException','updateUserInv','ObjectId','./zarbaha-price-getter','getUserInventories','1595440awreEx','Injectable','$receiverUserArr.mobileNumber','InternalServerErrorException','findById','commitTransaction','startTransaction','ConfigService','CronJob','transferModel','Status','tradeables','$receiverUserArr._id','ZarbahaPriceGetter','UserInventory','Error\x20in\x20getting\x20tradeable\x20price:\x20','I18nService','errors.tradeable.uniqueField','getUsersByRole','errors.tradeable.cantDelete','data','apiError','connection','errors.transfer.moreThanMaxDecimalPlaces','userArr','Inject','toToman','24sgJTPz','../external-apis/external-apis.service','findOrThrow','create','settings','products','@nestjs/schedule','errors.transfer.expiredCode','includes','count','decTradeableStock','endSession','userInventoryModel','$receiverUserArr.firstName','senderUser._id','aggregate','getPrice','senderUser','incTradeableStock','3761dEfgnQ','Rejected','674XHGJLw','lean','i18n','$tradeable','13498360fPqfTd','getTotalUserInventories','senderUserArr','$count.count','errors.tradeable.outOfStock','Accepted','2066829boERAp','./schema/user-inventory.schema','sendSimpleSms','$tradeableArr.name','nestjs-i18n','onModuleInit','NotFoundException','getPriceFromApi','keyValue','deleteOne','getOneUserInventory','update','prototype','tradeableArr','receiverUserArr','EVERY_HOUR','logger','users','$userArr._id','updatePendingTransfers','select','_id','./schema/tradeable.schema','tradeable','getOwnPropertyDescriptor','$userArr.firstName','generateRandomNumber','-verificationCode\x20-verificationCodeExpiry','CronExpression','TradeableService','$tradeableArr.image','function','\x0a\x20\x20\x20\x20\x20\x20\x20\x20name\x0a\x20\x20\x20\x20\x20\x20\x20\x20nameFa\x0a\x20\x20\x20\x20\x20\x20\x20\x20image\x0a\x20\x20\x20\x20\x20\x20\x20\x20minBuyAmount\x0a\x20\x20\x20\x20\x20\x20\x20\x20buyMaxDecimals\x0a\x20\x20\x20\x20\x20\x20\x20\x20minSellAmount\x0a\x20\x20\x20\x20\x20\x20\x20\x20sellMaxDecimals\x0a\x20\x20\x20\x20\x20\x20\x20\x20price\x0a\x20\x20\x20\x20\x20\x20\x20\x20referrerRewardPercent\x0a\x20\x20\x20\x20\x20\x20\x20\x20transferMaxDecimals\x0a\x20\x20\x20\x20\x20\x20\x20\x20chartLink','Role','findOne','Error\x20in\x20updating\x20user\x20inventory:\x20','موجودی\x20','704454XheXnu','../user/schema/user.schema','$balance','findByReferralCode','0\x20*/','Model','$senderUserArr.mobileNumber','$senderUserArr.lastName','user._id','length','SettingsService','zarbahaPriceGetter','$userArr.sex','\x20است.','\x20*\x20*\x20*\x20*','Logger','../common/status.enum','Connection','__param','findOrThrowTransfer','start','decorate','$userArr.role','settingsService','@nestjs/config','2462418OtbZdD','$$REMOVE','VIPUser','7vCxlrx','getUserInv','log','Error\x20in\x20creating\x20tradeable:\x20','7231422ipTbgG','$tradeableArr.nameFa','schedulerRegistry','metadata','$senderUserArr._id','stringify','ConflictException','verificationCode','errors.transfer.cantChangeStatus','\x20*\x20*\x20*\x20*\x20*','Tradeable','../user/user.service','get','The\x20prices\x20of\x20the\x20tradeables\x20have\x20been\x20updated.','code','find','addCronJob','Pending','decUserInv','InjectModel','errors.tradeable.notEnoughUserInventory'];a194_0x5eea=function(){return _0x14b061;};return a194_0x5eea();}let TradeableService=TradeableService_1=class TradeableService{constructor(_0x2e6dd1,_0x467bf8,_0x1ea906,_0x549104,_0x86a598,_0x53a469,_0x1752dd,_0x4f37ec,_0x2cda6e,_0x2591b8,_0x274b71){const _0x2c4584=a194_0x47e18b;this[_0x2c4584(0x13e)]=_0x2e6dd1,this['userInventoryModel']=_0x467bf8,this[_0x2c4584(0x159)]=_0x1ea906,this[_0x2c4584(0x182)]=_0x549104,this[_0x2c4584(0x11c)]=_0x86a598,this['settingsService']=_0x53a469,this[_0x2c4584(0xef)]=_0x1752dd,this[_0x2c4584(0x138)]=_0x4f37ec,this[_0x2c4584(0x166)]=_0x2cda6e,this['configService']=_0x2591b8,this[_0x2c4584(0x106)]=_0x274b71,this[_0x2c4584(0xcf)]=new common_1[(_0x2c4584(0xf3))](TradeableService_1['name']);}async[a194_0x47e18b(0xc4)](){const _0x671a88=a194_0x47e18b;this[_0x671a88(0x124)](),this['updatePendingTransfers'](),this[_0x671a88(0x130)]();}['createUpdatePricesCronJob'](){const _0x57ab96=a194_0x47e18b,_0x5017e7=this['configService'][_0x57ab96(0x110)](_0x57ab96(0x134));let _0x190407='*/'+_0x5017e7+_0x57ab96(0x10d);if(_0x5017e7>=0x3c)_0x190407=_0x57ab96(0xe8)+_0x5017e7/0x3c+_0x57ab96(0xf2);const _0x474f3d=new cron_1[(_0x57ab96(0x158))](_0x190407,()=>{const _0x125485=_0x57ab96;this[_0x125485(0x124)]();});this[_0x57ab96(0x106)][_0x57ab96(0x114)](_0x57ab96(0x124),_0x474f3d),_0x474f3d[_0x57ab96(0xf8)]();}async[a194_0x47e18b(0x124)](){const _0x2e3816=a194_0x47e18b,_0x4af8ef=await this['tradeableModel'][_0x2e3816(0x113)]({'$or':[{'onlinePriceUpdate':!![]},{'enableZarbahaApi':!![]}]});for(const _0x5ccc41 of _0x4af8ef){const {priceApi:_0x51ee2f,pricePathInApi:_0x3cc947,priceApiMethod:_0x103dec,priceApiHeaders:_0x1edc33,enableZarbahaApi:_0x70118c}=_0x5ccc41;let _0x4dd257;try{if(_0x70118c)_0x4dd257=await this[_0x2e3816(0xef)][_0x2e3816(0x17b)](_0x3cc947);else _0x4dd257=await(0x0,utils_1[_0x2e3816(0xc6)])(_0x51ee2f,_0x3cc947,_0x103dec,_0x1edc33);_0x5ccc41['price']=_0x4dd257;if(!_0x5ccc41['isToman'])_0x5ccc41[_0x2e3816(0x12d)]=(0x0,utils_1[_0x2e3816(0x16a)])(_0x4dd257);_0x5ccc41['apiError']='',await _0x5ccc41[_0x2e3816(0x135)]();}catch(_0x3199e4){this[_0x2e3816(0xcf)][_0x2e3816(0x147)](_0x2e3816(0x15f)+_0x3199e4['message']),_0x5ccc41[_0x2e3816(0x165)]=_0x3199e4[_0x2e3816(0x136)],await _0x5ccc41[_0x2e3816(0x135)]();const _0x1f651a=(await this[_0x2e3816(0x138)][_0x2e3816(0x162)]([user_schema_1['Role']['SuperAdmin']]))[0x0];this[_0x2e3816(0x11c)][_0x2e3816(0xc1)](_0x1f651a[_0x2e3816(0x11d)],_0x2e3816(0x14a));}}this[_0x2e3816(0xcf)][_0x2e3816(0x102)](_0x2e3816(0x111));}async[a194_0x47e18b(0x16d)](_0x485ac2){const _0x2c24e5=a194_0x47e18b,_0x51330a=await this[_0x2c24e5(0x13e)][_0x2c24e5(0x154)](_0x485ac2)[_0x2c24e5(0x181)]();if(!_0x51330a)throw new common_1['NotFoundException'](this[_0x2c24e5(0x182)]['t'](_0x2c24e5(0x140)));return _0x51330a;}async[a194_0x47e18b(0x16e)](_0x4eb9ab){const _0x31c361=a194_0x47e18b,{name:_0x2aeccf,nameFa:_0x541ad,priceApi:_0x4c0d63,pricePathInApi:_0x82e6c5,image:_0x382342,isToman:_0x4c85be,minBuyAmount:_0x19a7a8,minSellAmount:_0x2cb12f,priceApiHeaders:_0xe1490,priceApiMethod:_0x59c49e,onlinePriceUpdate:_0x21a406,ignoreApiError:_0x1eb8f6,stock:_0x33d7a7,stockThreshold:_0x45d47c,buyMaxDecimals:_0x3aaa65,sellMaxDecimals:_0x37950c,referrerRewardPercent:_0x5007ef,transferMaxDecimals:_0x2760d2,chartLink:_0xc9fb87,wallgoldIntegrationIsActive:_0x250b2f,enableZarbahaApi:_0x377067}=_0x4eb9ab;let _0xf61ff5=_0x4eb9ab[_0x31c361(0x12d)];if(_0x21a406)try{_0xf61ff5=await(0x0,utils_1['getPriceFromApi'])(_0x4c0d63,_0x82e6c5,_0x59c49e,_0xe1490);if(!_0x4c85be)_0xf61ff5=(0x0,utils_1[_0x31c361(0x16a)])(_0xf61ff5);}catch(_0x522184){this[_0x31c361(0xcf)]['error']('Error\x20in\x20getting\x20price\x20in\x20create\x20tradeable:\x20'+_0x522184);throw new common_1[(_0x31c361(0x14b))](this[_0x31c361(0x182)]['t'](_0x31c361(0x139)));}try{const _0x1c40e9=await this[_0x31c361(0x13e)][_0x31c361(0x16e)]({'name':_0x2aeccf,'nameFa':_0x541ad,'priceApi':_0x4c0d63,'pricePathInApi':_0x82e6c5,'isToman':_0x4c85be,'price':_0xf61ff5,'image':_0x382342,'minBuyAmount':_0x19a7a8,'buyMaxDecimals':_0x3aaa65,'minSellAmount':_0x2cb12f,'sellMaxDecimals':_0x37950c,'referrerRewardPercent':_0x5007ef,'priceApiMethod':_0x59c49e,'priceApiHeaders':_0xe1490,'onlinePriceUpdate':_0x21a406,'ignoreApiError':_0x1eb8f6,'stock':_0x33d7a7,'stockThreshold':_0x45d47c,'transferMaxDecimals':_0x2760d2,'chartLink':_0xc9fb87,'wallgoldIntegrationIsActive':_0x250b2f,'enableZarbahaApi':_0x377067});return _0x1c40e9;}catch(_0x3c7d88){if(_0x3c7d88[_0x31c361(0x112)]==0x2af8)throw new common_1[(_0x31c361(0x10a))](this['i18n']['t'](_0x31c361(0x161),{'args':{'field':JSON[_0x31c361(0x109)](_0x3c7d88['keyValue'])}}));this[_0x31c361(0xcf)][_0x31c361(0x147)](_0x31c361(0x103)+JSON[_0x31c361(0x109)](_0x3c7d88,null,0x2));throw new common_1['InternalServerErrorException']();}}async['findAll'](){const _0x849917=a194_0x47e18b,_0x5058b9=await this[_0x849917(0x13e)][_0x849917(0x113)]()[_0x849917(0x181)](),_0x5ccd83=await this['tradeableModel'][_0x849917(0x126)]();return{'count':_0x5ccd83,'data':_0x5058b9};}async[a194_0x47e18b(0x12b)](){const _0x3eacda=a194_0x47e18b,_0x55a4f8=await this[_0x3eacda(0x13e)][_0x3eacda(0x113)]()[_0x3eacda(0xd3)](_0x3eacda(0xdf))[_0x3eacda(0x181)](),_0x109fb3=await this[_0x3eacda(0x13e)]['countDocuments']();return{'count':_0x109fb3,'data':_0x55a4f8};}async[a194_0x47e18b(0xca)](_0x5b7078,_0x46ebef){const _0x55271a=a194_0x47e18b,{name:_0x3047a9,nameFa:_0x55c532,priceApi:_0x2ad93d,pricePathInApi:_0x5977be,image:_0x2e6ade,isToman:_0x3ce66e,minBuyAmount:_0x3ba003,minSellAmount:_0x1ecccc,price:_0x4c15d4,priceApiHeaders:_0x1b1fab,priceApiMethod:_0x2ec85c,onlinePriceUpdate:_0x1e6d04,ignoreApiError:_0x27e1ff,stock:_0x4f5154,stockThreshold:_0x1d2071,buyMaxDecimals:_0x5d19fd,sellMaxDecimals:_0x1fc4ac,referrerRewardPercent:_0x50295b,transferMaxDecimals:_0x441a9f,chartLink:_0x3a296b,wallgoldIntegrationIsActive:_0x1898b3,enableZarbahaApi:_0x150df2}=_0x46ebef;let _0xeff264;try{_0xeff264=await this[_0x55271a(0x13e)][_0x55271a(0x12e)](_0x5b7078,{'name':_0x3047a9,'nameFa':_0x55c532,'priceApi':_0x2ad93d,'pricePathInApi':_0x5977be,'isToman':_0x3ce66e,'price':_0x4c15d4,'image':_0x2e6ade,'minBuyAmount':_0x3ba003,'buyMaxDecimals':_0x5d19fd,'minSellAmount':_0x1ecccc,'sellMaxDecimals':_0x1fc4ac,'referrerRewardPercent':_0x50295b,'priceApiHeaders':_0x1b1fab,'priceApiMethod':_0x2ec85c,'onlinePriceUpdate':_0x1e6d04,'ignoreApiError':_0x27e1ff,'stock':_0x4f5154,'stockThreshold':_0x1d2071,'transferMaxDecimals':_0x441a9f,'chartLink':_0x3a296b,'wallgoldIntegrationIsActive':_0x1898b3,'enableZarbahaApi':_0x150df2},{'new':!![]})['lean']();}catch(_0x106d25){if(_0x106d25['code']==0x2af8)throw new common_1[(_0x55271a(0x10a))](this[_0x55271a(0x182)]['t'](_0x55271a(0x161),{'args':{'field':JSON['stringify'](_0x106d25[_0x55271a(0xc7)])}}));}if(!_0xeff264)throw new common_1[(_0x55271a(0xc5))](this[_0x55271a(0x182)]['t'](_0x55271a(0x140)));return void this[_0x55271a(0x124)](),_0xeff264;}async['delete'](_0x420a33){const _0x34bf48=a194_0x47e18b;await this['findOrThrow'](_0x420a33);const _0x532065=await this[_0x34bf48(0x13e)][_0x34bf48(0x17a)]([{'$match':{'_id':new mongoose_2[(_0x34bf48(0x13d))][(_0x34bf48(0x14d))](_0x420a33)}},{'$lookup':{'from':'transactions','localField':_0x34bf48(0xd4),'foreignField':'tradeable','pipeline':[{'$limit':0x1}],'as':_0x34bf48(0x121)}},{'$lookup':{'from':_0x34bf48(0x170),'localField':_0x34bf48(0xd4),'foreignField':_0x34bf48(0xd6),'pipeline':[{'$limit':0x1}],'as':'relatedProducts'}}]);if(_0x532065[0x0][_0x34bf48(0x121)][_0x34bf48(0xed)]||_0x532065[0x0]['relatedProducts'][_0x34bf48(0xed)])throw new common_1['BadRequestException'](this[_0x34bf48(0x182)]['t'](_0x34bf48(0x163)));await this[_0x34bf48(0x13e)][_0x34bf48(0xc8)]({'_id':_0x420a33});}[a194_0x47e18b(0x17d)](_0x345811,_0x1760a3,_0x55c6ec=undefined){const _0x3fc49e=a194_0x47e18b,_0x210633={};if(_0x55c6ec)_0x210633['session']=_0x55c6ec;return this[_0x3fc49e(0x13e)]['updateOne']({'_id':_0x345811},{'$inc':{'stock':_0x1760a3}},_0x210633);}async[a194_0x47e18b(0x175)](_0x2173b5,_0x3f70cd,_0x4d86da=undefined){const _0x258b93=a194_0x47e18b,{stock:_0x344d84,stockThreshold:_0x2642be,nameFa:_0x8fc997}=await this[_0x258b93(0x13e)][_0x258b93(0x154)](_0x2173b5);if(_0x3f70cd>_0x344d84)throw new common_1[(_0x258b93(0x14b))](this[_0x258b93(0x182)]['t'](_0x258b93(0xbd)));if(_0x344d84-_0x3f70cd<=_0x2642be){const _0x2604d1=(await this['userService'][_0x258b93(0x162)]([user_schema_1[_0x258b93(0xe0)][_0x258b93(0x149)]]))[0x0];this[_0x258b93(0x11c)][_0x258b93(0xc1)](_0x2604d1[_0x258b93(0x11d)],_0x258b93(0xe3)+_0x8fc997+'\x20کمتر\x20از\x20'+_0x2642be+_0x258b93(0xf1));}return this['incTradeableStock'](_0x2173b5,-_0x3f70cd,_0x4d86da);}async[a194_0x47e18b(0x101)](_0x5a994e,_0x3a9af4,_0x377b7c=![]){const _0x546e08=a194_0x47e18b,_0x498ac8=await this['userInventoryModel'][_0x546e08(0xe1)]({'user':_0x5a994e,'tradeable':_0x3a9af4,'blocked':_0x377b7c});return(_0x498ac8===null||_0x498ac8===void 0x0?void 0x0:_0x498ac8['balance'])||0x0;}[a194_0x47e18b(0x119)](_0x4facca,_0x1307e4,_0x1932a6,_0x44b245=![],_0x3a4e4b=undefined){const _0x421388=a194_0x47e18b,_0x1c969b={'upsert':!![]};if(_0x3a4e4b)_0x1c969b['session']=_0x3a4e4b;return this['userInventoryModel'][_0x421388(0x145)]({'user':_0x4facca,'tradeable':_0x1307e4,'blocked':_0x44b245},{'$setOnInsert':{'user':_0x4facca,'tradeable':_0x1307e4,'blocked':_0x44b245},'$inc':{'balance':_0x1932a6}},_0x1c969b);}async[a194_0x47e18b(0x116)](_0x92342f,_0x33fce2,_0x416ece,_0x254e0b=![],_0x39509f=undefined){const _0xb42ad3=a194_0x47e18b,_0x8ce4f6=await this[_0xb42ad3(0x101)](_0x92342f,_0x33fce2,_0x254e0b);if(_0x416ece>_0x8ce4f6)throw new common_1[(_0xb42ad3(0x14b))](this['i18n']['t'](_0xb42ad3(0x118)));return this[_0xb42ad3(0x119)](_0x92342f,_0x33fce2,-_0x416ece,_0x254e0b,_0x39509f);}async[a194_0x47e18b(0xba)](){const _0x305f3b=a194_0x47e18b,_0x77c67c=await this[_0x305f3b(0x177)]['aggregate']([{'$group':{'_id':_0x305f3b(0x183),'total':{'$sum':_0x305f3b(0xe6)}}},{'$lookup':{'from':'tradeables','localField':_0x305f3b(0xd4),'foreignField':_0x305f3b(0xd4),'as':_0x305f3b(0xd6)}},{'$set':{'tradeable':{'$first':_0x305f3b(0x183)},'_id':_0x305f3b(0xfe)}}]);return _0x77c67c;}async[a194_0x47e18b(0xc9)](_0x315db5){const _0x2ce865=a194_0x47e18b,_0x36373e=await this[_0x2ce865(0x177)][_0x2ce865(0x113)]({'user':_0x315db5})['populate']({'path':_0x2ce865(0xd6),'select':{'name':0x1,'nameFa':0x1,'image':0x1}});return{'data':_0x36373e};}async[a194_0x47e18b(0x14f)](_0x5d98f1){const _0x565849=a194_0x47e18b,{limit:_0x590296,skip:_0xbb66a8,sortBy:_0x4f447f,sortOrder:_0x332a0e,userId:_0x1cb65e,tradeableId:_0x608ca1,search:_0x5744d4}=_0x5d98f1,_0x1c1699={};if(_0x1cb65e)_0x1c1699[_0x565849(0xec)]=new mongoose_2[(_0x565849(0x13d))][(_0x565849(0x14d))](_0x1cb65e);if(_0x608ca1)_0x1c1699[_0x565849(0xd6)]=new mongoose_2[(_0x565849(0x13d))]['ObjectId'](_0x608ca1);if(_0x5744d4)_0x1c1699[_0x565849(0x128)]=[{'user.mobileNumber':RegExp(_0x5744d4,'i')},{'user.firstName':RegExp(_0x5744d4,'i')},{'user.lastName':RegExp(_0x5744d4,'i')}];let _0x38abf0;_0x4f447f?_0x38abf0={[_0x4f447f]:_0x332a0e?0x1:-0x1}:_0x38abf0={'createdAt':0x1};const _0x47c97a=await this['userInventoryModel'][_0x565849(0x17a)]([{'$lookup':{'from':_0x565849(0xd0),'localField':_0x565849(0x125),'foreignField':'_id','as':_0x565849(0x168)}},{'$set':{'user._id':{'$first':_0x565849(0xd1)},'user.mobileNumber':{'$first':'$userArr.mobileNumber'},'user.firstName':{'$first':_0x565849(0xd8)},'user.lastName':{'$first':_0x565849(0x131)},'user.role':{'$first':_0x565849(0xfa)},'user.sex':{'$first':_0x565849(0xf0)},'user.verificationStatus':{'$first':'$userArr.verificationStatus'}}},{'$match':_0x1c1699},{'$lookup':{'from':'tradeables','localField':_0x565849(0xd6),'foreignField':'_id','as':_0x565849(0xcc)}},{'$set':{'tradeable._id':{'$first':_0x565849(0x141)},'tradeable.name':{'$first':_0x565849(0xc2)},'tradeable.nameFa':{'$first':'$tradeableArr.nameFa'},'tradeable.image':{'$first':_0x565849(0xdd)}}},{'$unset':[_0x565849(0x168),_0x565849(0xcc)]},{'$sort':_0x38abf0},{'$facet':{'data':[{'$skip':_0xbb66a8},{'$limit':_0x590296}],'count':[{'$count':'count'}]}},{'$set':{'count':{'$first':_0x565849(0xbc)}}}]);return{'count':_0x47c97a[0x0]['count'],'data':_0x47c97a[0x0]['data']};}async[a194_0x47e18b(0x14c)](_0x16e0ea,_0x4fab50){const _0x557a36=a194_0x47e18b,{balance:_0x12289c,tradeableId:_0x37a76c}=_0x4fab50;await this[_0x557a36(0x16d)](_0x37a76c);let _0x3d30c4;try{_0x3d30c4=await this['userInventoryModel'][_0x557a36(0x145)]({'user':_0x16e0ea,'tradeable':_0x37a76c,'blocked':![]},{'balance':_0x12289c},{'new':!![],'upsert':!![]})[_0x557a36(0x181)]();}catch(_0x2d5cf1){this[_0x557a36(0xcf)][_0x557a36(0x147)](_0x557a36(0xe2)+_0x2d5cf1);throw new common_1[(_0x557a36(0x153))]();}return _0x3d30c4;}async['updatePendingTransfers'](){const _0x3acdd0=a194_0x47e18b,_0x431ad0=new Date();await this[_0x3acdd0(0x159)][_0x3acdd0(0x17a)]([{'$match':{'status':status_enum_1[_0x3acdd0(0x15a)]['Pending'],'verificationCodeExpiry':{'$lte':_0x431ad0}}},{'$set':{'status':status_enum_1['Status'][_0x3acdd0(0x17f)]}},{'$merge':{'into':'transfers','on':_0x3acdd0(0xd4),'whenMatched':'merge'}}]),this[_0x3acdd0(0xcf)]['log']('Pending\x20tradeable\x20transfers\x20that\x20did\x20not\x20succeed\x20are\x20rejected.');}async[a194_0x47e18b(0xf7)](_0xbbc9cd){const _0x23defa=a194_0x47e18b,_0x5981b4=await this[_0x23defa(0x159)][_0x23defa(0x154)](_0xbbc9cd)['lean']();if(!_0x5981b4)throw new common_1[(_0x23defa(0xc5))](this['i18n']['t']('errors.transfer.notFound'));return _0x5981b4;}async['createTransfer'](_0x3f38f5,_0x10d7db){const _0x35278b=a194_0x47e18b,{amount:_0x384039,destUserCode:_0x4444b2,tradeableId:_0x14ad12}=_0x10d7db,{transferMaxDecimals:_0x38a768}=await this[_0x35278b(0x16d)](_0x14ad12),_0x24dc1f=await this[_0x35278b(0x138)][_0x35278b(0x16d)](_0x3f38f5),_0x27e7ba=await this[_0x35278b(0x138)][_0x35278b(0xe7)](_0x4444b2);if(!_0x27e7ba)throw new common_1['NotFoundException'](this[_0x35278b(0x182)]['t'](_0x35278b(0x11a)));let _0x599bd7=0x2;if(typeof _0x38a768===_0x35278b(0x142))_0x599bd7=_0x38a768;if(!(0x0,utils_1['isFloatingPointCorrect'])(_0x384039,_0x599bd7))throw new common_1[(_0x35278b(0x14b))](this[_0x35278b(0x182)]['t'](_0x35278b(0x167),{'args':{'value':_0x599bd7}}));const _0x5ed577=await this[_0x35278b(0x101)](_0x3f38f5,_0x14ad12,![]);if(_0x384039>_0x5ed577)throw new common_1[(_0x35278b(0x14b))](this[_0x35278b(0x182)]['t'](_0x35278b(0x118)));try{const _0x54ae0d=(0x0,utils_1[_0x35278b(0xd9)])(0x6),_0x22bcd7=new Date();_0x22bcd7[_0x35278b(0x129)](_0x22bcd7['getMinutes']()+0x2);const _0x1339cc=await this['transferModel']['create']({'tradeable':_0x14ad12,'amount':_0x384039,'senderUser':_0x3f38f5,'receiverUser':_0x27e7ba[_0x35278b(0xd4)],'status':status_enum_1['Status'][_0x35278b(0x115)],'verificationCode':_0x54ae0d,'verificationCodeExpiry':_0x22bcd7}),{kavehnegarTransferTemplate:_0x3c75b2}=await this[_0x35278b(0xfb)][_0x35278b(0x16f)]();await this[_0x35278b(0x11c)][_0x35278b(0x143)](_0x24dc1f[_0x35278b(0x11d)],String(_0x54ae0d),_0x3c75b2);const _0x1f4c81=await this['transferModel']['findById'](_0x1339cc[_0x35278b(0xd4)])[_0x35278b(0xd3)](_0x35278b(0xda))['populate']('receiverUser',_0x35278b(0x120))[_0x35278b(0x181)]();return _0x1f4c81;}catch(_0x169200){this[_0x35278b(0xcf)][_0x35278b(0x147)]('Error\x20in\x20creating\x20transfer:\x20'+_0x169200);throw new common_1[(_0x35278b(0x153))]();}}async['confirmTransfer'](_0x2e18fa,_0x4f54a8){const _0x135ec8=a194_0x47e18b,{code:_0x6f430f}=_0x4f54a8,{status:_0x4a011e,senderUser:_0x1c8886,receiverUser:_0x49d585,tradeable:_0x55ca7f,amount:_0xc54351,verificationCode:_0x147330,verificationCodeExpiry:_0x665238}=await this[_0x135ec8(0xf7)](_0x2e18fa);if(_0x4a011e!==status_enum_1[_0x135ec8(0x15a)][_0x135ec8(0x115)])throw new common_1[(_0x135ec8(0x14b))](this['i18n']['t'](_0x135ec8(0x10c)));let _0x578da0;new Date()>_0x665238&&(_0x578da0=new common_1['BadRequestException'](this[_0x135ec8(0x182)]['t'](_0x135ec8(0x172))));_0x147330!==_0x6f430f&&(_0x578da0=new common_1[(_0x135ec8(0x14b))](this[_0x135ec8(0x182)]['t'](_0x135ec8(0x13f))));if(_0x578da0){await this[_0x135ec8(0x159)][_0x135ec8(0x12e)](_0x2e18fa,{'status':status_enum_1[_0x135ec8(0x15a)][_0x135ec8(0x17f)],'verificationCode':null,'verificationCodeExpiry':null});throw _0x578da0;}let _0x2c10ef;try{_0x2c10ef=await this[_0x135ec8(0x166)]['startSession'](),_0x2c10ef[_0x135ec8(0x156)](),await this[_0x135ec8(0x116)](String(_0x1c8886),String(_0x55ca7f),_0xc54351,![],_0x2c10ef),await this['incUserInv'](String(_0x49d585),String(_0x55ca7f),_0xc54351,![],_0x2c10ef);const _0x145738=await this[_0x135ec8(0x159)][_0x135ec8(0x12e)](_0x2e18fa,{'status':status_enum_1[_0x135ec8(0x15a)][_0x135ec8(0xbe)],'verificationCode':null,'verificationCodeExpiry':null},{'new':!![],'session':_0x2c10ef});return await _0x2c10ef[_0x135ec8(0x155)](),_0x145738;}catch(_0x522308){if(_0x2c10ef===null||_0x2c10ef===void 0x0?void 0x0:_0x2c10ef['inTransaction']())await _0x2c10ef['abortTransaction']();if(_0x522308[_0x135ec8(0x133)]>=0x190&&_0x522308[_0x135ec8(0x133)]<0x1f4)throw _0x522308;this['logger']['error']('Error\x20in\x20confirmTransfer:\x20'+_0x522308);throw new common_1[(_0x135ec8(0x153))]();}finally{if(_0x2c10ef)await _0x2c10ef[_0x135ec8(0x176)]();}}async['getTransfers'](_0x2ad69b,_0x3aa206){const _0x5135ea=a194_0x47e18b,{skip:_0x595f90,limit:_0x3214b3,sortBy:_0x2c5cb3,sortOrder:_0x2dad3a,senderUserId:_0x19becb,search:_0x32a8c2}=_0x3aa206,_0x25a5a2={},_0x3c5c4c={},_0xa4b115=await this[_0x5135ea(0x138)]['findById'](_0x2ad69b);[user_schema_1[_0x5135ea(0xe0)]['User'],user_schema_1[_0x5135ea(0xe0)][_0x5135ea(0xff)]][_0x5135ea(0x173)](_0xa4b115['role'])?_0x25a5a2[_0x5135ea(0x128)]=[{'senderUser._id':new mongoose_2[(_0x5135ea(0x13d))]['ObjectId'](_0xa4b115[_0x5135ea(0xd4)])},{'receiverUser._id':new mongoose_2['Types'][(_0x5135ea(0x14d))](_0xa4b115[_0x5135ea(0xd4)])}]:(_0x19becb&&(await this[_0x5135ea(0x138)]['findOrThrow'](_0x19becb),_0x25a5a2[_0x5135ea(0x179)]=new mongoose_2[(_0x5135ea(0x13d))][(_0x5135ea(0x14d))](_0x19becb)),_0x32a8c2&&(_0x25a5a2[_0x5135ea(0x128)]=[{'senderUserId.mobileNumber':RegExp(_0x32a8c2,'i')},{'senderUserId.firstName':RegExp(_0x32a8c2,'i')},{'senderUserId.lastName':RegExp(_0x32a8c2,'i')},{'receiverUser.mobileNumber':RegExp(_0x32a8c2,'i')},{'receiverUser.firstName':RegExp(_0x32a8c2,'i')},{'receiverUser.lastName':RegExp(_0x32a8c2,'i')}]));if(!_0x2c5cb3)_0x3c5c4c['createdAt']=-0x1;else _0x3c5c4c[_0x2c5cb3]=_0x2dad3a?0x1:-0x1;const _0x4ae5da=await this[_0x5135ea(0x159)][_0x5135ea(0x17a)]([{'$lookup':{'from':_0x5135ea(0xd0),'localField':_0x5135ea(0x17c),'foreignField':_0x5135ea(0xd4),'as':_0x5135ea(0xbb)}},{'$lookup':{'from':_0x5135ea(0xd0),'localField':'receiverUser','foreignField':_0x5135ea(0xd4),'as':_0x5135ea(0xcd)}},{'$lookup':{'from':_0x5135ea(0x15b),'localField':_0x5135ea(0xd6),'foreignField':_0x5135ea(0xd4),'as':'tradeableArr'}},{'$set':{'senderUser._id':{'$first':_0x5135ea(0x108)},'senderUser.mobileNumber':{'$first':_0x5135ea(0xea)},'senderUser.firstName':{'$first':_0x5135ea(0x148)},'senderUser.lastName':{'$first':_0x5135ea(0xeb)},'receiverUser._id':{'$first':_0x5135ea(0x15c)},'receiverUser.mobileNumber':{'$first':_0x5135ea(0x152)},'receiverUser.firstName':{'$first':_0x5135ea(0x178)},'receiverUser.lastName':{'$first':_0x5135ea(0x123)},'tradeable._id':{'$first':'$tradeableArr._id'},'tradeable.name':{'$first':_0x5135ea(0xc2)},'tradeable.nameFa':{'$first':_0x5135ea(0x105)},'tradeable.image':{'$first':_0x5135ea(0xdd)}}},{'$match':_0x25a5a2},{'$unset':[_0x5135ea(0xbb),_0x5135ea(0xcd),_0x5135ea(0xcc),_0x5135ea(0x10b),_0x5135ea(0x12c)]},{'$sort':_0x3c5c4c},{'$facet':{'data':[{'$skip':_0x595f90},{'$limit':_0x3214b3}],'count':[{'$count':'count'}]}},{'$set':{'count':{'$first':_0x5135ea(0xbc)}}}]);return{'count':_0x4ae5da[0x0][_0x5135ea(0x174)],'data':_0x4ae5da[0x0][_0x5135ea(0x164)]};}};exports['TradeableService']=TradeableService,__decorate([(0x0,schedule_1['Cron'])(schedule_1[a194_0x47e18b(0xdb)][a194_0x47e18b(0xce)]),__metadata('design:type',Function),__metadata('design:paramtypes',[]),__metadata(a194_0x47e18b(0x12a),Promise)],TradeableService[a194_0x47e18b(0xcb)],a194_0x47e18b(0xd2),null),exports[a194_0x47e18b(0xdc)]=TradeableService=TradeableService_1=__decorate([(0x0,common_1[a194_0x47e18b(0x151)])(),__param(0x0,(0x0,mongoose_1[a194_0x47e18b(0x117)])(tradeable_schema_1[a194_0x47e18b(0x10e)]['name'])),__param(0x1,(0x0,mongoose_1[a194_0x47e18b(0x117)])(user_inventory_schema_1[a194_0x47e18b(0x15e)]['name'])),__param(0x2,(0x0,mongoose_1[a194_0x47e18b(0x117)])(transfer_schema_1['Transfer'][a194_0x47e18b(0x132)])),__param(0x7,(0x0,common_1[a194_0x47e18b(0x169)])((0x0,common_1[a194_0x47e18b(0x13a)])(()=>user_service_1[a194_0x47e18b(0x12f)]))),__param(0x8,(0x0,mongoose_1['InjectConnection'])()),__metadata('design:paramtypes',[mongoose_2['Model'],mongoose_2[a194_0x47e18b(0xe9)],mongoose_2['Model'],nestjs_i18n_1[a194_0x47e18b(0x160)],external_apis_service_1[a194_0x47e18b(0x127)],settings_service_1[a194_0x47e18b(0xee)],zarbaha_price_getter_1[a194_0x47e18b(0x15d)],user_service_1[a194_0x47e18b(0x12f)],mongoose_2[a194_0x47e18b(0xf5)],config_1[a194_0x47e18b(0x157)],schedule_1[a194_0x47e18b(0x13c)]])],TradeableService);