'use strict';const a97_0x51bad7=a97_0x559c;(function(_0x2cd6bd,_0x1c123b){const _0x17e1ed=a97_0x559c,_0x596aac=_0x2cd6bd();while(!![]){try{const _0x17cd84=parseInt(_0x17e1ed(0x1e0))/0x1+parseInt(_0x17e1ed(0x1c6))/0x2*(-parseInt(_0x17e1ed(0x1e3))/0x3)+parseInt(_0x17e1ed(0x1d6))/0x4+-parseInt(_0x17e1ed(0x198))/0x5*(-parseInt(_0x17e1ed(0x1ac))/0x6)+-parseInt(_0x17e1ed(0x19c))/0x7+-parseInt(_0x17e1ed(0x1ca))/0x8+parseInt(_0x17e1ed(0x19a))/0x9*(-parseInt(_0x17e1ed(0x1b8))/0xa);if(_0x17cd84===_0x1c123b)break;else _0x596aac['push'](_0x596aac['shift']());}catch(_0x48b8d7){_0x596aac['push'](_0x596aac['shift']());}}}(a97_0x1171,0x29aef));var __decorate=this&&this[a97_0x51bad7(0x1db)]||function(_0xe9bba,_0x1704e4,_0x3321e7,_0x5b51f6){const _0x495f21=a97_0x51bad7;var _0x3dad7a=arguments[_0x495f21(0x1a8)],_0x186111=_0x3dad7a<0x3?_0x1704e4:_0x5b51f6===null?_0x5b51f6=Object[_0x495f21(0x19f)](_0x1704e4,_0x3321e7):_0x5b51f6,_0x676176;if(typeof Reflect==='object'&&typeof Reflect[_0x495f21(0x1de)]===_0x495f21(0x1c5))_0x186111=Reflect[_0x495f21(0x1de)](_0xe9bba,_0x1704e4,_0x3321e7,_0x5b51f6);else{for(var _0x3eeceb=_0xe9bba[_0x495f21(0x1a8)]-0x1;_0x3eeceb>=0x0;_0x3eeceb--)if(_0x676176=_0xe9bba[_0x3eeceb])_0x186111=(_0x3dad7a<0x3?_0x676176(_0x186111):_0x3dad7a>0x3?_0x676176(_0x1704e4,_0x3321e7,_0x186111):_0x676176(_0x1704e4,_0x3321e7))||_0x186111;}return _0x3dad7a>0x3&&_0x186111&&Object[_0x495f21(0x1a9)](_0x1704e4,_0x3321e7,_0x186111),_0x186111;},__metadata=this&&this[a97_0x51bad7(0x1bc)]||function(_0x18f82e,_0x55afb9){const _0x3df8b8=a97_0x51bad7;if(typeof Reflect===_0x3df8b8(0x194)&&typeof Reflect['metadata']===_0x3df8b8(0x1c5))return Reflect[_0x3df8b8(0x1a1)](_0x18f82e,_0x55afb9);},__param=this&&this[a97_0x51bad7(0x1ce)]||function(_0x4f19c0,_0x170ee0){return function(_0x4de2b6,_0x3af7c4){_0x170ee0(_0x4de2b6,_0x3af7c4,_0x4f19c0);};},MessageService_1;function a97_0x559c(_0x3aceaf,_0x4e458b){const _0x1171eb=a97_0x1171();return a97_0x559c=function(_0x559c14,_0x4ef5a8){_0x559c14=_0x559c14-0x193;let _0x111b4f=_0x1171eb[_0x559c14];return _0x111b4f;},a97_0x559c(_0x3aceaf,_0x4e458b);}Object[a97_0x51bad7(0x1a9)](exports,a97_0x51bad7(0x1d5),{'value':!![]}),exports[a97_0x51bad7(0x1d0)]=void 0x0;const common_1=require(a97_0x51bad7(0x1b7)),mongoose_1=require(a97_0x51bad7(0x1af)),mongoose_2=require(a97_0x51bad7(0x1bf)),nestjs_i18n_1=require('nestjs-i18n'),external_apis_service_1=require(a97_0x51bad7(0x1dc)),user_schema_1=require('../user/schema/user.schema'),user_service_1=require(a97_0x51bad7(0x1b9)),create_message_dto_1=require(a97_0x51bad7(0x197)),message_schema_1=require(a97_0x51bad7(0x196));let MessageService=MessageService_1=class MessageService{constructor(_0x9b2832,_0x1fef26,_0x358b56,_0x2519d1,_0x4c0d0f){const _0x1c5589=a97_0x51bad7;this['messageModel']=_0x9b2832,this['userModel']=_0x1fef26,this[_0x1c5589(0x1c0)]=_0x358b56,this[_0x1c5589(0x1d7)]=_0x2519d1,this['externalApisService']=_0x4c0d0f,this[_0x1c5589(0x1c3)]=new common_1[(_0x1c5589(0x1d2))](MessageService_1[_0x1c5589(0x1ba)]);}async['findOrThrow'](_0x58c108){const _0x5290f5=a97_0x51bad7,_0x3e934f=await this[_0x5290f5(0x193)]['findById'](_0x58c108)[_0x5290f5(0x1a4)]();if(!_0x3e934f)throw new common_1[(_0x5290f5(0x1da))](this[_0x5290f5(0x1d7)]['t']('errors.message.notFound'));return _0x3e934f;}async[a97_0x51bad7(0x1e1)](_0x5a2746){const _0x3b3ea6=a97_0x51bad7,{receiverId:_0x329a37,subject:_0x1c79d3,text:_0x36c7d4,notifyType:_0x182a58}=_0x5a2746;try{if(_0x329a37){const _0x370b6b=await this[_0x3b3ea6(0x1c0)][_0x3b3ea6(0x1bb)](_0x329a37);await this[_0x3b3ea6(0x193)][_0x3b3ea6(0x1e1)]({'receiver':_0x329a37,'subject':_0x1c79d3,'text':_0x36c7d4,'seen':![]}),_0x182a58&&(_0x182a58===create_message_dto_1[_0x3b3ea6(0x1a6)][_0x3b3ea6(0x1d8)]&&this[_0x3b3ea6(0x1ad)]['sendSimpleSms'](_0x370b6b[_0x3b3ea6(0x1cb)],_0x36c7d4));}else await this[_0x3b3ea6(0x199)][_0x3b3ea6(0x1bd)]([{'$match':{'$or':[{'role':user_schema_1[_0x3b3ea6(0x1e2)][_0x3b3ea6(0x1c2)]},{'role':user_schema_1['Role'][_0x3b3ea6(0x1b4)]}],'isActive':!![]}},{'$project':{'_id':0x0,'receiver':_0x3b3ea6(0x1d3),'subject':{'$literal':_0x1c79d3},'text':{'$literal':_0x36c7d4},'seen':{'$literal':![]},'createdAt':{'$literal':new Date()},'updatedAt':{'$literal':new Date()}}},{'$merge':{'into':_0x3b3ea6(0x195),'whenMatched':'fail','whenNotMatched':_0x3b3ea6(0x1c4)}}]);}catch(_0x4b3f6f){this[_0x3b3ea6(0x1c3)]['error'](_0x3b3ea6(0x1c9)+_0x4b3f6f);throw new common_1[(_0x3b3ea6(0x1cf))]();}}async[a97_0x51bad7(0x1c8)](_0x424be9){const _0x9b6172=a97_0x51bad7,{skip:_0x52a828,limit:_0x59829e,sortBy:_0x4f890e,sortOrder:_0x26f477,receiverId:_0x1b26b4,search:_0x56b56c}=_0x424be9,_0xeb6564={},_0x215fa1={};if(_0x1b26b4)_0xeb6564[_0x9b6172(0x1b1)]=new mongoose_2[(_0x9b6172(0x1ab))]['ObjectId'](_0x1b26b4);_0x56b56c&&(_0xeb6564[_0x9b6172(0x1d9)]=[{'receiver.mobileNumber':RegExp(_0x56b56c,'i')},{'receiver.firstName':RegExp(_0x56b56c,'i')},{'receiver.lastName':RegExp(_0x56b56c,'i')}]);_0x4f890e?_0x215fa1[_0x4f890e]=_0x26f477?0x1:-0x1:_0x215fa1[_0x9b6172(0x1e4)]=0x1;const _0x4bf528=await this['messageModel'][_0x9b6172(0x1bd)]([{'$lookup':{'from':_0x9b6172(0x1aa),'localField':_0x9b6172(0x1ae),'foreignField':_0x9b6172(0x1d1),'as':_0x9b6172(0x1a3)}},{'$set':{'receiver._id':{'$first':_0x9b6172(0x1b6)},'receiver.mobileNumber':{'$first':_0x9b6172(0x1be)},'receiver.firstName':{'$first':_0x9b6172(0x1b2)},'receiver.lastName':{'$first':_0x9b6172(0x1b3)},'receiver.role':{'$first':_0x9b6172(0x1cd)},'receiver.sex':{'$first':_0x9b6172(0x1c7)},'receiver.verificationStatus':{'$first':'$receiverArr.verificationStatus'}}},{'$match':_0xeb6564},{'$unset':[_0x9b6172(0x1a3)]},{'$sort':_0x215fa1},{'$facet':{'data':[{'$skip':_0x52a828},{'$limit':_0x59829e}],'count':[{'$count':'count'}]}},{'$set':{'count':{'$first':_0x9b6172(0x19b)}}}]);return{'count':_0x4bf528[0x0]['count'],'data':_0x4bf528[0x0][_0x9b6172(0x1c1)]};}async[a97_0x51bad7(0x1d4)](_0x2b5ed2,_0x58a136){const _0x23002d=a97_0x51bad7,{skip:_0x3765f1,limit:_0x33d1f5,sortBy:_0x3636db,sortOrder:_0x2e4782,seen:_0x868fa7}=_0x2b5ed2,_0x361e1d={'receiver':_0x58a136};if(_0x868fa7!==undefined&&_0x868fa7!==null)_0x361e1d[_0x23002d(0x1b5)]=_0x868fa7;const _0x57436f={};if(_0x3636db)_0x57436f[_0x3636db]=_0x2e4782?0x1:-0x1;else _0x57436f['createdAt']=-0x1;const _0x16e949=await this['messageModel']['find'](_0x361e1d)[_0x23002d(0x1a2)]({'locale':'en'})[_0x23002d(0x1a0)](_0x57436f)['skip'](_0x3765f1)[_0x23002d(0x1dd)](_0x33d1f5)[_0x23002d(0x1a4)](),_0x50e2b8=await this[_0x23002d(0x193)][_0x23002d(0x1a5)](_0x361e1d);return{'count':_0x50e2b8,'data':_0x16e949};}async['readMessage'](_0x397cd7,_0x5af9e9){const _0x43d320=a97_0x51bad7,_0x31650b=await this[_0x43d320(0x1bb)](_0x397cd7);if(String(_0x31650b[_0x43d320(0x1ae)])!=_0x5af9e9)throw new common_1['NotFoundException'](this[_0x43d320(0x1d7)]['t']('errors.message.notFound'));await this[_0x43d320(0x193)][_0x43d320(0x19d)]({'_id':_0x397cd7},{'seen':!![]});}};exports[a97_0x51bad7(0x1d0)]=MessageService,exports[a97_0x51bad7(0x1d0)]=MessageService=MessageService_1=__decorate([(0x0,common_1[a97_0x51bad7(0x1a7)])(),__param(0x0,(0x0,mongoose_1[a97_0x51bad7(0x1b0)])(message_schema_1['Message'][a97_0x51bad7(0x1ba)])),__param(0x1,(0x0,mongoose_1[a97_0x51bad7(0x1b0)])(user_schema_1[a97_0x51bad7(0x1c2)]['name'])),__metadata(a97_0x51bad7(0x1e5),[mongoose_2[a97_0x51bad7(0x19e)],mongoose_2[a97_0x51bad7(0x19e)],user_service_1['UserService'],nestjs_i18n_1[a97_0x51bad7(0x1cc)],external_apis_service_1[a97_0x51bad7(0x1df)]])],MessageService);function a97_0x1171(){const _0x130148=['design:paramtypes','messageModel','object','messages','./schema/message.schema','./dto/create-message.dto','5785JDMUvZ','userModel','290097rAxQCd','$count.count','1811950sTzgCm','updateOne','Model','getOwnPropertyDescriptor','sort','metadata','collation','receiverArr','lean','countDocuments','NotifyType','Injectable','length','defineProperty','users','Types','1686ripvgO','externalApisService','receiver','@nestjs/mongoose','InjectModel','receiver._id','$receiverArr.firstName','$receiverArr.lastName','VIPUser','seen','$receiverArr._id','@nestjs/common','10RNFrPi','../user/user.service','name','findOrThrow','__metadata','aggregate','$receiverArr.mobileNumber','mongoose','userService','data','User','logger','insert','function','16XcMTJu','$receiverArr.sex','findAll','Error\x20in\x20creating\x20message:\x20','582232AWDSFP','mobileNumber','I18nService','$receiverArr.role','__param','InternalServerErrorException','MessageService','_id','Logger','$_id','getMyMessages','__esModule','812872AWCKNU','i18n','SMS','$or','NotFoundException','__decorate','../external-apis/external-apis.service','limit','decorate','ExternalApisService','256926RRPZCa','create','Role','93999QrpTfs','createdAt'];a97_0x1171=function(){return _0x130148;};return a97_0x1171();}